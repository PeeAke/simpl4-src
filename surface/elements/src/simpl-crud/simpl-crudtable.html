<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-crudtable" extends="simpl-datatables" attributes="rules" flex relative>
	<template>
		<style>
			paper-button.blue-ripple {
				float: left;
				position: relative;
			}
			paper-button {
				font-size: 10px;
			}

		</style>
		<template if="{{dataSet}}">
			<div layout horizontal style="margin-bottom:10px;">
				<paper-button raised class="blue-ripple" on-tap="{{addAction}}" flex>
					<core-icon icon="add"></core-icon>{{'button.new'|tr}}</paper-button>
				<paper-button raised class="blue-ripple" on-tap="{{editAction}}" disabled?="{{currentRowIndex==null}}" flex>
					<core-icon icon="create"></core-icon>{{'button.edit'|tr}}</paper-button>
				<paper-button raised class="blue-ripple" on-tap="{{copyAction}}" disabled?="{{currentRowIndex==null}}" flex>
					<core-icon icon="content-copy"></core-icon>{{'button.copy'|tr}}</paper-button>
				<paper-button raised class="blue-ripple" on-tap="{{detailAction}}" disabled?="{{currentRowIndex==null}}" flex>
					<core-icon icon="view-list"></core-icon>{{'button.details'|tr}}</paper-button>
			</div>
		</template>
		<shadow></shadow>
	</template>
	<script>
		Polymer( 'simpl-crudtable', {
			dtMeta: null,
			currentRowIndex: null,
			created: function() {
				console.debug( "crudtable.created" );
			},
			ready: function() {
				console.debug( "crudtable.ready" );
			},
			domReady: function() {
				console.debug( "crudtable.domReady" );
			},
			addAction: function() {
				this.fire( "add-action", {
					entity: this.entity,
					entityChild: this.id,
					namespace: this.namespace
				} );
			},
			editAction: function() {
				if ( this.currentRowIndex == null ) return;
				this.fire( "edit-action", {
					data: this.dataSet[ this.currentRowIndex ],
					entity: this.entity,
					entityChild: this.id,
					namespace: this.namespace
				} );
			},
			detailAction: function() {
				if ( this.currentRowIndex == null ) return;
				this.fire( "detail-action", {
					data: this.dataSet[ this.currentRowIndex ]
				} );
			},
			copyAction: function() {
				if ( this.currentRowIndex == null ) return;
				this.fire( "copy-action", {
					data: this.dataSet[ this.currentRowIndex ],
					entity: this.entity,
					entityChild: this.id,
					namespace: this.namespace
				} );
			},
			rulesChanged: function( e ) {
				console.log( "rulesChanged" );
				this.entity = this.rules.entity;
				this.namespace = this.rules.namespace || simpl4.util.BaseManager.getNamespace();
				if ( this.dtMeta == null ) {
					this.dtMeta = this.preProcessMeta( simpl4EntityManager.getEntityViewFields( this.rules.entity, "main-grid", true ) );
				}
				this.dataSet = this.preProcessData( this.getData( this.rules ) );
				this.createTable( this.dtMeta, this.dataSet );
				this.createRowListener();
			},
			createRowListener: function() {
				var self = this;
				var rows = this.dtTable.rows().nodes();
				$( rows ).on( 'tap', ( function( e ) {
					self.tapAction( e, this, false );
				} ) );
			},
			tapAction: function( e, t, double ) {
				if ( $( t ).hasClass( 'selected' ) ) {
					return;
				}
				var rowIndex = e.currentTarget._DT_RowIndex;
				console.log( "tapAction:", rowIndex );
				this.currentRowIndex = rowIndex;
				this.q( 'tr.selected' ).removeClass( 'selected' );
				$( t ).addClass( 'selected' );
			},
			q: function( sel ) {
				return $( this.$.dataTablesId.querySelectorAll( sel ) );
			},
			preProcessData: function( rows ) {
				var selKeys = Object.keys( this.selectableList );
				var dateKeys = Object.keys( this.dateList );
				var datetimeKeys = Object.keys( this.datetimeList );
				rows.forEach( function( r ) {
					selKeys.forEach( function( key ) {
						var val = r[ key ];
						r[ key + "_display" ] = this.selectableList[ key ][ val ];
					}, this );
					dateKeys.forEach( function( key ) {
						var val = r[ key ];
						r[ key + "_display" ] = this.getDate( val );
					}, this );
				}, this );
				return rows;
			},
			preProcessMeta: function( fields ) {
				this.selectableList = {};
				this.dateList = {};
				this.datetimeList = {};
				this.columns = [];
				var ret = [];
				fields.forEach( function( f ) {
					var dtName = f.name;
					if ( f.hidden ) return;
					if ( f.selectable_items ) {
						this.selectableList[ f.name ] = this.toMap( f.selectable_items.getItems() );
						dtName = f.name + "_display";
					}
					if ( f.datatype == 'date' ) {
						this.dateList[ f.name ] = true;
						dtName = f.name + "_display";
					}
					if ( f.datatype == 'datetime' ) {
						this.datetimeList[ f.name ] = true;
						dtName = f.name + "_display";
					}
					var col = {
						title: tr( 'data.' + this.entity + '.' + f.name ),
						data: dtName
					}
					ret.push( col );
					this.columns.push( f.name );
				}, this );
				this.allModList = [];
				this.allModList.concat( this.selectableList );
				this.allModList.concat( this.dateList );
				this.allModList.concat( this.datetimeList );
				return ret;
			},
			toMap: function( sel ) {
				var map = {};
				sel.forEach( function( elem ) {
					map[ elem.value ] = elem.label;
				}, this );
				return map;
			},
			getDate: function( val ) {
				if ( val == null ) {
					return "--";
				}
				return moment( parseInt( val ) ).format( "L" );
			},
			getData: function( filter ) {
				console.debug( "GetData" );
				var data;
				if ( filter.rpc ) {
					data = simpl4.util.Rpc.rpcSync( "data:query", filter.rpc );
				} else {
					data = simpl4.util.Rpc.rpcSync( "data:query", {
						storeId: this.namespace + "_data",
						pageSize: 100,
						entity: filter.entity,
						filter: filter
					} );
				}
				return data.rows;
			}
		} );

	</script>
</polymer-element>
