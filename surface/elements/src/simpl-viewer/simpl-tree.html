<polymer-element name="simpl-tree" attributes="selectedItem">
	<template>
		<style>
			div[part] {
				cursor: pointer;
			}
			span[selected] {
				color: #fc0 !important;
				font-weight: bold;
			}
			ul {
				margin: 0;
				padding-left: 20px;
			}
			li {
				list-style-type: none;
			}
			tree-icon {
				display: inline-block;
				vertical-align: middle;
				background-repeat: no-repeat;
				fill: currentcolor;
				position: relative;
				height: 24px;
				width: 24px;
			}

		</style>
		<div id="main" unresolved="">
			<template id="tree_template" bind="{{data}}">
				<div class="{{ children && children.length > 0 ? 'parent' : ''}} collapsed" name="{{name}}" path="{{path}}" part="{{part}}" on-click="{{selectItem}}">
					<tree-icon on-click="{{toggleChildren}}" icon="{{ children && children.length > 0 ? 'hardware:keyboard-arrow-right' : 'arrow-drop-dowx'}}"></tree-icon>
					<span style="color:{{children && children.length > 0 ? 'black' : 'gray'}}">{{ name }}</span>
				</div>
				<ul style="display:none;">
					<template repeat="{{ child in children }}">
						<li>
							<template ref="tree_template" bind="{{child}}"></template>
						</li>
					</template>
				</ul>
			</template>
		</div>
	</template>
	<script>
		Polymer( 'simpl-tree', {
			iconOpen: 'hardware:keyboard-arrow-right',
			iconClose: 'hardware:keyboard-arrow-down',
			iconBOM: 'arrow-drop-down',
			data: {},
			toggleChildren: function( e, detail, sender ) {
				e.preventDefault();
				e.stopPropagation();
				var target = e.target || e.srcElement;
				var div = target.parentNode;
				var icon = target;
				if ( div.className.indexOf( 'parent' ) > -1 && div.nextElementSibling ) {
					var current_display = div.nextElementSibling.style.display;
					if ( current_display === 'none' ) {
						div.className = 'parent expanded';
						div.nextElementSibling.style.display = 'block';
						icon.setIcon( this.iconClose );
					} else {
						div.className = 'parent collapsed';
						div.nextElementSibling.style.display = 'none';
						icon.setIcon( this.iconOpen );
					}
				}
			},
			selectItem: function( e, detail, sender ) {
				var target = e.target || e.srcElement;
				var span = target;
				target = target.parentNode;
				var part = target.getAttribute( "part" );
				if ( part == null ) return;
				var path = target.getAttribute( "path" );
				var name = target.getAttribute( "name" );
				if ( this.prevSelected ) {
					this.prevSelected.removeAttribute( "selected" );
				}
				span.setAttribute( "selected", "" );
				this.prevSelected = span;
				this.selectedItem = {
					part: part,
					path: path,
					name: name
				};
				console.log( "selectedItem:", this.selectedItem );
			},
			created: function() {},

			domReady: function() {},

			ready: function() {
				var t = null;
				try {
					t = simpl4.util.Rpc.rpcSync( "bhs:getBOMTree", {
						namespace: "bhs",
						machine: "2100097"
					} );
				} catch ( e ) {
					alert( "Viewer._init:" + e );
					return;
				}
				this.data = t;
				this.$.main.setAttribute( 'resolved', '' );
				this.$.main.removeAttribute( 'unresolved' );
			},

			attached: function() {},

			detached: function() {},

			attributeChanged: function( attr, oldVal, newVal ) {}
		} );

	</script>

</polymer-element>
