<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<dom-module id="simpl-main">
	<style>
		core-animated-pages > * {
			font-size: inherit;
			overflow-y: auto;
			border-radius: 5px;
			background-color: white;
		}
		core-animated-pages {
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		@media all and (max-width: 480px) {
			core-animated-pages {
				width: 100%;
				height: 100%;
			}
		}
		section.main {
			padding: 6px;
			width: 100%;
			height: 100%;
		}
		section> div {
			width: 100%;
			height: 100%;
		}
		simpl-mmenu {
			position: relative;
		}
		@media all and (max-width: 480px) {
			html /deep/ #loginDialog {
				top: 10vh;
				left: 0vw;
			}
		}
		[drawer] {
			box-shadow: 1px 0 1px rgba(0, 0, 0, 0.1);
		}
		[main] {
			height: 100%;
		}
		#drawerPanel:not([narrow]) #menuButton {
			display: none;
		}
		:host /deep/ paper-button {
			min-width: 3em !important;
		}
		:host /deep/ div.button-content {
			overflow: hidden;
			font-size: 10px;
		}
		:host /deep/ select {
			padding: 3px;
			margin: 2px;
			-webkit-border-radius: 4px;
			-moz-border-radius: 4px;
			border-radius: 3px;
			-webkit-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			-moz-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			background: #ffffff;
			color: #888;
			border: none;
			outline: none;
			display: inline-block;
			//-webkit-appearance: none;
			//-moz-appearance: none;
			//appearance: none;
			cursor: pointer;
		}
		#headlineId {
			font-size: 18px;
		}
		@media screen and (max-width: 767px) {
			:host /deep/ #helpDialog /deep/ #scroller {
				padding: 10px 10px 10px 10px;
				margin-left: 0px;
				margin-right: 0px;
				margin-bottom: 10px;
			}
			:host /deep/ #helpDialog {
				margin-left: 0px;
				margin-right: 0px;
				margin-top: 85px;
			}
			#headlineId {
				font-size: 14px;
				margin-left: 0px;
				margin-right: 0px;
			}
		}

	</style>
	<template>
		<core-style ref="main"></core-style>

		<simpl-globals></simpl-globals>

		<flatiron-director route="{{route}}" auto-hash></flatiron-director>

		<!-- Keyboard nav controller. -->
		<!--core-a11y-keys id="keys" target="{{parentElement}}" keys="up down left right space space+shift" on-keys-pressed="{{keyHandler}}"></core-a11y-keys-->

		<simpl-dispatcher on-mmenu-selected="menuItemSelected" selected="{{route}}" pages="{{getPages()}}">
			<paper-drawer-panel id="drawerPanel" drawer-width="230px" responsive-width="700px" disable-swipe="false">
				<div class="vertical layout" drawer>
					<nav id="nav" class="layout vertical fit">
						<div>
							<a href="[[logoLinkLang]]" target="_blank">
								<img id="logo" src='{{logo}}' style="max-height:120px;max-width:220px;padding-left:8px;padding-top:8px;padding-bottom:3px;border-width: 0px; border-style: solid;" />
							</a>
						</div>
						<simpl-mmenu name="menu" background="{{mmenuBackground}}" classes="{{mmenuClasses}}" sliding-submenus="false" searchfield="true" pages="{{getPages()}}" class="flex" />
					</nav>
				</div>

				<paper-scroll-header-panel main xondenses class="flex">
					<paper-toolbar id="mainToolbar" class="{{toolboxClass}}">
						<paper-icon-button id="menuButton" icon="menu" on-tap="togglePanel"></paper-icon-button>
						<h2 id="headlineId" class="flex">{{selectedModel.node.name}}</h2>
						<template if="{{selectedModel.node.help!=null}}">
							<core-tooltip label="{{helpMessage}}" position="left">
								<paper-icon-button on-click="{{showHelp}}" icon="help"></paper-icon-button>
							</core-tooltip>
						</template>
						<paper-icon-button on-click="{{reload}}" class="langIcon" src="{{globals.lang|langIcon}}"></paper-icon-button>
						<core-tooltip label="{{loginMessage}}" position="left">
							<paper-icon-button on-click="{{login}}" icon="system-update-tv"></paper-icon-button>
						</core-tooltip>
					</paper-toolbar>

					<div class="content" style="height:100%">
						<neon-animated-pages style="position:relative;" id="pages" selected="{{route}}" attr-for-selected="hash" entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">
							<template is="dom-repeat" items="{{getPages()}}">
								<neon-animatable class="main" style="position:relative;" hash$={{item.hash}}>
									<div slide-from-right style="height:100%">
										<div style="max-width:100%;">{{item.name}}</div>
									</div>
								</neon-animatable>
							</template>
						</neon-animated-pages>
					</div>
				</paper-scroll-header-panel>

			</paper-drawer-panel>
		</simpl-dispatcher>

		<!--paper-dialog layered="false" id="helpDialog">
			<template is="imported-template" content="{{selectedModel.node.help|substituteLang}}"></template>
		</paper-dialog>
		<paper-dialog id="loginDialog">
			<simpl-login on-login-ok="{{loginOk}}" id="login"></simpl-login>
		</paper-dialog-->
	</template>
	<script>
		Polymer( {
			is: 'simpl-main',
			cache: function() {
				return {};
			},
			toolbarBackground: null,
			properties: {
				globals: Object,
				logoLinkLang: {
					computed: "substituteLang(logoLink,globals)"
				},
				logoLink: {
					type: String
				},
				toolbarBackground: {
					observer:"toolbarBackgroundChanged",
					type: String
				},
				loginMessage: {
					value: 'Login',
					type: String
				},
				mmenuBackground: {
					value: null,
					type: String
				},
				mmenuClasses: {
					value: null,
					type: String
				},
				logoBackground: {
					value: null,
					type: String
				},
				logo: {
					value: 'logo.svg',
					type: String
				}
			},
			observers: [
				'routeChanged(route)'
			],
			getPages: function() {
				return simpl4PageRegistry.getPages();
			},
			attached: function() {
				this.async( function() {
					this._attached();
				} );
				this.globals = simpl4Globals.getAll();
			//	this.entryAnimation = 'fade-in-animation';
        this.exitAnimation = 'fade-out-animation';
			},
			_attached: function() {
				this.helpMessage = tr( "button.help" );
				this.drawerPanel = this.$.drawerPanel;
				this.corePages = this.$.pages;
				this.keys = this.$.keys;
				$( this.$.logo ).css( "background", this.logoBackground );
				$( this.$.nav ).css( "background", this.logoBackground );
				// Allow selecting pages by num keypad. 
				var keysToAdd = Array.apply( null, simpl4PageRegistry.getPages() ).map( function( x, i ) {
					return i + 1;
				} ).reduce( function( x, y ) {
					return x + ' ' + y;
				} );
				if ( this.keys ) {
					this.keys += ' ' + keysToAdd;
				}

				console.log( "location:" + window.location );
				console.log( "init.route:" + this.route );
				this.toolboxClass = "";
			},
			toolbarBackgroundChanged: function() {
				$( this.$.mainToolbar ).css( "background", this.toolbarBackground );
			},
			routeChanged: function() {
				console.log( "routeChanged:" + this.route );
				var route = this.route;
				if ( route.match( /^!/ ) ) {
					route = route.substring( 1 );
				}
				if ( this.route != route ) {
					this.route = route;
				}
				console.log( "routeChanged2:" + this.route );
				//	$( this.$.pages.querySelectorAll( "neon-animatable" ) ).css( "display", "" );
			//		$( this.$.pages.querySelector( "section.iron-selected" ) ).css( "display", "none" );
				channel.publish( "route.changed", {
					route: this.route
				} );
				try {
					if ( window._paq ) {
						var action = this.route == "0" ? "main" : this.route;
						if ( this.lastAction != action ) {
							console.log( "trackEvent,webclient:" + action )
								//@@@MS							_paq.push( [ 'trackEvent', "webclient", action+ "/"+globals.lang ] )
						}
						this.lastAction = action;
					}
				} catch ( e ) {
					console.error( "trackEvent:", e.stack );
				}
			},
			togglePanel: function() {
				this.drawerPanel.togglePanel();
			},
			keyHandler: function( e, detail, sender ) {
				var num = parseInt( detail.key );
				if ( !isNaN( num ) && num <= simpl4PageRegistry.getPages().length ) {
					this.corePages.selectIndex( num - 1 );
					return;
				}

				switch ( detail.key ) {
					case 'left':
					case 'up':
						this.corePages.selectPrevious();
						break;
					case 'right':
					case 'down':
						this.corePages.selectNext();
						break;
					case 'space':
						detail.shift ? this.corePages.selectPrevious() : this.corePages.selectNext();
						break;
				}
			},
			menuItemSelected: function( e ) {
				console.log( "menuItemSelected:", e );
				var url = null;
				try {
					url = e.detail.model.node.url;
				} catch ( e ) {}
				if ( e.detail.isSelected && url ) {
					this.selectedModel = e.detail.model;
					this.route = e.detail.model.node.hash;
					if ( this.cache[ url ] !== true ) {
						console.log( "Loading:", e.detail.model.node.url );
						this.importHref( e.detail.model.node.url, this.onResponse.bind( this ) );
					}
				}
				this.$.drawerPanel.closeDrawer();
			},
			onResponse: function( e ) {
				var _import = e.target.import;
				var body = _import.body;
				var head = _import.head;
				console.log( "onResponse", e );

				[].forEach.call( body.querySelectorAll( 'img' ), function( img ) {
					img.setAttribute( 'src', img.src );
				} );

				this.cache[ this.selectedModel.node.url ] = true;

				var insertPoint = this.corePages.selectedItem.firstElementChild;
				console.log( "insertPoint:", insertPoint );
				while ( insertPoint.firstChild ) {
					Polymer.dom( insertPoint ).removeChild( insertPoint.firstChild );
				}
				if ( head.firstElementChild ) {
					if ( head.firstElementChild ) {
						try {
							head.firstElementChild.set( "globals", this.globals );
							var self = this;
							head.firstElementChild.set( "eval", function( p1 ) {
								return self._maskedEval( p1, this.globals );
							} );
							head.firstElementChild.set( "tr", function( p1 ) {
								return tr( p1 );
							} );
						} catch ( e ) {
							console.log( "simpl-main.template.set:", e.stack );
						}
					}
					Polymer.dom( insertPoint ).appendChild( head.firstElementChild );
				}
				if ( body.firstElementChild ) {
					console.log( "simpl-main.body.firstElementChild", body.firstElementChild );
					Polymer.dom( insertPoint ).appendChild( body.firstElementChild );
				}
				
				this.async( function() {
					this.convertSheetsToStyles( insertPoint );
					var scope = this.selectedModel.node.scope;
					this._setStyleScope( insertPoint, scope);
					this.evalScripts( insertPoint );
				}, 2 );
			},
			_maskedEval: function( scr, env, def ) {
				try {
					return ( new Function( "with(this) { return " + scr + "}" ) ).call( env );
				} catch ( e ) {
					console.error( "simpl-main.eval.error:" + e );
				}
				return def;
			},
			_setStyleScope: function( main_el, scope ) {
				if( !scope) {
					return;
				}
				this.async( function() {
					this._domVisitor( main_el, function( el ) {
						if ( !$( el ).hasClass( scope ) && el.nodeType == 1 ) {
							el.classList.add( scope )
						}
					} );
				}, 0 );
			},
			_domVisitor: function( el, f ) {
				if ( el ) {
					f( el );
					for ( var i = 0; i < el.childNodes.length; i++ ) {
						this._domVisitor( el.childNodes[ i ], f );
					}
				}
			},
			evalScripts: function( root ) {
				var SCRIPT_SELECTOR = 'script';
				var scripts = root.querySelectorAll( SCRIPT_SELECTOR );
				for ( var i = 0; i < scripts.length; i++ ) {
					eval( scripts[ i ].text );
				}
			},
			convertSheetsToStyles: function( root ) {
				var SHEET_SELECTOR = 'link[rel=stylesheet]';
				var sheets = root.querySelectorAll( SHEET_SELECTOR );
				console.log( "sheets:", sheets );
				for ( var i = 0, l = sheets.length, s, c;
					( i < l ) && ( s = sheets[ i ] ); i++ ) {
					var href = this.hrefForSheet( s, this.ownerDocument.baseURI );
					c = this.createStyleElement( this.importRuleForSheet( s, this.ownerDocument.baseURI ), this.ownerDocument );
					this.importHref( href, this._onCssResponse.bind( this ) );
					//this.copySheetAttributes( c, s );
					//s.parentNode.replaceChild( c, s );
					s.parentNode.removeChild( s );
				}
			},
			_onCssResponse: function( e ) {
				var _import = e.target.import;
				var css =  _import.body.textContent;
				var scope = this.selectedModel.node.scope;
				if( scope ){
					//console.log( "css:", css );
					var ast = mensch.parse( css );
					this._visitCssRules( ast.stylesheet.rules, this._visitCssNode.bind( this ), scope );
					css = mensch.stringify(ast);
				}
				var	c = this.createStyleElement( css, this.ownerDocument );
				document.head.appendChild( c );
			},
			_visitCssNode: function( node, scope ) {
				if ( node.type == "rule" ) {
					this._visitCssRule( node, scope );
				} else if ( node.type == "media" ) {
					if ( node.rules ) {
						this._visitCssRules( node.rules, this._visitCssRule.bind( this ), scope );
					}
				}
			},
			_visitCssRules: function( items, fn, scope ) {
				return items.reduce( function( results, item ) {
					if ( item.type !== 'comment' ) {
						fn( item, scope );
					}
				}, [] );
			},
			_visitCssRule: function( node, scope ) {
				if ( node.selectors ) {
					for ( var i = 0; i < node.selectors.length; i++ ) {
						node.selectors[ i ] = node.selectors[i]+"."+scope;
					}
				}
				if ( node.rules ) {
					this._visitCssRules( node.rules, this._visitCssRule.bind( this ), scope );
				}
			},
			copySheetAttributes: function( style, link ) {
				for ( var i = 0, attr = link.attributes, l = attr.length, a;
					( a = attr[ i ] ) && i < l; i++ ) {
					if ( a.name !== 'rel' && a.name !== 'href' ) {
						style.setAttribute( a.name, a.value );
					}
				}
			},
			importRuleForSheet: function( sheet, baseUrl ) {
				var href = new URL( sheet.getAttribute( 'href' ), baseUrl ).href;
				return '@import \'' + href + '\';';
			},
			hrefForSheet: function( sheet, baseUrl ) {
				var href = new URL( sheet.getAttribute( 'href' ), baseUrl ).href;
				return href;
			},
			createStyleElement: function( cssText, scope ) {
				scope = scope || document;
				scope = scope.createElement ? scope : scope.ownerDocument;
				var style = scope.createElement( 'style' );
				style.textContent = cssText;
				return style;
			},
			getLogoLink: function() {
				console.log( "logoLink2:", this.logoLink );
				return this.substituteLang( this.logoLink );
			},
			substituteLang: function( url ) {
				console.log( "substituteLang:", this.globals );
				if ( url == null || url == '' ) return;
				if ( url.indexOf( "%l" ) != -1 ) {
					url = url.replace( "%l", this.globals.lang );
				}
				if ( !url.match( /^http/ ) ) {
					if ( url.match( /^[a-zA-Z].*/ ) ) {
						url = "./" + url;
					}
					url += "?t=1";
				}
				console.log( "url:" + url );
				return url;
			},
			showHelp: function( e ) {
				if ( window._paq && !this.$.helpDialog.opened ) {
					var action = this.route == "0" ? "main" : this.route;
					_paq.push( [ 'trackEvent', "webclient", action + "_help" ] )
				}
				this.$.helpDialog.toggle();
			},
			loginOk: function( e ) {
				this.loginMessage = "User:" + e.detail.identifier;
				this.$.loginDialog.toggle();
			},
			login: function( e ) {
				this.$.loginDialog.toggle();
			},

			langIcon: function( lang ) {
				return ( lang == "de" || lang == null ) ? "en.svg" : "de.svg";
			},
			reload: function( e ) {
				var lang = Simpl4.Cache.getItem( "lang" );
				Simpl4.Cache.setItem( "lang", ( lang == "de" || lang == null ) ? "en" : "de" );
				location.search = "";
				history.go( 0 )
			}
		} );

	</script>
</dom-module>
