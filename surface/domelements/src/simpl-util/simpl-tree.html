<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-tree" attributes="selectedItem selected data idProp childrenProp nameProp">
	<template>
		<style>
			div[idvalue] {
				cursor: pointer;
				-webkit-tap-highlight-color:  lightgray; 
			}
			span[selected] {
				color: #fc0 !important;
				font-weight: bold;
			}
			ul {
				margin: 0;
				padding-left: 20px;
			}
			li {
				list-style-type: none;
			}
			.truncate {
				padding-top: 6px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			polyfill-rule {
				content: '.truncate';
				width: calc(100% - 28px);
				padding-top: 3px;
			}
			tree-icon {
				display: inline-block;
				vertical-align: middle;
				background-repeat: no-repeat;
				fill: currentcolor;
				position: relative;
				height: 24px;
				width: 24px;
			}

		</style>
		<div id="main" unresolved="">
			<template id="tree_template" bind="{{data as d}}">
				<div layout horizontal idvalue="{{d[idProp]}}" class="{{ d.children && d.children.length > 0 ? 'parent' : ''}} collapsed" on-click="{{selectItem}}">
					<tree-icon on-click="{{toggleEvent}}" icon="{{ d.children && d.children.length > 0 ? 'hardware:keyboard-arrow-right' : 'arrow-drop-dowx'}}"></tree-icon>
					<span title="{{d[nameProp]}}" class="truncate" style="color:{{d.children && d.children.length > 0 ? 'black' : 'gray'}}">{{ d[nameProp] }}</span>
				</div>
				<ul style="display:none;">
					<template repeat="{{ child in d.children }}">
						<li>
							<template ref="tree_template" bind="{{child as d}}"></template>
						</li>
					</template>
				</ul>
			</template>
		</div>
	</template>
	<script>
		Polymer( 'simpl-tree', {
			iconOpen: 'hardware:keyboard-arrow-right',
			iconClose: 'hardware:keyboard-arrow-down',
			iconBOM: 'arrow-drop-down',
			data: {},
			idProp: 'path',
			childrenProp: 'children',
			nameProp: 'name',
			toggleEvent: function( e ) {
				e.preventDefault();
				e.stopPropagation();
				var target = e.target || e.srcElement;
				var div = target.parentNode;
				var icon = target;
				this.toggleChildren( div, icon );
			},
			toggleChildren: function( div, icon ) {
				if ( div.className.indexOf( 'parent' ) > -1 && div.nextElementSibling ) {
					var current_display = div.nextElementSibling.style.display;
					if ( current_display === 'none' ) {
						div.className = 'parent expanded';
						div.nextElementSibling.style.display = 'block';
						icon.setIcon( this.iconClose );
					} else {
						div.className = 'parent collapsed';
						div.nextElementSibling.style.display = 'none';
						icon.setIcon( this.iconOpen );
					}
				}
			},
			selectItem: function( e ) {
				var target = e.target || e.srcElement;
				var span = target;
				target = target.parentNode;
				var id = target.getAttribute( "idvalue" );
				if ( id == null ) return;

				if ( this.prevSelected ) {
					this.prevSelected.removeAttribute( "selected" );
				}
				this.selectedItem = this.getItemById( id, this.data );
				span.setAttribute( "selected", "" );
				this.prevSelected = span;
			},
			selectedChanged: function() {
				var selector = '[idvalue="' + this.selected + '"] span';
				var span = this.$.main.querySelector( selector );
				this.openTree(span);
				if ( this.prevSelected ) {
					this.prevSelected.removeAttribute( "selected" );
				}
				this.prevSelected = span;
				span.setAttribute( "selected", "" );
				var selectedItem = this.getItemById( this.selected, this.data );
				this.selectedItem = selectedItem;
			},
			openTree:function(span){
				var div = span.parentElement;
				while ( div && div.nodeName == "DIV" ) {
					var li = div.parentElement;
					if ( li.nodeName != "LI" ) {
						break;
					}
					li = li.parentElement.parentElement;
					var div = li.querySelector( "div[idvalue]" );
					var icon = div.querySelector( "tree-icon" );
					this.toggleChildren( div, icon );
				}
			},
			getItemById: function( id, node ) {
				if ( node[ this.idProp ] == id ) {
					return node
				}
				var children = node[ this.childrenProp ];
				for ( var i = 0; children && i < children.length; i++ ) {
					var node = this.getItemById( id, children[ i ] );
					if ( node ) return node;
				}
				return null;
			},
			created: function() {},

			domReady: function() {},

			ready: function() {
				this.$.main.setAttribute( 'resolved', '' );
				this.$.main.removeAttribute( 'unresolved' );
			},

			attached: function() {},

			detached: function() {},

			attributeChanged: function( attr, oldVal, newVal ) {}
		} );

	</script>

</polymer-element>
