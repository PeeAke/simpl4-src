<script>
	modularize('form-field', function() {
		return {
			kinds: [],
			register: function(polymerElement) {
				var kind = polymerElement.getAttribute('kind');
				if (kind) {
					this.kinds.push(kind);
					polymerElement.removeAttribute('kind');
				}
			}
		};
	});
</script>

<polymer-element name="form-field" attributes="name value meta editValue" field>
	<template>
		<style>
			:host {
				min-width: 136px;
				margin: 4px 14px 4px 0;
			}
		</style>
	</template>
	<script>
		Polymer({
			registerCallback: function(polymerElement) {
				// TODO: `using` seems to force async (even when not necessary)
				// which breaks the timeline if the using() is outside of the 
				// Polymer invocation
				// This happens because `using` calls `whenImportsReady` which
				// requires the document to be in ready-state, and this import
				// document is in loading-state when parsing the enclosing script tag
				using('form-field', function(df) {
					df.register(polymerElement);
				});
			},
			attached: function() {
				this.fire('add-form-field');
			},
			detached: function() {
				this.fire('remove-form-field');
			}
		});
	</script>
</polymer-element>

<!--PAPERFIELDS-->
<polymer-element name="input-field" extends="form-field" attributes="type label name" kind="input" layout horizontal center>
	<template>
		<paper-input-decorator id="decorator" label="{{label}}" invisible="{{invisible}}" floatingLabel="{{floatingLabel}}" value="{{value}}" disabled?="{{disabled}}">
			<input is="core-input" id="input" value="{{value}}" committedValue="{{committedValue}}" on-change="{{changeAction}}" disabled?="{{disabled}}">
		</paper-input-decorator>
	</template>
	<script>
		Polymer({
			type: "text",
			value: "",
			floatingLabel: true,
			hasDate: Modernizr.inputtypes.date,
			observe: {
				type: 'validateAttributes',
			},
			domReady: function() {
				if (this.label == null || this.label == '') this.label = this.name;
				this.validateAttributes();
				this.decorator = this.$.decorator;
				this.input = this.$.input;
				this.validateAttributes();
				if (this.type == "date") {
					this.invisible = false;
				}
				console.log("paper-input:" + this.label + "/" + this.type);
				self = this;
				if (this.type.match(/^date/) != null && !this.hasDate) {
					var picker = new Pikaday({
						field: this.$.input,
						trigger: this.$.input,
						onSelect: function(a) {
							self.value = this.$.input.value;
						}.bind(this),
						bound: true,
						showTime: this.type.match(/^datetime/) != null,
						showSeconds: false,
						use24hour: true,
						firstDay: 1,
						minDate: new Date('2000-01-01'),
						maxDate: new Date('2020-12-31'),
						yearRange: [2000, 2020]
					});
				}
			},
			isAuthorizedType: function() {
				var okTypes = [
					'checkbox',
					'color',
					'date',
					'datetime',
					'datetime-local',
					'email',
					'file',
					'month',
					'number',
					'password',
					'radio',
					'range',
					'tel',
					'text',
					'time',
					'url',
					'week'
				];
				return (okTypes.indexOf(this.type) != -1);
			},
			validateAttributes: function() {
				if (!this.input) {
					return;
				}
				if (this.type != 'text' && !this.isAuthorizedType()) {
					this.type = 'text'
				}
				this.input.setAttribute('type', this.type);
			},
			valueChanged: function() {
				if (!this.$.decorator) return;
				var cvList = regula.validate({
					elements: [this],
					groups: [regula.Group.MyGroup]
				});
				console.debug("valueChanged(" + this.name +","+this.$.input.value+","+this.value+ "):"+ cvList.length);
				this.decorator.isInvalid = cvList.length > 0;
				if (cvList.length > 0) {
					this.decorator.error = cvList[0].message;
				}
			},
			setCustomValidity: function(message) {
				console.debug("setCustomValidity:" + message);
			},
			editValueChanged: function() {
				console.debug("editValueChanged");
				this.fire('validate-form-field');
			}
		});
	</script>
</polymer-element>

<polymer-element name="checkbox-field" extends="form-field" kind="checkbox" noscript>
	<template>
		<paper-checkbox style="margin: 10px 0;" label="{{name}}" checked="{{value}}"></paper-checkbox>
	</template>
</polymer-element>

<polymer-element name="toggle-field" extends="form-field" kind="toggle" layout horizontal center noscript>
	<template>
		<paper-toggle-button checked="{{value}}"></paper-toggle-button>
		<div style="margin-left: 22px;">{{name}}</div>
	</template>
</polymer-element>

<polymer-element name="slider-field" extends="form-field" kind="slider" layout horizontal noscript>
	<template>
		<span style="display: inline-block; padding: 8px 0px; vertical-align: middle;">{{name}}</span>
		<paper-slider flex style="vertical-align: middle;" value="{{value}}"></paper-slider>
	</template>
</polymer-element>

<polymer-element name="radio-field" extends="form-field" kind="radio-group" noscript>
	<template>
		<style>
			:host > * {
				vertical-align: middle;
			}
		</style>
		<span style="color: silver; padding: 12px 0px;">{{name}}</span>
		<paper-radio-group selected="{{value}}">
			<content></content>
		</paper-radio-group>
	</template>
</polymer-element>

<polymer-element name="dropdown-field" extends="form-field" kind="dropdown" noscript>
	<template>
		<style>
			:host {
				margin-top: 8px;
			}
		</style>
		<span style="vertical-align: middle;">{{name}}</span>&nbsp;

		<paper-dropdown-menu>
			<paper-dropdown class="dropdown">
				<core-menu selected="{{value}}" icon="arrow-drop-down">
					<content></content>
				</core-menu>
			</paper-dropdown>
		</paper-dropdown-menu>
	</template>
</polymer-element>

<polymer-element name="ssn-field" extends="form-field" kind="ssn" layout horizontal center on-keypress="{{keyPress}}">
	<template>
		<style>
			paper-input {
				margin-right: 4px;
			}
			[two-digits] {
				width: 1.5em;
			}
			[three-digits] {
				width: 2em;
			}
			[four-digits] {
				width: 2.5em;
			}
			span {
				margin-right: 12px;
			}
		</style>
		<span>{{name}}</span>
		<paper-input three-digits value="{{partA}}"></paper-input> -
		<paper-input two-digits value="{{partB}}"></paper-input> -
		<paper-input four-digits value="{{partC}}"></paper-input>
	</template>
	<script>
		Polymer({
			computed: {
				value: 'concat(partA, partB, partC)'
			},
			concat: function(a, b, c) {
				return a + '-' + b + '-' + c;
			},
			keyPress: function(e) {
				var c = String.fromCharCode(e.charCode);
				if (!c.match(/\d/)) {
					e.preventDefault();
				}
			}
		});
	</script>
</polymer-element>



<!--PAPERFORM-->
<style>
	html /deep/ [novanish] {
		min-height: 8px;
	}
	design-frame /deep/ paper-row {
		border: 1px dotted rgba(240, 240, 240, 0.5);
		border-radius: 8px;
		margin: -1px -1px;
	}
</style>

<polymer-element name="paper-group" segment horizontal layout wrap novanish noscript></polymer-element>

<polymer-element name="paper-row" horizontal layout center wrap novanish noscript></polymer-element>

<polymer-element name="paper-form" attributes="dump" constructor="PaperForm" vertical layout>
	<template>
	</template>
	<script>
		Polymer('paper-form', {
			eventDelegates: {
				'add-form-field': 'addField',
				'remove-form-field': 'removeField'
			},
			created: function() {
				this.fields = [];
			},
			addField: function(e) {
				this.fields.push(e.target);
			},
			removeField: function(e) {
				var i = this.fields.indexOf(e.target);
				if (i >= 0) {
					this.fields.splice(i, 1);
				}
			},
			dump: function() {
				console.log("Dump2");
				var data = {};
				this.fields.forEach(function(f) {
					data[f.name] = f.value;
				}, this);
				console.log("Data:", data);
				return data;
			}
		});
	</script>
</polymer-element>
