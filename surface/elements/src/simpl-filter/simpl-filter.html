<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<link rel="import" href="import-js.html">
<polymer-element name="simpl-filter" attributes="">

	<template>
		<style>
			dd {
				margin-left: 0px;
			}
		</style>
		<link rel="stylesheet" href="bootstrap-btn.css" shim-shadowdom>
		<link rel="stylesheet" href="query-builder.css" shim-shadowdom>
		<div id="builder"></div>
		<div>
			<button on-tap="{{submit}}">Submit</button>
		</div>
		<segment>
			Filter rules:
			<pre><code id="data"></code></pre>
		</segment>
	</template>

	<script>
		Polymer( 'simpl-filter', {
			domReady: function() {
			var 		filters= simpl4.util.SearchFilter.createSearchFilter("contact");
			console.debug("Filter:"+JSON.stringify(filters,null,2));
				$( this.$.builder ).queryBuilder( {
					icons: {
						add_group: 'fa fa-plus-circle',
						add_rule: 'fa fa-plus',
						remove_group: 'fa fa-minus',
						remove_rule: 'fa fa-minus',
						error: 'fa fa-bug',
						sort: 'fa fa-sort'
					},
					sortable: false,
					//plugins: ["sortable"],
					display_errors: true,
	
					filters: filters,
				} );

				// set rules
				$( '.set' ).on( 'click', function() {
					$( this.$.builder ).queryBuilder( 'setRules', {
						condition: 'AND',
						rules: [ {
							id: 'price',
							operator: 'less',
							value: 10.25
						}, {
							condition: 'OR',
							rules: [ {
								id: 'category',
								operator: 'in',
								value: [ 1, 2 ]
							}, {
								id: 'name',
								operator: 'equal',
								value: "John Doe"
							} ]
						} ]
					} );
				} );
			},
			renameOne:function(from,to,model){
				model[to] = model[from];
				delete model[from];
			},
			deleteOne:function(from,model){
				delete model[from];
			},
			connectorToLowerCase:function(model){
				if( model.connector === undefined){
					return;
				}
				model.connector = model.connector.toLowerCase();
			},
			renameFrom: function (model) {
				this.renameOne("condition", "connector", model);
				this.connectorToLowerCase(model);
				this.renameOne("value", "data", model);
				this.renameOne("operator", "op", model);
				this.deleteOne("input",model);
				this.deleteOne("type",model);
				this.deleteOne("id",model);
				var children = model.rules||[];
				model.children=children;
				delete model.rules;
				if (children.length > 0) {
					for (var i = 0; i < children.length; i++) {
						this.renameFrom(children[i]);
					}
				}
				return model;
			},
			renameTo: function (model,meta) {
				this.renameOne("connector", "condition", model);
				this.renameOne("data", "value", model);
				this.renameOne("op", "operator", model);
				model.input = meta.edittype;
				model.type = meta.datetype;
				model.id =model.field;
				var rules = model.children||[];
				model.rules=rules;
				delete model.children;
				if (rules.length > 0) {
					for (var i = 0; i < rules.length; i++) {
						this.renameTo(rules[i],meta);
					}
				}
				return model;
			},
			getRules:function(){
					return this.renameFrom($( this.$.builder ).queryBuilder( 'getRules'));
			},
			setRules:function(rules){
					$( this.$.builder ).queryBuilder( 'setRules',rules);
			},
			reset: function( e ) {
				$( this.$.builder).queryBuilder( 'reset' );
			},
			submit: function( e ) {
				var jsonData = JSON.stringify( this.getRules(), null, 2 )
				this.$.data.textContent = jsonData;
			}
		} );
	</script>

</polymer-element>
