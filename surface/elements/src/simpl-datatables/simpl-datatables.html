<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<link rel="import" href="import-js.html">
<polymer-element name="simpl-datatables" attributes="" flex relative>
	<template>
		<link rel="stylesheet" type="text/css" href="jquery.dataTables.css" />
		<link rel="stylesheet" type="text/css" href="dataTables.responsive.css" />
		<style shim_shadowdom>
			:host /deep/ #datatables_main {
				width: 100%;
				max-width: 100%;
			}
		</style>
		<core-signals on-core-signal-filter-changed="{{filterChanged}}"></core-signals>
		<div>
			<table cellpadding="0" cellspacing="0" border="0" width="100%" class="display responsive nowrap" id="datatables_main"></table>
		</div>
		<content>
		</content>
	</template>
	<script>
		Polymer( {
			dtMeta: null,
			dtTable: null,
			eventDelegates: {
				'filter-changed': 'filterChanged'
			},
			ready: function() {},
			domReady: function() {},
			filterChanged: function( e ) {
				var self = this;
				var data = e.detail;
				this.entity = data.entity;
				if ( this.dtMeta == null ) {
					this.dtMeta = this.preProcessMeta( simpl4EntityManager.getEntityViewFields( data.entity, "main-grid", true ) );
				}
				var dataSet = this.preProcessData( this.getData( e.detail.entity, e.detail.filter ) );

				if ( this.dtTable ) {
					this.dtTable.destroy();
				}
				var self = this;
				var dtMainElem = $( this.$.datatables_main );
				dtMainElem.on( 'init.dt.dtr', function( e, settings, json ) {
					new jQuery.fn.dataTable.Responsive( settings );
//					new jQuery.fn.dataTable.FixedHeader( self.dtTable,undefined,settings );
				} );
				this.dtTable = dtMainElem.DataTable( {
					language: {
						"sEmptyTable": "Keine Daten in der Tabelle vorhanden",
						"sInfo": "_START_ bis _END_ von _TOTAL_ Einträgen",
						"sInfoEmpty": "0 bis 0 von 0 Einträgen",
						"sInfoFiltered": "(gefiltert von _MAX_ Einträgen)",
						"sInfoPostFix": "",
						"sInfoThousands": ".",
						"sLengthMenu": "_MENU_ Einträge anzeigen",
						"sLoadingRecords": "Wird geladen...",
						"sProcessing": "Bitte warten...",
						"sSearch": "Suchen",
						"sZeroRecords": "Keine Einträge vorhanden.",
						"oPaginate": {
							"sFirst": "Erste",
							"sPrevious": "Zurück",
							"sNext": "Nächste",
							"sLast": "Letzte"
						},
						"oAria": {
							"sSortAscending": ": aktivieren, um Spalte aufsteigend zu sortieren",
							"sSortDescending": ": aktivieren, um Spalte absteigend zu sortieren"
						}
					},
					responsive: true,
					data: dataSet,
					columns: this.dtMeta
				} );
/*				$( this.$.datatables_main ).on( 'draw.dt', function() {
					var ee = document.querySelector( "html /deep/ .ellipsis" );
					console.log( "ee:", ee );
					var aList = document.getElementsByTagName( "simpl-datatables" )[ 0 ].shadowRoot.querySelectorAll( ".ellipsis" );
					console.log( "ee:", aList );
					$( aList ).ellipsis();
				} );*/

			},
			preProcessData: function( rows ) {
				rows.forEach( function( r ) {
					r.email1 = "<div class='ellipsis' style='white-space:normal;overflow:hidden;'>" + r.email1 + "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</div>"; //r.email1.substring(0,16)+"X";
				}, this );
				return rows;
			},
			preProcessMeta: function( fields ) {
				var ret = [];
				fields.forEach( function( f ) {
					if ( f.hidden ) return;
					var col = {
						title: tr( 'data.' + this.entity + '.' + f.name ),
						data: f.name
					}
					ret.push( col );
				}, this );
				return ret;
			},
			getData: function( entity, filter ) {
				var data = simpl4.util.Rpc.rpcSync( "data:query", {
					storeId: "firstapp_data",
					pageSize: 100,
					entity: entity,
					filter: filter
				} );
				return data.rows;
			}
		} );
	</script>
</polymer-element>
