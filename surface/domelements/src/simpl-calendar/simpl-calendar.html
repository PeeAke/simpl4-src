<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<script src="fullcalendar.js"></script>
<link rel="import" href="calendar-behavior.html">
<link rel="import" type="css" href="fullcalendar.css">
<dom-module id="simpl-calendar">
	<style>
		#eventList li {
			list-style: none;
		}
		:host /deep/ .fc-state-highlight {
			background: beige;
		}
		:host paper-icon-button {
			padding: 2px;
		}

	</style>
	<template>
		<style is="custom-style" include="simpl-calendar-shared-styles"></style>
		<div class="layout horizontal">
			<div class="flex">
				<ul id="eventList">
					<template id="listTemplateId" is="dom-repeat" as="event" items="[[eventList]]" restamp>
						<li id="listevt2">
							<div class="layout horizontal">
								<div style="padding-top:6px;" class="label">[[formatEvent(event)]]</div>
								<paper-icon-button on-tap="selectEventInCalendar" data-eid$="[[event._id]]" icon="create"></paper-icon-button>
								<paper-icon-button on-tap="removeEventFromCalendar" data-eid$="[[event._id]]" icon="delete"></paper-icon-button>
							</div>
						</li>
					</template>
				</ul>
			</div>
			<div class="flex">
				<div id="picker"></div>
			</div>
		</div>

		<div class="layout horizontal">
			<div id="fullcalendar"></div>
		</div>
		<content>
		</content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-calendar',
			properties: {
				eventList: {
					value: function() {
						return [];
					},
					type: Array
				}
			},
			observers: [],
			behaviors: [
				ModernizrBehavior,
				CalendarBehavior
			],
			attached: function() {
				this.async( function() {
					this.createCalendar();
				}, 100 );
				this.lang = simpl4.util.BaseManager.getLanguage();
			},

			formatEvent: function(event) {
console.log("formatEvent:",event);
console.log("formatEvent2:",event.startFormated);
				return event.startFormated;
			},
			clearEventList: function() {
				var a = this.eventList;
				if ( !a || a.length == 0 ) return;
				this.splice( "eventList", 0, a.length );
			},
			addToEventList: function( ev ) {
				this.push( 'eventList', ev );
			},
			removeFromEventList: function( eid ) {
				for ( var i = 0; i < this.eventList.length; i++ ) {
					if ( eid === this.eventList[ i ]._id ) {
						this.splice( "eventList", i, 1 );
						break;
					}
				}
			},
			getEventById: function( eid ) {
				var el = this.eventList;
				for ( var i = 0; i < el.length; i++ ) {
					if ( el[ i ]._id == eid ) {
						return el[ i ];
					}
				}
				return null;
			},
			getElementById: function( eid ) {
				var el = this.eventList;
				for ( var i = 0; i < el.length; i++ ) {
					if ( el[ i ]._id == eid ) {
						return el[ i ].element;
					}
				}
				return null;
			},
			selectEventInCalendar: function( e ) {
				var eid = e.target.dataset.eid;
				var ev = this.getEventById( eid );
				console.log( "selectEvent.eid:", eid );

				$( fullcalendar ).fullCalendar( 'gotoDate', ev.start );
				var element = this.getElementById( eid );
				console.log( "selectEvent.element:", element );
				$( ".fc-state-highlight" ).removeClass( "fc-state-highlight" );
				$( element ).addClass( "fc-state-highlight" );
			},
			removeEventFromCalendar: function( e ) {
				var fullcalendar = this.querySelector( "#fullcalendar" );
				var eid = e.target.dataset.eid;
				console.log( "removeEvent.eid:", eid );
				var current = $( fullcalendar ).fullCalendar( 'getDate' );
				var ev = this.getEventById( eid );
				$( fullcalendar ).fullCalendar( 'gotoDate', ev.start );
				$( fullcalendar ).fullCalendar( 'removeEvents', eid );
				$( fullcalendar ).fullCalendar( 'gotoDate', current );
				this.updateEventList();
			},

			updateEventList: function() {
				var fullcalendar = this.querySelector( "#fullcalendar" );
				this.clearEventList();
				console.log( "updateEventList" );
				var evList = $( fullcalendar ).fullCalendar( 'clientEvents' );
				console.log( "eventListSize:" + evList.length );
				evList.forEach( ( function( entry, index ) {
					console.log( "\teventList(" + index + "):", entry );
					this.addToEventList( entry );
				} ).bind( this ) );
//					this.$.listTemplateId._render();
				this.async( function() {
					this.$.listTemplateId.render();
				}, 100 );
			},
			createCalendar: function() {
				var fullcalendar = this.querySelector( "#fullcalendar" );
				var picker = this.querySelector( "#picker" );

				$( picker ).datetimepicker( {
					format: 'd.m.Y H:i',
					inline: true,
					lang: this.lang,
					onChangeDateTime: function( ct, $i ) {
						var m = moment( ct.getTime() );
						$( fullcalendar ).fullCalendar( 'gotoDate', m );
					},
					onChangeMonth: function( ct, $i ) {
						var m = moment( ct.getTime() );
						$( fullcalendar ).fullCalendar( 'gotoDate', m );
					}
				} );
				var self = this;
				$( fullcalendar ).fullCalendar( {
					lang: this.lang,
					header: {
						left: '',
						center: 'title',
						right: ''
					},
					eventClick: function( event, jsEvent, view ) {
						$( jsEvent.currentTarget ).addClass( "fc-state-highlight" );
					},
					eventDestroy: function( event, element, view ) {
						console.log( "eventDestroy:", event );
						//self.removeFromEventList( event._id );
						//self.updateEventList();
					},
					eventRender: function( event, element, view ) {
						console.log( "eventRender:", event._id );
					},
					eventAfterRender: function( event, element, view ) {
						console.log( "eventAfter:", event._id );
						event.element = element;
						event.view = view;
						event.startFormated = event.start.format( 'LLL' );
						//self.addToEventList( event );
						self.updateEventList();
					},
					viewRender: function( view, element ) {
						console.log( "view:", view );
						var currentdate = view.intervalStart;
					},
					defaultView: 'agendaWeek',
					editable: true,
					height: 500,
					disableResizing: false,
					eventStartEditable: true,
					eventDurationEditable: true,
					//				droppable: true, // this allows things to be dropped onto the calendar
					selectable: true,
					selectHelper: true,
					select: ( function( start, end ) {
						var title = ""; //prompt( 'Event Title:' );
						var eventData;
						if ( title == "" ) {
							eventData = {
								title: title,
								start: start,
								end: end
							};
							$( fullcalendar ).fullCalendar( 'renderEvent', eventData, true ); // stick? = true
						}
						$( fullcalendar ).fullCalendar( 'unselect' );
					} ).bind( this ),
					drop: function() {
						// is the "remove after drop" checkbox checked?
						if ( $( '#drop-remove' ).is( ':checked' ) ) {
							// if so, remove the element from the "Draggable Events" list
							$( this ).remove();
						}
					}
				} );
			}
		} );

	</script>
</dom-module>
