<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<link rel="import" href="import-js.html">
<dom-module id="simpl-footable" attributes="" ox-filter-changed="{{filterChanged}}" flex relative>
	<template>
		<link rel="stylesheet" type="text/css" href="footable.core.css" />
		<link rel="stylesheet" type="text/css" href="footable.standalone.css" />
		<style shim_shadowdom>
			:host /deep/ #footable_main {
				width: 100%;
			}
		</style>
		<core-signals on-core-signal-filter-changed="{{filterChanged}}"></core-signals>
		<div>
			<!--without this div, footable has no parent width-->
			<table id="footable_main">
				<template if="{{meta != null}}">
					<thead>
						<tr>
							<th template repeat="{{ column in meta }}" data-toggle="{{column.toggle}}" data-hide="{{column.hide}}">
								{{ column.label ? column.label : column.name}}
							</th>
						</tr>
					</thead>
					<tbody>
						<tr template repeat="{{ row in rows }}">
							<template repeat="{{ column in meta }}">

							<template if="{{ column.name !='xhone' }}">
							   <td xata-value="{{row[column.name]}}">{{row[column.name]}}</td>
	            </template>

	            </template>
						</tr>
					</tbody>
				</template>
			</table>
		</div>
		<content></content>
	</template>
	<script>
		Polymer( { is:"simpl-footable",
			data: null,
			meta: null,
			first:true,
			eventDelegates: {
				'filter-changed': 'filterChanged'
			},
			ready: function() {},
			domReady: function() {},
			filterChanged: function( e ) {
				var self = this;
				var data = e.detail;
				$( self.$.footable_main ).hide();
				this.entity = data.entity;
				var first = false;
				if ( this.meta == null ) {
					this.first = true;
					this.meta = this.preProcessMeta( simpl4EntityManager.getEntityViewFields( data.entity, "main-grid", true ) );
				}
				$( this.$.footable_main ).hide();
				this.rows = this.preProcessData(this.getData( e.detail.entity, e.detail.filter ));
			},
			rowsChanged: function() {
				console.debug( "rowsChanged" );
				this.async( function() {
					$( this.$.footable_main ).show();
					if(this.first){
						this.first=false;
						$( this.$.footable_main ).footable();
						var cs = document.querySelector("html /deep/ section.core-selected");
						console.log("cs:",cs);
					//	$(this.$.footable_main).stickyTableHeaders({scrollableArea: cs,xeftOffset:210});
					}
					$( this.$.footable_main ).trigger( 'footable_redraw' );
				}, this, 200 );
			},
			preProcessData: function( rows ) {
				rows.forEach( function( r ) {
					//r.phone = '<a href="tel:'+r.phone+'>'+';
				}, this );
				return rows;
			},
			preProcessMeta: function( fields ) {
				var ret = [];
				fields.forEach( function( f ) {
					if ( f.hidden ) return;
					var col = {
						label: tr( 'data.' + this.entity + '.' + f.name ),
						name: f.name,
						toggle: ret.length == 0 ? true : null,
						hide: f.hide
					}
					ret.push( col );
				}, this );
				return ret;
			},
			getData: function( entity, filter ) {
				var data = simpl4.util.Rpc.rpcSync( "data:query", {
					storeId: "firstapp_data",
					pageSize: 100,
					entity: entity,
					filter: filter
				} );
				return data.rows;
			}
		} );
	</script>
</dom-module>
