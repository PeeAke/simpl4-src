<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<dom-module id="simpl-processes" extends="simpl-datatables" attributes="">
	<style>
		paper-button.ripple {
			float: left;
			position: relative;
		}

	</style>
	<template>

		<neon-animated-pages selected="[[pageSelected]]">
			<neon-animatable style="overflow-x:hidden;padding:3px;position:relative;">
				<template is="dom-if" if="[[currentProcess]]">
					<div style="margin-bottom:30px;text-align:left;" class="layout vertical">
						<paper-button raised class="ripple" on-tap="startProcess">[[getCurrentProcessDescription()]]</paper-button>
					</div>
				</template>
				<simpl-panel bgcolor="[[panelBackgroundColor]]" heading="[[panelHeader]]">
					<div id="dtId" style="overflow:hidden;">
						<table id="dataTablesId" class="dataTables responsive" cellpadding="0" cellspacing="0" border="0" width="100%"></table>
					</div>
				</simpl-panel>
			</neon-animatable>
			<neon-animatable style="position:relative;" unresolved>
				<simpl-processcontroller id="processController"></simpl-processcontroller>
			</neon-animatable>
		</neon-animated-pages>
	</template>

	<script>
		Polymer( {
			is: 'simpl-processes',
			behaviors: [
				DataTablesBehavior,
				TranslationsBehavior
			],
			observers: [
				'selectionChanged(selection)'
			],
			attached: function() {
				this.panelBackgroundColor = 'black';
				this.panelHeader = tr( "tr.menu.process_list" );
				this.dtMeta = null;
				this.pageSelected = 0;
				this.action = tr( "processexplorer.definition.start_workflow" );
				this.currentProcess = null;
				console.log( "attached" );
				this.namespace = "kfzplan"; //@@@MS simpl4.util.BaseManager.getNamespace();
				if ( this.dtMeta == null ) {
					this.dtMeta = this.getMeta();
				}
				this.dataSet = this.getProcessDefinitions();
				this.createTable( this.dtMeta, this.dataSet );
			},
			startProcess: function( e ) {
				this.pageSelected = 1;
				var process = this.selection[ 0 ];
				var self = this;
				this.$.processController.start( process, {}, function() {
					console.log( "finishCallback2" );
					self.pageSelected = 0;
				} );
			},
			selectionChanged: function() {
				this.currentProcess = this.selection[ 0 ].key;
			},
			getCurrentProcessDescription: function() {
				return this.action + ' (' + this.currentProcess + ')';
			},
			getMeta: function() {
				var colHds = [];
				var col = {};
				col.data = "id";
				col.title = "Id";
				colHds.push( col );

				var col = {};
				col.data = "key";
				col.title = tr( "tasks.table.processName" );
				colHds.push( col );

				return colHds;
			},
			getProcessDefinitions: function() {
				var result = null;
				try {
					result = simpl4.util.Rpc.rpcSync( "activiti:getProcessDefinitions", {
						namespace: this.namespace,
						version: -1
					} );
				} catch ( e ) {
					alert( "ProcessDefinitions.getProcessDefinitions:" + e );
					return;
				}
				return result[ "data" ];
			}

		} );

	</script>

</dom-module>
