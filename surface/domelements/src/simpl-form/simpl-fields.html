<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<script>
	FieldBehavior = {
		properties: {
			readonly: {
				value: false,
				type: Boolean
			},
			autofocus: {
				value: true,
				type: Boolean
			},
			disabled: {
				value: false,
				type: Boolean
			},
			label: {
				value: null,
				type: String
			},
			name: {
				value: null,
				type: String
			},
			value: {
				type: String
			},
			defaultValue: {
				value: null,
				type: String
			},
			editValue: {
				value: null,
				type: String
			}
		},
		created: function() {
			console.log( 'FieldBehavior for ', this, 'enabled!' );
		},

		attached: function() {
			this.isDomReady = true;
		},
		detached: function() {
		},
		setForm: function( form ) {
			this.form = form;
		},
		getValue: function() {
			return this.value;
		},
		_focusBlurHandler: function( event ) {
			console.log( "_focusBlurHandler4" );
			var target = event.path ? event.path[ 0 ] : event.target;
			if ( target === this ) {
				var focused = event.type === 'focus';
				this._setFocused( focused );
			} else if ( !this.shadowRoot ) {
				//@@@MS event.stopPropagation();
				this.fire( event.type, {
					sourceEvent: event
				}, {
					node: this,
					bubbles: event.bubbles,
					cancelable: event.cancelable
				} );
			}
		},
		checkConstraints: function() {
			var c = this.getAttribute( "data-constraints" );
			if ( c == null || c.length == 0 ) return;
			var elements = [ this ];
			regula.bind( {
				elements: elements
			} );
			this.async( function() {
				var errorList = regula.validate( {
					elements: elements
				} );
				this.setInvalid( errorList.length > 0 );
				if ( errorList.length > 0 ) {
					this.setErrorMessage( errorList[ 0 ].message );
				}
			} );
		}
	};

</script>

<dom-module id="html-echo" extends="form-field" kind="alert" attributes="html">
	<script>
		Polymer( {
			is: 'html-echo',
			htmlChanged: function() {
				this.innerHTML = this.html;
			}
		} );

	</script>
</dom-module>

<!--PAPERFIELDS-->
<dom-module id="input-field" attributes="min max maxlength pattern step" layout horizontal center>
	<style>
		:host {
			//				min-width: 166px;
			//				margin: 3px 10px 2px 0;
			//				padding: 0 !important;
		}
		:host {
			//min-width:266px !important;
		}
		:host #input.compact {
			padding: 0;
			margin: 0px;
		}
		:host #decorator {
			padding: 0 !important;
		}
		:host #label {
			padding: 0 !important;
			font-size: 14px;
			font-weight: normal;
		}
		:host #input {
			font-size: 14px;
			font-weight: normal;
		}

	</style>
	<template>
		<paper-input-container id="decorator" no-label-float="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" auto-validate$="[[autoValidate]]" disabled$="[[disabled]]" invalid="[[invalid]]">

			<label id="label" hidden$="[[!label]]">[[label]]</label>

      <input is="iron-input" id="input"
        aria-labelledby$="[[_ariaLabelledBy]]"
        aria-describedby$="[[_ariaDescribedBy]]"
        disabled$="[[disabled]]"
        bind-value="{{editValue}}"
        invalid="{{invalid}}"
        prevent-invalid-input="[[preventInvalidInput]]"
        allowed-pattern="[[allowedPattern]]"
        validator="[[validator]]"
        type$="[[type]]"
        pattern$="[[pattern]]"
        maxlength$="[[maxlength]]"
        required$="[[required]]"
        autocomplete$="[[autocomplete]]"
        autofocus$="[[autofocus]]"
        inputmode$="[[inputmode]]"
        minlength$="[[minlength]]"
        min$="[[min]]"
        max$="[[max]]"
        step$="[[step]]"
        name$="[[name]]"
        placeholder$="[[placeholder]]"
        readonly$="[[readonly]]"
        list$="[[list]]"
        size$="[[size]]"
        autocapitalize$="[[autocapitalize]]"
        autocorrect$="[[autocorrect]]">

			<template is="dom-if" if="[[errorMessage]]">
				<paper-input-error>[[errorMessage]]</paper-input-error>
			</template>

			<template is="dom-if" if="[[charCounter]]">
				<paper-input-char-counter></paper-input-char-counter>
			</template>
		</paper-input-container>
	</template>
	<script>
		Polymer( {
			is: "input-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				FieldBehavior
			],

			properties: {
				compact: {
					value: false,
					type: Boolean
				},
				noLabelFloat: {
					type: Boolean,
					computed: "_noLabelFloat(floatingLabel)"
				},
				floatingLabel: {
					value: "true",
					type: String
				},
				text: {
					value: "text",
					type: String
				},
				step: {
					type: String
				},
				max: {
					type: String
				},
				min: {
					type: String
				},
				name: {
					type: String
				}
			},
			hasDate: Modernizr.inputtypes.date,
			observers: [
				'editValueChanged(editValue)',
				'valueChanged(value)',
				'validateAttributes(type)'
			],
			_noLabelFloat: function() {
				return this.floatingLabel === "false" || this.floatingLabel === false;
			},
			ready: function() {
				console.log( "Compact:", this.compact + "/floatingLabel:" + this.floatingLabel + "/label:" + label );
				var self = this;
				Object.keys( this.properties ).forEach( function( key ) {
					var value = self.properties[ key ];
					if ( value === undefined && self[ key ] === undefined ) {
						if ( self.$.input.hasAttribute( key ) ) {
							self.$.input.removeAttribute( key );
						}
					}
				} );
			},
			attached: function() {
				if ( this.label == null || this.label == '' ) this.label = this.name;
				this.validateAttributes();
				this.decorator = this.$.decorator;
				this.input = this.$.input;
				this.validateAttributes();
				if ( this.type == "number" ) {
					this.preventInvalidInput = true;
				}
				var showTime = this.type.match( /^datetime/ ) != null;
				if ( this.type.match( /^date/ ) != null && !this.hasDate ) {
					this.picker = new Pikaday( {
						field: this.$.input,
						trigger: this.$.input,
						onSelect: function( a ) {}.bind( this ),
						i18n: simpl4.util.BaseManager.getLanguage() == 'de' ? this.i18n_de : this.i18n_en,
						format: simpl4.util.BaseManager.getDateFormat() + ( showTime ? " HH:mm" : "" ),
						showTime: showTime,
						showSeconds: false,
						use24hour: simpl4.util.BaseManager.getLanguage() == 'de' ? true : false,
						firstDay: 1,
						//minDate: new Date( '2000-01-01' ),
						//maxDate: new Date( '2020-12-31' ),
						yearRange: [ 1900, 2030 ]
					} );
					this.readonly = true;
					if ( this._date ) {
						this.picker.gotoDate( this._date );
					}
				}
				if ( this.type.match( /^date/ ) && this.hasDate ) {
					this.$.decorator.labelVisible = true;
					//var ldiv = this.$.decorator.querySelector( "paper-input-decorator /deep/ .floated-label" );
					//ldiv.removeAttribute( "invisible" );
					//ldiv.style.fontSize = "0.90em";
				}
				if ( this.compact ) {
					console.log( "Add compact" );
					jQuery( this.decorator ).addClass( "compact" );
					jQuery( this.$.input ).addClass( "compact" );
					if ( is_chromium && this.type != "date" ) {
						jQuery( this.$.input ).css( "margin-top", "0px" );
					}
				}
			},
			i18n_de: {
				previousMonth: 'Vorheriger Monat',
				nextMonth: 'Nächster Monat',
				months: [ 'Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember' ],
				weekdays: [ 'Sontag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag' ],
				weekdaysShort: [ 'So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa' ]
			},
			i18n_en: {
				previousMonth: 'Previous Month',
				nextMonth: 'Next Month',
				months: [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ],
				weekdays: [ 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday' ],
				weekdaysShort: [ 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat' ],
				midnight: 'Midnight',
				noon: 'Noon'
			},
			isAuthorizedType: function() {
				var okTypes = [ 'checkbox', 'color', 'date', 'datetime', 'datetime-local', 'email', 'file', 'month', 'number', 'password', 'radio', 'range', 'tel', 'text', 'time', 'url', 'week' ];
				return ( okTypes.indexOf( this.type ) != -1 );
			},
			lpad: function pad( value, length ) {
				length = length || 2;
				return ( value.toString().length < length ) ? this.lpad( "0" + value, length ) : value;
			},
			validateAttributes: function() {
				if ( !this.input ) {
					return;
				}
				if ( this.type != 'text' && !this.isAuthorizedType() ) {
					this.type = 'text'
				}
				if ( this.type == 'datetime' ) {
					this.input.setAttribute( 'type', "datetime-local" );
				} else {
					this.input.setAttribute( 'type', this.type );
				}
			},
			committedValueChanged: function() { //@@@MS ???
			},
			editValueChanged: function() {
				this.$.input.focus();
				console.log( "editValueChanged:", this.editValue );
				console.log( "type:", this.type );
				if ( this.type == null ) return;
				if ( this.type.match( /^date/ ) && !this.hasDate ) {
					this.value = this._i18nToIso( this.editValue );
				} else {
					this.value = this.editValue;
				}
				if ( this.editValue ) {
					//this.$.decorator.updateLabelVisibility( "X" );
				} else {
					//this.$.decorator.updateLabelVisibility( "" );
				}
				this.fire( 'value-changed', this );
			},
			valueChanged: function() {
				console.log( "valueChanged:", this.value );
				if ( !this.$.decorator ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				this.checkConstraints();
			},
			setValue: function( v ) {
				if ( this.type.match( /^date/ ) ) {
					if ( !this.hasDate ) {
						v = this._convertDate( v );
					} else {
						v = this._toIso( v );
					}
				}
				this.editValue = v;
			},
			getValue: function() {
				if ( this.type.match( /^date/ ) ) {
					if ( typeof this.value === "string" && this.value.match( /[a-zA-Z]/ ) ) {
						return null;
					}
				}
				console.log( "GetValue:", this.value );
				return this.value;
			},
			_convertDate: function( v ) {
				if ( !v ) {
					if ( this.picker ) {
						this.picker.gotoDate( new Date() );
					} else {
						this._date = new Date();
					}
					return null;
				}
				var iso = this._toIso( v );
				this._date = this._isoToDate( iso );
				if ( this.picker ) {
					this.picker.gotoDate( this._date );
					this._date = null;
				}
				return this._isoToI18n( iso );
			},
			_toIso: function( v ) {
				var iso = v;
				var isString = ( typeof v ) === "string";
				if ( isString && !v.match( /[-]/ ) ) {
					var showTime = this.type.match( /^datetime/ ) != null;
					iso = moment( parseInt( v ) ).format( showTime ? "YYYY-MM-DD HH:mm" : "YYYY-MM-DD" );
				}
				return iso;
			},
			_isoToI18n: function( iso ) {
				var mdate = moment( iso );
				var showTime = this.type.match( /^datetime/ ) != null;
				var format = simpl4.util.BaseManager.getDateFormat() + ( showTime ? " HH:mm" : "" );

				var i18n = mdate.format( format );
				return i18n;
			},
			_isoToDate: function( iso ) {
				var mdate = moment( iso );
				return mdate.toDate();
			},
			_i18nToIso: function( i18n ) {
				var iso;
				if ( this.type.match( /^datetime/ ) != null ) {
					var mdate = moment( i18n, simpl4.util.BaseManager.getDateFormat() + " HH:mm" );
					iso = mdate.year() + "-" + this.lpad( ( mdate.month() + 1 ) ) + "-" + this.lpad( mdate.date() ) + "T" + this.lpad( mdate.hour() ) + ":" + this.lpad( mdate.minute() );
				} else {
					var mdate = moment( i18n, simpl4.util.BaseManager.getDateFormat() );
					iso = mdate.year() + "-" + this.lpad( ( mdate.month() + 1 ) ) + "-" + this.lpad( mdate.date() );
				}
				return iso;
			},
			setErrorMessage: function( message ) {
				this.errorMessage = message;
			},
			setInvalid: function( b ) {
				if ( this.decorator == null ) return;
				this.invalid = b;
			},
			setCustomValidity: function( message ) {
				//Dummy,regula want access this
			}
		} );

	</script>
</dom-module>

<dom-module id="multiline-field" extends="form-field" attributes="rows cols maxlength readonly disabled autofocus wrap" kind="multiline-input" layout horizontal center>
	<style>
		:host {
			min-width: 166px;
			margin: 2px 10px 2px 0;
		}
		textarea {
			width: 100%;
		}

	</style>
	<template>
		<paper-input-decorator id="decorator" flex label="{{label}}" floatingLabel>
			<paper-autogrow-textarea>
				<textarea rows="{{rows}}" cols="{{cols}}" maxlength="{{maxlength}}" value="{{editValue}}" id="textarea" warp?={{wrap}} autofocus?={{autofocus}} readonly?={{readonly}} disabled?={{disabled}}></textarea>
			</paper-autogrow-textarea>
		</paper-input-decorator>
	</template>
	<script>
		Polymer( {
			is: "multiline-field",
			behaviors: [ FieldBehavior ],
			properties: {
				autofocus: {
					value: false,
					reflect: true
				},
				warp: {
					value: false,
					reflect: true
				},
				readonly: {
					value: false,
					reflect: true
				},
				disabled: {
					value: false,
					reflect: true
				}
			},
			rows: 3,
			value: "",
			editValueChanged: function() {
				this.value = this.editValue;
				if ( this.editValue ) {
					this.$.decorator.updateLabelVisibility( "X" );
				} else {
					this.$.decorator.updateLabelVisibility( "" );
				}
				this.fire( 'value-changed', this );
			},
			valueChanged: function() {
				if ( !this.$.decorator ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				this.checkConstraints();
			},
			setValue: function( v ) {
				this.editValue = v;
			}
		} );

	</script>
</dom-module>

<dom-module id="checkbox-field" extends="form-field" kind="checkbox">
	<template>
		<style>
			:host {
				padding-left: 5px !important;
			}
			[invalid],
			.error {
				color: #d34336;
			}
			.error-text {
				font-size: 0.75em;
				padding: 0.5em 0;
			}
			.floated-label {
				font-size: 0.75em;
				padding: 1em 0;
				white-space: nowrap;
				color: #757575;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}

		</style>
		<div class="floated-label" invalid?="{{isInvalid}}" invisible?="{{value === undefined}}">
			<span invalid?="{{isInvalid}}" class="label-text">{{label}}</span>
		</div>

		<div horizontal layout>
			<paper-checkbox checked="{{value}}"></paper-checkbox>

			<div class="error" style="margin-left:15px;" layout horizontal hidden?="{{!isInvalid}}">
				<div class="error-text" auto role="alert" aria-hidden="{{!isInvalid}}">{{error}}</div>
				<core-icon class="error-icon" icon="warning"></core-icon>
			</div>
		</div>

	</template>
	<script>
		Polymer( {
			is: "checkbox-field",
			behaviors: [ FieldBehavior ],
			properties: {
				setErrorMessage: function( message ) {
					this.error = message;
				},
				setInvalid: function( b ) {
					this.isInvalid = b;
				},
				valueChanged: function( e ) {
					if ( this.isDomReady != true ) return;
					if ( this.withoutCheck ) {
						this.withoutCheck = false;
						return;
					}
					this.checkConstraints();
				}
			}
		} );

	</script>
</dom-module>


<dom-module id="toggle-field" extends="form-field" kind="toggle" noscript>
	<style>
		.floated-label {
			font-size: 0.75em;
			padding: 1em 0;
			white-space: nowrap;
			color: #757575;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		.container {
			font-size: 0.75em;
			color: #757575;
		}

	</style>
	<template>
		<div class="floated-label" invisibxe?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<paper-toggle-button checked="{{value}}"></paper-toggle-button>
	</template>
</dom-module>


<dom-module id="slider-field" extends="form-field" kind="slider" attributes="minLabel maxLabel" noscript>
	<style>
		.floated-label {
			font-size: 0.75em;
			padding: 1em 0;
			white-space: nowrap;
			color: #757575;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		paper-slider /deep/ #sliderBar {
			box-sizing: initial;
		}
		.container {
			font-size: 0.75em;
			color: #757575;
		}

	</style>
	<template>
		<div class="floated-label" invisible?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<div class="container" layout horizontal center>
			{{minLabel}}
			<paper-slider flex value="{{value}}"></paper-slider>
			{{maxLabel}}
		</div>
	</template>
</dom-module>


<dom-module id="radio-field" extends="form-field" kind="radio-group" noscript>
	<template>
		<style>
			.floated-label {
				font-size: 0.75em;
				padding: 1em 0;
				white-space: nowrap;
				color: #757575;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}
			::content > paper-radio-button {
				font-size: 0.75em;
				padding: 1em;
			}

		</style>
		<div class="floated-label" invisible?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<paper-radio-group selected="{{value}}" layout vertical>
			<content></content>
		</paper-radio-group>
	</template>
</dom-module>


<dom-module id="dropdown-field" extends="form-field" kind="dropdown">
	<template>
		<style>
			:host {
				padding: 0.75em 0;
			}
			:host(.compact) {
				position: relative;
				top: -3px;
				margin: 0;
			}
			.error {
				color: #d34336;
			}
			.error-text {
				font-size: 0.75em;
				padding: 0.5em 0;
			}
			[invisible] {
				visibility: hidden;
			}
			.floated-label {
				font-size: 0.75em;
				white-space: nowrap;
				color: #757575;
			}
			#floatedLabel.compact {
				display: none;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}
			#paperDropdownMenu {
				width: 100%;
				background-color: transparent;
				padding: 0;
			}
			#paperDropdownMenu[invalid] {
				margin: 0;
			}
			#paperDropdownMenu.compact {
				margin: 0;
			}
			paper-dropdown-menu::shadow #dropdown {
				min-width: 100%;
			}
			paper-dropdown-menu {
				margin: 0px;
			}
			:host /deep/ #scroller {
				overflow: auto;
				max-height: 300px;
			}
			::content paper-item /deep/ .button-content {
				padding: 0.35em 1em;
				font-size: 14px;
			}

		</style>

		<div id="floatedLabel" class="floated-label" invisible?="{{value === undefined || value==''}}">
			<span class="label-text">{{label}}</span>
		</div>
		<div vertical layout>
			<paper-dropdown-menu id="paperDropdownMenu" label="{{label}}" invalid?="{{isInvalid}}" selected="{{value}}" valueattr="textContent">
				<paper-dropdown flex class="dropdown">
					<core-menu selected="{{value}}" icon="arrow-drop-down">
						<content></content>
					</core-menu>
				</paper-dropdown>
			</paper-dropdown-menu>

			<div class="error" layout horizontal center hidden?="{{!isInvalid}}">
				<div class="error-text" flex auto role="alert" aria-hidden="{{!isInvalid}}">{{error}}</div>
				<core-icon class="error-icon" icon="warning"></core-icon>
			</div>
		</div>
	</template>
	<script>
		Polymer( {
			is: "dropdown-field",
			behaviors: [ FieldBehavior ],
			properties: {
				compact: {
					value: false,
					reflect: true
				}
			},
			valueChanged: function( e ) {
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				if ( this.isDomReady != true ) return;
				this.checkConstraints();
				this.fire( 'value-changed', this );
			},
			setValue: function( v ) {
				this.value = v;
			},
			setErrorMessage: function( message ) {
				this.error = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			attached: function() {
				this.isDomReady = true;
				if ( this.compact ) {
					jQuery( this.$.floatedLabel ).addClass( "compact" );
					jQuery( this.$.paperDropdownMenu ).addClass( "compact" );
					jQuery( this ).addClass( "compact" );
				}
			}
		} );

	</script>
</dom-module>

<dom-module id="tableselect-field" attributes="multiSelect required meta items height" extends="form-field" kind="tableselect">
	<style>
		.error {
			color: #d34336;
		}
		.error-text {
			font-size: 0.75em;
			padding: 0.5em 0;
		}
		[invisible] {
			visibility: hidden;
		}
		.floated-label {
			font-size: 1.05em;
			white-space: nowrap;
			color: #757575;
			margin-bottom: 10px;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		:host /deep/ .dataTables_wrapper.no-footer .dataTables_scrollBody {
			border-bottom: 0px solid #fc0;
		}
		simpl-datatables /deep/ #dataTablesId thead tr th,
		:host /deep/ #dataTablesId tfoot tr th {
			//background: white;
		}

	</style>
	<template>

		<div id="floatedLabel" hidden?="{{label==null || label==''}}" class="floated-label">
			<span class="label-text">{{label}}</span>
		</div>
		<div vertical layout style="height:{{height}}px;">
			<simpl-datatables flex id="dataTable" invalid?="{{isInvalid}}" selection="{{selection}}" multiSelect?="{{multiSelect}}" selected="{{value}}" options="{{dataTablesOptions}}" meta="{{meta}}" data="{{tableData}}">
			</simpl-datatables>
			<!--hr style="width:100%;color:black;" /-->
			<div class="error" layout horizontal center hidden?="{{!isInvalid}}">
				<div class="error-text" flex auto role="alert" aria-hidden="{{!isInvalid}}"></div>
				<div class="error-text" role="alert" aria-hidden="{{!isInvalid}}">{{error}}&nbsp;&nbsp;</div>
				<core-icon class="error-icon" icon="warning"></core-icon>
			</div>
		</div>
	</template>
	<script>
		Polymer( {
			is: "tableselect-field",
			behaviors: [ FieldBehavior ],
			multiSelect: false,
			required: "",
			checkConstraints: function() {
				this.setInvalid( false );
				if ( !this.isRequired() ) return;
				if ( this.selection && this.selection.length > 0 ) {
					return;
				}
				this.setInvalid( true );
				this.setErrorMessage( tr( "This field is required" ) );
			},
			setValue: function( v ) {
				this.$.dataTable.unselectAll();
				this.value = null;
			},
			setErrorMessage: function( message ) {
				this.error = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			selectionChanged: function() {
				this.value = this.selection;
				this.checkConstraints();
				this.fire( 'value-changed', this );
			},
			heightChanged: function() {
				this.dataTablesOptions = {
					paging: true,
					dom: "rtS",
					//dom: "frtiS",
					scrollCollapse: false,
					scrollY: ( this.height - 40 ) + "px"
				};
				console.log( "dataTablesOptions:" + JSON.stringify( this.dataTablesOptions, null, 2 ) );
				this.tableData = this.items;
			},
			setItems: function( items ) {
				this.tableData = items;
			},
			isRequired: function() {
				var data = this.form.getData();
				var req = this.form._maskedEval( this.required, data, false );
				return req;
			},
			ready: function() {
				this.isDomReady = true;
			}
		} );

	</script>
</dom-module>

<dom-module id="related-field">
	<style>
		:host /deep/ #relatedDialog {
			top: 5vh;
			min-width: 70%;
			max-width: 70%;
			border-radius:4px;
		}
		@media screen and (max-width: 767px) {
			:host /deep/ #relatedDialog {
				left: 0vw;
				min-width: 100%;
				margin: 0px;
			}
		}
		:host /deep/ paper-dialog > *:last-child {
			margin-bottom: 4px;
		}
		:host /deep/ paper-dialog > *:first-child {
			margin-top: 14px;
		}
		:host /deep/ paper-dialog#relatedDialog {
			padding: 0px 0px 0 0px;
		}
		:host /deep/ .button-content {
			padding: 0.2em 0.27em;
		}
		paper-button {
			min-width: 0px;
		}
		:host /deep/ #scrollable {
			max-height: inherit !important;
  		padding: 0 10px;
		}

	</style>
	<template>

		<div class="layout horizontal center">
			<paper-input-container class="flex" id="decorator" label="{{label}}" floatingLabel?="{{floatingLabel}}" value="{{value}}" readonly disabled$="{{disabled}}">
				<input is="iron-input" id="input" value="{{editValue}}" on-change="changeAction" readonly disabled$={{disabled}}>
			</paper-input-container>
			<paper-button on-tap="actionCallback" class="button" raised>
				<iron-icon icon="launch"></iron-icon>
			</paper-button>
			<template is="dom-if" if="{{isMetaNull()}}">
				<paper-button on-tap="clearCallback" class="button" raised>
					<iron-icon icon="clear"></iron-icon>
				</paper-button>
			</template>
		</div>

		<paper-dialog id="relatedDialog" with-backdrop="">
			<paper-dialog-scrollable>
				<div class="lyaout vertical flex">
					<simpl-filter style="margin-bottom:10px;" namespace="{{namespace}}" entity="{{entity}}" filter="{{filter}}"></simpl-filter>
					<div style="height:20px;"></div>
					<template is="dom-if" if="{{isFilter(filter)}}">
						<simpl-panel bgcolor="black" heading="{{'data.'+entityName|tr}}" collapsable="">
							<simpl-crudtable namespace="{{namespace}}" buttons="select,cancel" on-select-action="selectAction" on-cancel-action="cancelAction" meta="{{meta}}" filter="{{filter}}"></simpl-crudtable>
						</simpl-panel>
					</template>
				</div>
			</paper-dialog-scrollable>
			<!--div class="buttons">
				<paper-button dialog-dismiss="">Cancel</paper-button>
				<paper-button dialog-confirm="">Accept</paper-button>
			</div-->
		</paper-dialog>

	</template>
	<script>
		Polymer( {
			is: "related-field",
			behaviors: [ FieldBehavior ],
			properties: {
				namespace: {
					type: String
				},
				entity: {
					type: String
				},
				entity: {
					type: String
				}
			},
			id: null,
			isMetaNull: function() {
				return this.meta == null;
			},
			isFilter: function( filter ) {
				console.log( "isFilter:", ( this.filter != null ) );
				return this.filter != null;
			},
			ready: function() {
				this.props = simpl4.util.EntityManager.getPropertiesForEntity( this.entity, {
					namespace: this.namespace
				} );
				console.log( "props:", this.props );
			},
			actionCallback: function() {
				console.log( "actionCallback" );
				this.$.relatedDialog.open();
				this.setDimensions();
			},
			clearCallback: function() {
				this.editValue = null;
				this.id = null;
			},
			selectAction: function( e ) {
				var data = e.detail.data;
				this.$.relatedDialog.close();
				var t = this._maskedEval( this.props.title_expression, data );
				this.id = data.id;
				this.editValue = t;
			},
			cancelAction: function() {
				this.$.relatedDialog.close();
			},
			setDimensions: function() {
				$( this.$.relatedDialog ).css( "top", "0vw" );
				$( this.$.relatedDialog ).css( "max-width", "70%" );
				$( this.$.relatedDialog ).css( "min-width", "70%" );
				if ( window.matchMedia( "(max-width:768px)" ).matches ) {
					$( this.$.relatedDialog ).css( "min-width", "100%" );
					$( this.$.relatedDialog ).css( "max-width", "100%" );
					$( this.$.relatedDialog ).css( "left", "0vw" );
					$( this.$.relatedDialog ).css( "margin", "0" );
				}
			},
			editValueChanged: function() {
				if ( this.editValue ) {
					this.value = this.editValue + "/" + this.id;
					this.$.decorator.updateLabelVisibility( "X" );
				} else {
					this.$.decorator.updateLabelVisibility( "" );
					this.value = null;
				}
				this.fire( 'value-changed', this );
			},
			setValue: function( v ) {
				if ( v != null ) {
					var s = v.split( "/" );
					this.editValue = s[ 0 ];
					this.id = s[ 1 ];
				} else {
					this.editValue = null;
				}
				console.log( "related:", this.editValue );
				console.log( "id:", this.id );
			},
			namespaceChanged: function() {
				simpl4.util.MessageManager.installMessages( this.namespace );
			},
			entityChanged: function() {
				this.entityName = this.entity;
			},
			_maskedEval: function( scr, env, def ) {
				try {
					return ( new Function( "with(this) { return " + scr + "}" ) ).call( env );
				} catch ( e ) {
					console.log( "RelatedField._maskedEval:" + scr );
					console.error( "error:" + e );
				}
				return def;
			}
		} );

	</script>
</dom-module>

<dom-module id="db-selector-field" extends="related-field" kind="db-selector" attributes="namespace entity fieldlist readonly disabled autofocus label name" layout horizontal center>
	<template>
		<shadow></shadow>
	</template>
	<script>
		Polymer( {
			is: 'db-selector-field',
			behaviors: [ FieldBehavior ],
			selectAction: function( e ) {
				var data = e.detail.data;
				this.$.relatedDialog.close();
				this.assignValues( data );
			},
			assignValues: function( cr ) {
				var items = JSON.parse( this.fieldlist ).items;
				for ( var i = 0; i < items.length; i++ ) {
					var fmap = items[ i ];
					var path = fmap.path + "." + fmap.id;
					var value = cr[ path ];
					if ( value == undefined ) value = null;
					var form_fieldname = fmap.form_fieldname ? fmap.form_fieldname : fmap.db_fieldname;
					console.debug( "db-selector-field.assignValue(" + path + "):" + form_fieldname + "=" + value );
					try {
						var f = this.form.getField( form_fieldname );
						if ( f == null ) {
							console.error( "db-selector-field.assignValue:field:" + form_fieldname + " not found" );
							continue;
						}
						f.setValue( value );
					} catch ( e ) {
						console.error( "db-selector-field.Cannot set value:" + e + "/" + e.stack );
					}
				}
			},
			getFieldDesc: function( entity, id ) {
				var colModel = this.fieldmap[ entity ];
				if ( colModel == null ) {
					this.getSelectableFields( entity );
					colModel = this.fieldmap[ entity ];
				}
				for ( var f = 0; f < colModel.length; f++ ) {
					var field = colModel[ f ];
					if ( field.hidden ) continue;
					if ( field.id == id ) {
						return field;
					}
				}
				return null;
			},
			getSelectableFields: function( entity ) {
				var colModel = this.fieldmap[ entity ];
				if ( colModel === undefined ) {
					try {
						var em = simpl4.util.EntityManager;
						var data = em.getEntityViewFields( entity, this.namespace, "report", false );
						colModel = em.buildColModel( data, this.namespace, entity, "search" );
						this.fieldmap[ entity ] = colModel;
					} catch ( e ) {
						console.error( "db-selector-field.getSelectableFields:" + e.stack );
						return;
					}
				}
				return colModel;
			},
			fieldlistChanged: function() {
				simpl4.util.MessageManager.installMessages( this.namespace );
				this.fieldmap = {};
				var columns = new Array();
				var displayColumns = new Array();
				var aliasColumns = new Array();
				var selFields = JSON.parse( this.fieldlist ).items;
				for ( var f = 0; f < selFields.length; f++ ) {
					var selField = selFields[ f ];

					if ( selField.display === true ) {
						var fieldDesc = this.getFieldDesc( selField.module, selField.id );
						if ( fieldDesc == null ) {
							console.error( "db-selector-field.fieldlistChanged:field(\"" + selField.id + "\") not found in \"" + selField.module + "\"" );
							return null;
						}
						var dt = fieldDesc[ "datatype" ];
						if ( dt && dt.match( "^array" ) ) {
							continue;
						}
						var fd = simpl4.util.Merge.deepmerge( {}, fieldDesc );
						fd.fqn = selField.path + "." + selField.id;
						fd.label = tr( "data." + simpl4.util.Inflector.getEntityName( selField.module ) ) + "/" + tr( "data." + selField.module + "." + selField.id );
						fd.title = fd.label;
						displayColumns.push( fd.fqn );
						aliasColumns.push( selField.mapping );
						fd[ "id" ] = fd.fqn;
						fd[ "name" ] = fd.fqn;
						columns.push( fd );
					}
				}
				this.meta = columns;
			}
		} );

	</script>
</dom-module>
