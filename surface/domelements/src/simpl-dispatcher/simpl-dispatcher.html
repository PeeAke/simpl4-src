<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<dom-module id="simpl-dispatcher" flex relative>
	<style shim-shadowdom>
		div {
			width: 100%;
			height: 100%;
			display: block;
		}

	</style>
	<template>
		<div id="main" />
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-dispatcher',
			properties: {
				selected: {
					observer: "selectedChanged",
					type: String
				}
			},
			ready: function() {
				this.pages = simpl4PageRegistry.getPages();
				console.log( "dispatcher.Ready:" + this.selected );
				if ( this.selected ) {
					var node = this.getNodeByHash( this.selected );
					if ( node ) {
						this.selectedModel = {
							node: node
						};
						this.fire( "mmenu-selected", {
							isSelected: true,
							model: this.selectedModel
						} );
					}
				}
			},
			attached: function() {
				this.async( function() {
					this._attached();
				} );
			},
			_attached: function() {
				console.log( "dispatcher._attached:" + this.selected );
				this.mainMenuElement = Polymer.dom( document.querySelectorAll( this.shadowRoot ? "html /deep/ simpl-mmenu" : "simpl-mmenu" )[ 0 ].root );
				var aList = this.mainMenuElement.querySelectorAll( "a" );
				for ( var i = 0; i < aList.length; i++ ) {
					var a = aList[ i ];
					if ( a[ "className" ] != "mm-subopen" ) {
						$( a ).tap( this.activateListener.bind( this ), false );
					}
				}
				if ( this.selected ) {
					var self = this;
					setTimeout( function() {
						self.openMenuByHash( self.mainMenuElement, self.selected );
					}, 300 );
				}
			},
			activateListener: function( e ) {
				if ( e.target[ "className" ] == "mm-subopen" ) {
					return;
				}
				var model = {};
				model.node = e.target.node;
				console.log( "activateListener.model:", model.node );
				if ( !model.node ) return;
				var node = model.node;
				if ( this.selectedModel ) {
					this.fire( "mmenu-selected", {
						isSelected: false,
						model: this.selectedModel
					} );
				}
				this.selectedModel = model;
				this.fire( "mmenu-selected", {
					isSelected: true,
					model: this.selectedModel
				} );
				this.selected = node.hash;
				console.log( "activateListener:" + node.hash );
			},
			getNodeByHash: function( hash ) {
				for ( var i = 0; i < this.pages.length; i++ ) {
					if ( this.pages[ i ].hash == hash ) {
						return this.pages[ i ];
					}
				}
			},
			openMenuByHash: function( mainelem, hash ) {
				console.log( "openMenuByHash:" + hash );
				if ( mainelem == null ) return;
				var li = $( mainelem.querySelector( '#x' + hash ) );
				var pli = li.parents( "li" );
				pli.each( function() {
					if ( !$( this ).hasClass( "mm-opened" ) ) {
						$( this ).find( "a" ).first().trigger( "click" );
					}
				} )
				li.trigger( "setSelected", true );
			},
			selectedChanged: function( e ) {
				//console.log( "Dispatcher.selectedChanged:" + this.selectedModel );
				if ( this.selectedModel == null || this.selected != this.selectedModel.node.hash ) {
					var node = this.getNodeByHash( this.selected );
					if ( node ) {
						this.selectedModel = {
							node: node
						};
						this.fire( "mmenu-selected", {
							isSelected: true,
							model: this.selectedModel
						} );
					}
				}
				this.openMenuByHash( this.mainMenuElement, this.selected );
			}
		} );

	</script>
</dom-module>
