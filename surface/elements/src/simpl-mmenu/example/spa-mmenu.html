<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=no">
	<title>Single page app using Polymer</title>
	<script src="/sw/surface/libs.js.gz"></script>
	<link rel="stylesheet" href="font-awesome.css" />

	<link rel="import" href="/sw/surface/elements.html.gz">
	<link rel="stylesheet" type="text/css" href="/sw/surface/libs.css.gz" shim-shadowdom>
	<link rel="stylesheet" type="text/css" href="ac.css" shim-shadowdom>

	<style shim-shadowdom>
		core-animated-pages > * {
			font-size: inherit;
			overflow-y: auto;
			border-radius: 5px;
			background-color: whitesmoke;
		}
		core-animated-pages {
			width: 99%;
			height: 99%;
			overflow: hidden;
		}
		body /deep/ core-toolbar {
			background-color: #03a9f4;
			color: #fff;
		}
		@media all and (max-width: 480px) {
			core-animated-pages {
				width: 100%;
				height: 100%;
			}
		}
		section {
			padding: 15px;
			width: 100%;
			height: 100%;
		}
		section> div {
			width: 100%;
			height: 100%;
		}
		@media all and (max-width: 480px) {
			html /deep/ #dialog {
				top: 10vh;
				left: 0vw;
			}
		}
		html /deep/ #login {
			background: white !important;
			color: gray;
		}
		html /deep/ #scroller {
			position: relative !important;
		}
	</style>
</head>


<body unresolved fullbleed>

	<simpl-globals id="globals"></simpl-globals>
	<template is="auto-binding" id="t">
		<simpl-dispatcher on-mmenu-selected="{{menuItemSelected}}" selected="{{route}}" selectedModel="{{selectedModel}}" pages="{{ pages }}"></simpl-dispatcher>

		<!-- Route controller. -->
		<flatiron-director route="{{route}}" autoHash></flatiron-director>

		<!-- Keyboard nav controller. -->
		<!--core-a11y-keys id="keys" target="{{parentElement}}" keys="up down left right space space+shift" on-keys-pressed="{{keyHandler}}"></core-a11y-keys-->

		<!-- Dynamic content controller -->
		<core-ajax id="ajax" url="{{selectedModel.node.url}}" handleAs="document" on-core-response="{{onResponse}}"></core-ajax>

		<core-scaffold responsiveWidth="700px" id="scaffold">
			<nav>
				<core-toolbar>
					<span>Polymer Tutorial SPA</span>
				</core-toolbar>
				<simpl-mmenu slidingSubmenus="false" searchfield="true" pages="{{ pages }}" fit/>
			</nav>

			<core-toolbar tool flex>
				<div flex>{{selectedModel.node.name}}</div>
				<core-icon-button icon="refresh"></core-icon-button>
				<core-icon-button on-click="{{login}}" icon="add"></core-icon-button>
			</core-toolbar>

			<div layout horizontal center-center fit>
				<core-animated-pages id="pages" selected="{{route}}" valueattr="hash" transitions="scale-up" fit>
					<template repeat="{{page, i in pages}}">
						<section hash="{{page.hash}}" layout vertical center-center>
							<div scale-up="">
								<div style="max-width:100%;">Loading...{{page.name}}</div>
							</div>
						</section>
					</template>
				</core-animated-pages>
			</div>

		</core-scaffold>

		<paper-dialog id="dialog">
			<simpl-login id="login"></simpl-login>
		</paper-dialog>
	</template>

	<script>
		window.addEventListener('polymer-ready', function(e) {
			/*this.globals = document.querySelector("#globals");
			var start = new Date().getTime();
			this.globals.getForm("tutorials", "test.form").then(function(d) {
				console.log("Time:"+(new Date().getTime() - start));
				console.debug("Globals:", d);
			}, function(d) {
				console.error("Error2:", d.error.message);
			});*/
		});


		(function() {
			"use strict";

			var DEFAULT_ROUTE = '0';

			var cache = {};
			console.debug("Cache is emoy");
			var template = document.querySelector('#t');
			var ajax, pages, scaffold;
			template.addEventListener('template-bound', function(e) {
				scaffold = document.querySelector('#scaffold');
				ajax = document.querySelector('#ajax');
				pages = document.querySelector('#pages');
				var keys = document.querySelector('#keys');

				// Allow selecting pages by num keypad. 
				var keysToAdd = Array.apply(null, template.pages).map(function(x, i) {
					return i + 1;
				}).reduce(function(x, y) {
					return x + ' ' + y;
				});
				if (keys) {
					keys.keys += ' ' + keysToAdd;
				}

				console.log("location:" + window.location);
				this.route = this.route || DEFAULT_ROUTE; // Select initial route.
			});

			template.keyHandler = function(e, detail, sender) {
				var num = parseInt(detail.key);
				if (!isNaN(num) && num <= this.pages.length) {
					pages.selectIndex(num - 1);
					return;
				}

				switch (detail.key) {
					case 'left':
					case 'up':
						pages.selectPrevious();
						break;
					case 'right':
					case 'down':
						pages.selectNext();
						break;
					case 'space':
						detail.shift ? pages.selectPrevious() : pages.selectNext();
						break;
				}
			};

			template.menuItemSelected = function(e, detail, sender) {
				if (detail.isSelected && detail.model.node && detail.model.node.url) {
					this.async(function() {
						if (!cache[ajax.url]) {
							ajax.go();
						}
						scaffold.closeDrawer();
					});
				}
			};

			template.onResponse = function(e, detail, sender) {
				var article = detail.response.body;

				console.log("Route:" + this.route + "/" + pages.selectedItem);
				// Fix up image paths to not be local.
				[].forEach.call(article.querySelectorAll('img'), function(img) {
					img.setAttribute('src', img.src);
				});

				var html = article.innerHTML;
				cache[ajax.url] = html;
				this.injectBoundHTML(html, pages.selectedItem.firstElementChild);
				var codes = pages.selectedItem.firstElementChild.getElementsByTagName("script");
				for (var i = 0; i < codes.length; i++) {
					eval(codes[i].text);
				}
			};

			var scope = document.querySelector('template[is=auto-binding]');
			scope.login = function(e) {
				scope.$.dialog.toggle();
			};

		})();
	</script>
</body>

</html>
