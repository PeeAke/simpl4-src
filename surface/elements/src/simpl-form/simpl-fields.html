<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<script>
	modularize( 'form-field', function() {
		return {
			kinds: [],
			register: function( polymerElement ) {
				var kind = polymerElement.getAttribute( 'kind' );
				if ( kind ) {
					this.kinds.push( kind );
					polymerElement.removeAttribute( 'kind' );
				}
			}
		};
	} );
</script>

<polymer-element name="form-field" attributes="label compact name value meta editValue" field>
	<template>
		<style shim-shadowdom>
			:host {
				min-width: 166px;
				margin: 3px 10px 2px 0;
				padding: 0 !important;
			}
			:host /deep/ #input.compact {
				padding: 0;
				margin: 0px;
			}
			:host /deep/ paper-input-decorator {
				padding: 0 !important;
			}
		</style>
	</template>
	<script>
		Polymer( {
			registerCallback: function( polymerElement ) {
				using( 'form-field', function( df ) {
					df.register( polymerElement );
				} );
			},
			attached: function() {
				this.fire( 'add-form-field', this );
				console.debug( "attached:", this );
			},
			detached: function() {
				this.fire( 'remove-form-field', this );
				console.debug( "detach:", this );
			}
		} );
	</script>
</polymer-element>

<!--PAPERFIELDS-->
<polymer-element name="input-field" extends="form-field" attributes="preventInvalidInput floatingLabel min max maxlength pattern step readonly disabled autofocus type label name" kind="input" layout horizontal center>
	<template>
		<paper-input-decorator flex id="decorator" label="{{label}}" invisible?="{{invisible}}" floatingLabel?="{{floatingLabel}}" value="{{value}}" readonly?="{{readonly}}" disabled?="{{disabled}}">
			<input is="core-input" id="input" value="{{editValue}}" min="{{min}}" max="{{max}}" step="{{step}}" maxlength={{maxlength}} pattern="{{pattern}}" committedValue="{{committedValue}}" on-change="{{changeAction}}" autofocus?={{autofocus}} readonly?={{readonly}} preventInvalidInput?={{preventInvalidInput}} disabled?={{disabled}}>
		</paper-input-decorator>
	</template>
	<script>
		Polymer( {
			publish: {
				compact: {
					value: false,
					reflect: true
				},
				autofocus: {
					value: false,
					reflect: true
				},
				preventInvalidInput: {
					value: false,
					reflect: true
				},
				readonly: {
					value: false,
					reflect: true
				},
				disabled: {
					value: false,
					reflect: true
				}
			},
			type: "text",
			value: "",
			floatingLabel: true,
			hasDate: Modernizr.inputtypes.date,
			observe: {
				type: 'validateAttributes',
			},
			ready: function() {
				var self = this;
				Object.keys( this.publish ).forEach( function( key ) {
					var value = self.publish[ key ];
					if ( value === undefined && self[ key ] === undefined ) {
						if ( self.$.input.hasAttribute( key ) ) {
							self.$.input.removeAttribute( key );
						}
					}
				} );
			},
			domReady: function() {
				if ( this.label == null || this.label == '' ) this.label = this.name;
				this.validateAttributes();
				this.decorator = this.$.decorator;
				this.input = this.$.input;
				this.validateAttributes();
				if ( this.type == "number" ) {
					this.preventInvalidInput = true;
				}
				var showTime = this.type.match( /^datetime/ ) != null;
				console.log( "input-field:" + this.label + "/" + this.type );
				if ( this.type.match( /^date/ ) != null && !this.hasDate ) {
					var picker = new Pikaday( {
						field: this.$.input,
						trigger: this.$.input,
						onSelect: function( a ) {}.bind( this ),
						i18n: simpl4.util.BaseManager.getLanguage() == 'de' ? this.i18n : null,
						format: simpl4.util.BaseManager.getDateFormat() + ( showTime ? " HH:mm" : "" ),
						showTime: showTime,
						showSeconds: false,
						use24hour: simpl4.util.BaseManager.getLanguage() == 'de' ? true : false,
						firstDay: 1,
						minDate: new Date( '2000-01-01' ),
						maxDate: new Date( '2020-12-31' ),
						yearRange: [ 2000, 2020 ]
					} );
					this.readonly = true;
				}
				if ( this.type.match( /^date/ ) && this.hasDate ) {
					this.$.decorator.labelVisible = true;
					var ldiv = this.$.decorator.querySelector( "paper-input-decorator /deep/ .floated-label" );
					ldiv.removeAttribute( "invisible" );
					ldiv.style.fontSize = "0.90em";
				}
				if ( this.compact ) {
					jQuery( this.decorator ).addClass( "compact" );
					jQuery( this.$.input ).addClass( "compact" );
					if ( is_chromium && this.type != "date" ) {
						jQuery( this.$.input ).css( "margin-top", "4px" );
					}
				}
			},
			i18n: {
				previousMonth: 'Vorheriger Monat',
				nextMonth: 'Nächster Monat',
				months: [ 'Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember' ],
				weekdays: [ 'Sontag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag' ],
				weekdaysShort: [ 'So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa' ]
			},
			isAuthorizedType: function() {
				var okTypes = [ 'checkbox', 'color', 'date', 'datetime', 'datetime-local', 'email', 'file', 'month', 'number', 'password', 'radio', 'range', 'tel', 'text', 'time', 'url', 'week' ];
				return ( okTypes.indexOf( this.type ) != -1 );
			},
			lpad: function pad( value, length ) {
				length = length || 2;
				return ( value.toString().length < length ) ? this.lpad( "0" + value, length ) : value;
			},
			validateAttributes: function() {
				if ( !this.input ) {
					return;
				}
				if ( this.type != 'text' && !this.isAuthorizedType() ) {
					this.type = 'text'
				}
				if ( this.type == 'datetime' ) {
					this.input.setAttribute( 'type', "datetime-local" );
				} else {
					this.input.setAttribute( 'type', this.type );
				}
			},
			committedValueChanged: function() {
				console.log( "committedValueChanged(" + this.name + "):" + this.value + "/" + this.committedValue );
			},
			editValueChanged: function() {
				console.log( "editValueChanged(" + this.name + "):" + this.value + "/" + this.editValue );
				if ( this.type == "date" && !this.hasDate ) {
					var mdate = moment( this.editValue, simpl4.util.BaseManager.getDateFormat() );
					this.value = mdate.year() + "-" + this.lpad( ( mdate.month() + 1 ) ) + "-" + this.lpad( mdate.date() );
				} else if ( this.type.match( /^datetime/ ) != null && !this.hasDate ) {
					var mdate = moment( this.editValue, simpl4.util.BaseManager.getDateFormat() + " HH:mm" );
					this.value = mdate.year() + "-" + this.lpad( ( mdate.month() + 1 ) ) + "-" + this.lpad( mdate.date() ) + "T" + this.lpad( mdate.hour() ) + ":" + this.lpad( mdate.minute() );
				} else {
					this.value = this.editValue;
				}
				console.log( "value:" + this.value );
			},
			valueChanged: function() {
				if ( !this.$.decorator ) return;
				//				if( regula.isBound(
				/*var cvList = regula.validate( {
					elements: [ this ],
					groups: [ regula.Group.MyGroup ]
				} );
				console.debug( "valueChanged(" + this.name + "," + this.$.input.value + "," + this.value + "):" + cvList.length );
				this.decorator.isInvalid = cvList.length > 0;
				if ( cvList.length > 0 ) {
					this.decorator.error = cvList[ 0 ].message;
				}*/
			},
			setErrorMessage:function(message){
				console.log("setErrorMessage:"+message);
				this.decorator.error = message;
			},
			setInvalid:function(b){
				this.decorator.isInvalid = b;
			},
			setCustomValidity: function( message ) {
				console.debug( "setCustomValidity:" + message );
			}
		} );
	</script>
</polymer-element>

<polymer-element name="multiline-field" extends="form-field" attributes="rows cols maxlength readonly disabled autofocus wrap" kind="multiline-input" layout horizontal center>
	<template>
		<style>
			:host {
				min-width: 166px;
				margin: 2px 10px 2px 0;
			}
			textarea {
				width: 100%;
			}
		</style>
		<paper-input-decorator flex label="{{label}}" floatingLabel>
			<paper-autogrow-textarea>
				<textarea rows="{{rows}}" cols="{{cols}}" maxlength="{{maxlength}}" value="{{editValue}}" id="textarea" warp?={{wrap}} autofocus?={{autofocus}} readonly?={{readonly}} disabled?={{disabled}}></textarea>
			</paper-autogrow-textarea>
		</paper-input-decorator>
	</template>
	<script>
		Polymer( {
			publish: {
				autofocus: {
					value: false,
					reflect: true
				},
				warp: {
					value: false,
					reflect: true
				},
				readonly: {
					value: false,
					reflect: true
				},
				disabled: {
					value: false,
					reflect: true
				}
			},
			rows: 3,
			value: "",
			editValueChanged: function() {
				this.value = this.editValue;
			}
		} );
	</script>
</polymer-element>

<polymer-element name="checkbox-field" extends="form-field" kind="checkbox" noscript>
	<template>
		<style>
			.floated-label {
				font-size: 0.75em;
				padding: 1em 0;
				white-space: nowrap;
				color: #757575;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}
			.container {
				font-size: 0.75em;
				color: #757575;
			}
		</style>
		<div class="floated-label" invisible?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<paper-checkbox checked="{{value}}"></paper-checked>
	</template>
</polymer-element>


<polymer-element name="toggle-field" extends="form-field" kind="toggle" noscript>
	<template>
		<style>
			.floated-label {
				font-size: 0.75em;
				padding: 1em 0;
				white-space: nowrap;
				color: #757575;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}
			.container {
				font-size: 0.75em;
				color: #757575;
			}
		</style>
		<div class="floated-label" invisibxe?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<paper-toggle-button checked="{{value}}"></paper-toggle-button>
	</template>
</polymer-element>


<polymer-element name="slider-field" extends="form-field" kind="slider" attributes="minLabel maxLabel" noscript>
	<template>
		<style>
			.floated-label {
				font-size: 0.75em;
				padding: 1em 0;
				white-space: nowrap;
				color: #757575;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}
			paper-slider /deep/ #sliderBar {
				box-sizing: initial;
			}
			.container {
				font-size: 0.75em;
				color: #757575;
			}
		</style>
		<div class="floated-label" invisible?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<div class="container" layout horizontal center>
			{{minLabel}}
			<paper-slider flex value="{{value}}"></paper-slider>
			{{maxLabel}}
		</div>
	</template>
</polymer-element>


<polymer-element name="radio-field" extends="form-field" kind="radio-group" noscript>
	<template>
		<style>
			.floated-label {
				font-size: 0.75em;
				padding: 1em 0;
				white-space: nowrap;
				color: #757575;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}
			::content > paper-radio-button {
				font-size: 0.75em;
				padding: 1em;
			}
		</style>
		<div class="floated-label" invisible?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<paper-radio-group selected="{{value}}" layout vertical>
			<content></content>
		</paper-radio-group>
	</template>
</polymer-element>


<polymer-element name="dropdown-field" extends="form-field" kind="dropdown" noscript>
	<template>
		<style>
			:host {
				padding: 0.75em 0;
			}
			[invisible] {
				visibility: hidden;
			}
			.floated-label {
				font-size: 0.75em;
				white-space: nowrap;
				color: #757575;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}
			paper-dropdown-menu {
				width: 100%;
				background-color: transparent;
				padding: 0;
			}
			paper-dropdown-menu::shadow #dropdown {
				min-width: 100%;
			}
		</style>
		<div class="floated-label" invisible?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<paper-dropdown-menu label="{{label}}" selected="{{value}}" valueattr="textContent">
			<paper-dropdown class="dropdown">
				<core-menu selected="{{value}}" icon="arrow-drop-down">
					<content></content>
				</core-menu>
			</paper-dropdown>
		</paper-dropdown-menu>
	</template>
</polymer-element>


<polymer-element name="ssn-field" extends="form-field" kind="ssn" layout horizontal center on-keypress="{{keyPress}}">
	<template>
		<style>
			paper-input {
				margin-right: 4px;
			}
			[two-digits] {
				width: 1.5em;
			}
			[three-digits] {
				width: 2em;
			}
			[four-digits] {
				width: 2.5em;
			}
			span {
				margin-right: 12px;
			}
		</style>
		<span>{{name}}</span>
		<paper-input three-digits value="{{partA}}"></paper-input> -
		<paper-input two-digits value="{{partB}}"></paper-input> -
		<paper-input four-digits value="{{partC}}"></paper-input>
	</template>
	<script>
		Polymer( {
			computed: {
				value: 'concat(partA, partB, partC)'
			},
			concat: function( a, b, c ) {
				return a + '-' + b + '-' + c;
			},
			keyPress: function( e ) {
				var c = String.fromCharCode( e.charCode );
				if ( !c.match( /\d/ ) ) {
					e.preventDefault();
				}
			}
		} );
	</script>
</polymer-element>
