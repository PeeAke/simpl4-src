<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-main" attributes="mmenuClasses toolbarBackground mmenuBackground logo logoBackground">
	<template>
		<core-style ref="main"></core-style>

		<style>
			core-animated-pages > * {
				font-size: inherit;
				overflow-y: auto;
				border-radius: 5px;
				background-color: white;
			}
			core-animated-pages {
				width: 100%;
				height: 100%;
				overflow: hidden;
			}
			@media all and (max-width: 480px) {
				core-animated-pages {
					width: 100%;
					height: 100%;
				}
			}
			section.main {
				padding: 6px;
				width: 100%;
				height: 100%;
			}
			section> div {
				width: 100%;
				height: 100%;
			}
			@media all and (max-width: 480px) {
				html /deep/ #loginDialog {
					top: 10vh;
					left: 0vw;
				}
			}
			[drawer] {
				box-shadow: 1px 0 1px rgba(0, 0, 0, 0.1);
			}
			[main] {
				height: 100%;
			}
			#drawerPanel:not([narrow]) #menuButton {
				display: none;
			}
			:host /deep/ paper-button {
				min-width: 3em !important;
			}
			:host /deep/ div.button-content {
				overflow: hidden;
				font-size: 10px;
			}
			:host /deep/ select {
				padding: 3px;
				margin: 2px;
				-webkit-border-radius: 4px;
				-moz-border-radius: 4px;
				border-radius: 3px;
				-webkit-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
				-moz-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
				box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
				background: #ffffff;
				color: #888;
				border: none;
				outline: none;
				display: inline-block;
				//-webkit-appearance: none;
				//-moz-appearance: none;
				//appearance: none;
				cursor: pointer;
			}

		</style>
		<simpl-globals globals="{{globals}}" id="globals"></simpl-globals>
		<simpl-dispatcher on-mmenu-selected="{{menuItemSelected}}" selected="{{route}}" selectedModel="{{selectedModel}}" pages="{{ pages }}"></simpl-dispatcher>

		<!-- Route controller. -->
		<flatiron-director route="{{route}}" autoHash></flatiron-director>

		<!-- Keyboard nav controller. -->
		<!--core-a11y-keys id="keys" target="{{parentElement}}" keys="up down left right space space+shift" on-keys-pressed="{{keyHandler}}"></core-a11y-keys-->

		<!-- Dynamic content controller -->
		<core-ajax id="ajax" url="{{selectedModel.node.url}}" handleAs="document" on-core-response="{{onResponse}}"></core-ajax>

		<core-drawer-panel id="drawerPanel" drawerWidth="230px" rightDrawer="false" responsiveWidth="700px" disableSwipe="false">
			<div vertical layout drawer>
				<nav layout vertical fit style="background:{{logoBackground}};">
					<div>
						<img id="logo" src='{{logo}}' style="max-width:220px;padding-left:5px;padding-top:3px;padding-bottom:3px;border-width: 0px; border-style: solid;" />
					</div>
					<simpl-mmenu name="menu" globals="{{globals}}" background="{{mmenuBackground}}" classes="{{mmenuClasses}}" slidingSubmenus="false" searchfield="true" pages="{{ pages }}" flex/>
				</nav>
			</div>

			<core-scroll-header-panel main xondenses>
				<core-toolbar style="background:{{toolbarBackground}};" class="{{toolboxClass}}">
					<!-- tall or medium-tall for bigger header-->
					<core-icon-button id="menuButton" icon="menu" on-tap="{{togglePanel}}"></core-icon-button>
					<div flex>{{selectedModel.node.name}}</div>
					<core-icon-button on-click="{{reload}}" class="langIcon" src="{{globals.lang|langIcon}}"></core-icon-button>
					<core-tooltip label="{{loginMessage}}" position="left">
						<core-icon-button on-click="{{login}}" icon="system-update-tv"></core-icon-button>
					</core-tooltip>
				</core-toolbar>

				<div class="content" style="xeight:100%">
					<!--height:100% slow scroll in chromium androit-->
					<core-animated-pages style="position:relative;" id="pages" selected="{{route}}" valueattr="hash" transitions="cross-fade">
						<template repeat="{{page, i in pages}}">
							<section class="main" style="position:relative;" wrap?="{{page.wrap}}" hash="{{page.hash}}">
								<div cross-fade style="height:100%">
									<div style="max-width:100%;">{{'tr.loading'|tr}} {{page.name}}</div>
								</div>
							</section>
						</template>
					</core-animated-pages>
				</div>
			</core-scroll-header-panel>

		</core-drawer-panel>

		<paper-dialog id="loginDialog">
			<simpl-login on-login-ok="{{loginOk}}" id="login"></simpl-login>
		</paper-dialog>
	</template>
	<script>
		Polymer( 'simpl-main', {
			DEFAULT_ROUTE: '0',
			logoBackground: 'white',
			toolbarBackground: null,
			logo: 'logo.svg',
			loginMessage: "Login",
			domReady: function() {
				this.drawerPanel = this.$.drawerPanel;
				this.ajax = this.$.ajax;
				this.corePages = this.$.pages;
				this.keys = this.$.keys;
				this.cache = {};
				$( this.$.logo ).css( "background", this.logoBackground );
				// Allow selecting pages by num keypad. 
				var keysToAdd = Array.apply( null, this.pages ).map( function( x, i ) {
					return i + 1;
				} ).reduce( function( x, y ) {
					return x + ' ' + y;
				} );
				if ( this.keys ) {
					this.keys += ' ' + keysToAdd;
				}

				console.log( "location:" + window.location );
				this.route = this.route || this.DEFAULT_ROUTE; // Select initial route.
				this.toolboxClass = "";
			},
			routeChanged: function() {
				console.log( "routeChanged:" + this.route );
				channel.publish( "route.changed", {
					route: this.route
				} );
			},
			togglePanel: function() {
				this.drawerPanel.togglePanel();
			},
			keyHandler: function( e, detail, sender ) {
				var num = parseInt( detail.key );
				if ( !isNaN( num ) && num <= this.pages.length ) {
					this.corePages.selectIndex( num - 1 );
					return;
				}

				switch ( detail.key ) {
					case 'left':
					case 'up':
						this.corePages.selectPrevious();
						break;
					case 'right':
					case 'down':
						this.corePages.selectNext();
						break;
					case 'space':
						detail.shift ? this.corePages.selectPrevious() : this.corePages.selectNext();
						break;
				}
			},
			menuItemSelected: function( e, detail, sender ) {
				if ( detail.isSelected && detail.model.node && detail.model.node.url ) {
					this.async( function() {
						if ( !this.cache[ this.ajax.url ] ) {
							this.ajax.go();
						}
						this.drawerPanel.closeDrawer();
					} );
				}
			},
			onResponse: function( e, detail, sender ) {
				var body = detail.response.body;
				var head = detail.response.head;
				var sheets = head.querySelectorAll( 'link[rel=stylesheet]' );
				var sheetsHTML = "\n";
				for ( var i = 0, l = sheets.length, sheet;
					( i < l ) && ( sheet = sheets[ i ] ); i++ ) {
					sheetsHTML += sheet.outerHTML + "\n";
				}

				//console.error( "Route:" + this.route + "/", this.corePages.selectedItem );
				// Fix up image paths to not be local.
				[].forEach.call( body.querySelectorAll( 'img' ), function( img ) {
					img.setAttribute( 'src', img.src );
				} );

				var html = sheetsHTML + body.innerHTML;
				this.cache[ this.ajax.url ] = html;

				var insertPoint = this.corePages.selectedItem.firstElementChild;
				if ( this.corePages.selectedItem.getAttribute( "wrap" ) == null ) {
					this.injectBoundHTML( html, insertPoint );
					Polymer.whenReady( ( function() {
						if ( !window.ShadowDOMPolyfill ) {
							console.log( "Ready" );
							this.convertSheetsToStyles( insertPoint );
						}
					} ).bind( this ) );
				} else {
					var encapsulateElementName = 'encapsulate-element' + this.route;
					Polymer( encapsulateElementName, {
						ready: function() {}
					} );
					var encapsulateElementWrapper = document.createElement( 'div' );
					var elementDecl = '<polymer-element name="' + encapsulateElementName + '" attributes="globals"><template>' + html + '</template></polymer-element>';
					encapsulateElementWrapper.innerHTML = elementDecl;
					document.body.appendChild( encapsulateElementWrapper );

					var start = new Date().getTime();
					this.whenElementsReady( ( function() {
						console.log( "Elements.Ready:" + ( new Date().getTime() - start ) );
						var html = '<' + encapsulateElementName + ' id="' + encapsulateElementName + '" globals="{{globals}}"></' + encapsulateElementName + '>';
						this.injectBoundHTML( html, insertPoint );
						this.evalScripts( encapsulateElementName );
					} ).bind( this ) );
				}
			},
			evalScripts: function( id ) {
				if ( !window.ShadowDOMPolyfill ) {
					return
				}
				var e = this.shadowRoot.querySelector( "#" + id );
				var scripts = e.shadowRoot.querySelectorAll( "script" );
				for ( var i = 0; i < scripts.length; i++ ) {
					eval( scripts[ i ].text );
				}
			},
			whenElementsReady: function( done ) {
				Polymer.whenReady( function() {
					console.log( "Polymer.Ready" );

					function waitForElements() {
						var elementsNotReady = Polymer.waitingFor();
						console.log( "ElementsNotReady:", elementsNotReady.length );
						if ( elementsNotReady.length == 0 ) {
							done();
							return;
						}
						console.log( "NewRound" );
						setTimeout( waitForElements, 20 );
					}
					waitForElements();
				} );
			},
			convertSheetsToStyles: function( root ) {
				var SHEET_SELECTOR = 'link[rel=stylesheet]';
				var s$ = root.querySelectorAll( SHEET_SELECTOR );
				for ( var i = 0, l = s$.length, s, c;
					( i < l ) && ( s = s$[ i ] ); i++ ) {
					c = this.createStyleElement( this.importRuleForSheet( s, this.ownerDocument.baseURI ),
						this.ownerDocument );
					this.copySheetAttributes( c, s );
					s.parentNode.replaceChild( c, s );
				}
			},
			copySheetAttributes: function( style, link ) {
				for ( var i = 0, a$ = link.attributes, l = a$.length, a;
					( a = a$[ i ] ) && i < l; i++ ) {
					if ( a.name !== 'rel' && a.name !== 'href' ) {
						style.setAttribute( a.name, a.value );
					}
				}
			},
			importRuleForSheet: function( sheet, baseUrl ) {
				var href = new URL( sheet.getAttribute( 'href' ), baseUrl ).href;
				return '@import \'' + href + '\';';
			},
			createStyleElement: function( cssText, scope ) {
				scope = scope || document;
				scope = scope.createElement ? scope : scope.ownerDocument;
				var style = scope.createElement( 'style' );
				style.textContent = cssText;
				return style;
			},

			loginOk: function( e ) {
				this.loginMessage = "User:" + e.detail.identifier;
				this.$.loginDialog.toggle();
			},
			login: function( e ) {
				this.$.loginDialog.toggle();
			},

			langIcon: function( lang ) {
				return ( lang == "de" || lang == null ) ? "en.svg" : "de.svg";
			},
			reload: function( e ) {
				var lang = Simpl4.Cache.getItem( "lang" );
				Simpl4.Cache.setItem( "lang", ( lang == "de" || lang == null ) ? "en" : "de" );
				history.go( 0 )
			}
		} );

	</script>
</polymer-element>
