<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<dom-module id="simpl-dispatcher" flex relative>
	<style shim-shadowdom>
	</style>
	<template>
		<div id="main" />
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-dispatcher',
			properties: {
				selected: {
					observer: "selectedChanged",
					type: String
				}
			},
			ready: function() {
				this.pages = simpl4PageRegistry.getPages();
			},
			attached: function() {
				this.async( function() {
					this._attached();
				} );
			},
			_attached: function() {
				this.mainMenuElement = Polymer.dom( document.querySelectorAll( this.shadowRoot ? "html /deep/ simpl-mmenu" : "simpl-mmenu" )[ 0 ].root );
				var aList = this.mainMenuElement.querySelectorAll( "a" );
				for ( var i = 0; i < aList.length; i++ ) {
					var a = aList[ i ];
					if ( a[ "className" ] != "mm-subopen" ) {
						$( a ).tap( this.tapListener.bind( this ), false );
					}
				}
				if ( this.selected ) {
					var self = this;
					setTimeout( function() {
						self.openMenuByHash( self.mainMenuElement, self.selected );
					}, 300 );
				}
			},
			tapListener: function( e ) {
				if ( e.target[ "className" ] == "mm-subopen" ) {
					return;
				}
				var page = e.target.page;
				console.log( "dispatcher.tapListener.page:", page );
				if ( !page ) return;
				if ( this._selectedPage ) {
					this.fire( "mmenu-selected", {
						isSelected: false,
						page: this._selectedPage
					} );
				}
				this._selectedPage = page;
				simpl4PageRegistry.setActivePage(page);
				this.fire( "mmenu-selected", {
					isSelected: true,
					page: this._selectedPage
				} );
				this.selected = page.hash;
				console.log( "dispatcher.tapListener:" + page.hash );
			},
			getPageByHash: function( hash ) {
				for ( var i = 0; i < this.pages.length; i++ ) {
					if ( this.pages[ i ].hash == hash ) {
						return this.pages[ i ];
					}
				}
			},
			openMenuByHash: function( mainelem, hash ) {
				if ( mainelem == null ) return;
				var li = $( mainelem.querySelector( '#x' + hash ) );
				var pli = li.parents( "li" );
				pli.each( function() {
					if ( !$( this ).hasClass( "mm-opened" ) ) {
						$( this ).find( "a" ).first().trigger( "click" );
					}
				} )
				li.trigger( "setSelected", true );
			},
			selectedChanged: function( e ) {
				if ( this._selectedPage == null || this.selected != this._selectedPage.hash ) {
					var page = this.getPageByHash( this.selected );
					if ( page ) {
						this._selectedPage = page;
						simpl4PageRegistry.setActivePage(page);
						this.fire( "mmenu-selected", {
							isSelected: true,
							page: this._selectedPage
						} );
					}
				}
				this.openMenuByHash( this.mainMenuElement, this.selected );
			}
		} );

	</script>
</dom-module>
