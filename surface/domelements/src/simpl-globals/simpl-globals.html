<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->

<link rel="import" href="utils-import.html">
<dom-module id="simpl-globals" attributes="globals namespace" hidden>
	<script>
		( function() {
				/**
				 */
				if ( window.console.debug == null ) {
					window.console.debug = window.console.log;
				}

				function getParameterByName( name ) {
					var match = RegExp( '[?&]' + name + '=([^&]*)' ).exec( window.location.search );
					return match && decodeURIComponent( match[ 1 ].replace( /\+/g, ' ' ) );
				}

				function removeQueryParameter() {
					var uri = window.location.toString();
					if ( uri.indexOf( "?" ) > 0 ) {
						var hash = '';
						if ( uri.indexOf( "#" ) > 0 ) {
							hash = uri.substring( uri.indexOf( "#" ) );
						}
						var clean_uri = uri.substring( 0, uri.indexOf( "?" ) ) + hash;
						try {
							window.history.replaceState( {}, document.title, clean_uri );
						} catch ( e ) {
							console.error( e.stack );
						}
					}
				}

				var scripts = document.querySelectorAll( "head > script" );
				for ( var i = 0; i < scripts.length; i++ ) {
					var src = scripts[ i ].src;
					if ( src.match( /sw\/surface/ ) ) {
						var x = src.split( "/sw" );
						var baseUrl = x[ 0 ];
						console.log( "baseUrl1:" + baseUrl );
						simpl4.util.BaseManager.setBaseUrl( baseUrl );
						break;
					}
				}
				if ( simpl4.util.BaseManager.getBaseUrl() == null ) {
					var links = document.querySelectorAll( "head > link" );
					for ( var i = 0; i < links.length; i++ ) {
						var href = links[ i ].href;
						if ( href.match( /sw\/surface/ ) ) {
							var x = href.split( "/sw" );
							var baseUrl = x[ 0 ];
							console.log( "baseUrl2:" + baseUrl );
							simpl4.util.BaseManager.setBaseUrl( baseUrl );
							break;
						}
					}
				}
				var x = location.toString().split( "/" );
				var namespace = x[ x.length - 2 ];

				window.is_chromium = navigator.userAgent.toLowerCase().indexOf( 'chrome' ) > -1;

				simpl4.util.BaseManager.setNamespace( namespace );

				var qlang = getParameterByName( "lang" );
				removeQueryParameter();
				console.log( "search:", location );
				console.log( "qlang:" + qlang );
				var lang = Simpl4.Cache.getItem( "lang" );
				if ( qlang ) {
					simpl4.util.BaseManager.setLanguage( qlang );
					simpl4.util.Globals.set( "lang", qlang );
				} else {
					simpl4.util.BaseManager.setLanguage( lang ? lang : "en" );
					simpl4.util.Globals.set( "lang", lang ? lang : "en" );
				}

				simpl4.util.BaseManager.setUser( "guest" );
				simpl4.util.BaseManager.setPassword( "guest" );

				moment.locale( simpl4.util.BaseManager.getLanguage() );

				window.simpl4FormManager = simpl4.util.FormManager;
				window.simpl4MessageManager = simpl4.util.MessageManager;
				window.simpl4EntityManager = simpl4.util.EntityManager;
				window.simpl4PageRegistry = simpl4.util.PageRegistry;
				window.simpl4Globals = simpl4.util.Globals;
				console.log( "GLOBAS", simpl4Globals.getAll() );

				simpl4MessageManager.installBaseMessages();
				window.tr = simpl4MessageManager.tr;

				TrBehavior = {
					tr: function() {
						return simpl4MessageManager.tr( input );
					},
				};

				window.channel = postal.channel();


				Polymer( {
					is: 'simpl-globals',
					properties: {
						namespace: {
							type: String,
							value: "xxx"
						}
					},
					created: function() {
						console.debug( "simpl-globals.create:" + tr( 'data.customer.cid' ) );
					},
					namespaceChanged: function() {
						simpl4MessageManager.installMessages( this.namespace );
					},
					getProperties: function() {
						var ret = null;
						jQuery.ajax( {
							url: "properties.yaml",
							async: false,
							dataType: "json"
						} ).done( ( function( data ) {
							data.lang = simpl4MessageManager.getLanguage();
							window.globals = data;
							if ( data.mainNamespace ) {
								simpl4.util.BaseManager.setNamespace( data.mainNamespace );
							}
							ret = data;
						} ).bind( this ) );
						console.log( "return:", ret );
						return ret;
					}
				} );
				TranslationsBehavior = {
					properties: {},
					created: function() {
						console.log( 'Translations for ', this, 'enabled!' );
					},

					tr: function( m ) {
						return window.tr( m );
					}
				};
			}
		)();

	</script>
</dom-module>
