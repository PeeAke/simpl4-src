<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-crud" attributes="namespace entity" flex relative>
	<template>
		<style>
			:host {
				min-height: 400px;
				display: inherit;
			}

		</style>
		<core-animated-pages selected="{{pageSelected}}">
			<section style="padding:0px;min-height:400px;position:relative;">
				<simpl-filter entity="{{entity}}" rules="{{rules}}"></simpl-filter>
				<simpl-crudtable on-add-action="{{addAction}}" on-copy-action="{{copyAction}}" on-edit-action="{{editAction}}" rules="{{rules}}"></simpl-crudtable>
			</section>
			<section style="padding:0px;position:relative;" unresolved>
				<simpl-crudform id="formid" spec="{{spec}}"></simpl-crudform>
				<div layout horizontal style="margin-top:20px;margin-bottom:4px;text-align:left;">
					<paper-button raised on-tap="{{saveAction}}" flex>
						<core-icon icon="save"></core-icon>{{'data.form.save'|tr}}</paper-button>
					<paper-button raised on-tap="{{cancelAction}}" flex>
						<core-icon icon="cancel"></core-icon>{{'tasks.form.cancel'|tr}}</paper-button>
				</div>
				<paper-toast id="toast" duration=4000 class="capsule" text="{{toast_message}}" style="padding-right: 60px;"></paper-toast>
				<paper-action-dialog id="error" class="scrolling">
					<core-icon class="error-big" icon="error"></core-icon>
					<p></p>
					<paper-button raised affirmative autofocus>
						<core-icon affirmative icon="check"></core-icon>Ok</paper-button>
				</paper-action-dialog>
			</section>
		</core-animated-pages>
	</template>
	<script>
		Polymer( 'simpl-crud', {
			pageSelected: 0,
			domReady: function() {
				var spec = simpl4FormManager.getCrudForm( this.entity, "firstapp" );
				this.spec = [ spec ];
			},
			cancelAction: function() {
				console.log( "CancelAction:", this );
				this.pageSelected = 0;
			},
			copyAction: function( e ) {
				this.mode = 'add';
				console.log( "copyAction:", e );
				this.$.formid.setData( e.detail.data );
				this.pageSelected = 1;
			},
			editAction: function( e ) {
				this.mode = 'edit';
				console.log( "editAction:", e );
				this.currentRow = e.detail.data;
				this.$.formid.setData( e.detail.data );
				this.pageSelected = 1;
			},
			storeData: function( data ) {
				var ret = simpl4.util.Rpc.rpcSync( "data:" + ( this.mode == 'add' ? "insert" : "update" ), {
					storeId: ( this.namespace || simpl4.util.BaseManager.getNamespace() ) + "_data",
					entity: this.entity,
					id: data.id,
					data: data
				} );
				return ret;
			},
			saveAction: function() {
				var valid = this.$.formid.validate();
				var data = this.$.formid.getData();

				console.log( "saveAction.valid:" + valid );
				console.log( "saveAction:" + JSON.stringify( data, null, 2 ) );
				if ( !valid ) {
					this.toast_message = tr( "widgets.table.form_incomplete" );
					this.shadowRoot.querySelector( "#toast" ).show();
					return;
				} else {
					try {
						if ( this.mode == 'edit' ) {
							data = simpl4.util.Merge.deepmerge( this.currentRow, data );
						}
						var ret = this.storeData( data );
						console.log( "Ret:", ret );
						var content = ret;
						var cv = ret[ "constraintViolations" ];
						if ( cv ) {
							var message = "";
							for ( var i = 0; i < cv.length; i++ ) {
								var c = cv[ i ];
								message += this.$.formid.getLabel( c.path ) + " : " + c.message + "<br />";
							}
							this.alert( message );
						} else {
							if ( this.mode == 'add' ) {
								this.toast_message = tr( "data.form.created" );
							} else {
								this.toast_message = tr( "data.form.saved" );
							}
							this.shadowRoot.querySelector( "#toast" ).show();

							setTimeout( ( function() {
								this.pageSelected = 0;
							} ).bind( this ), 4000 );
						}
					} catch ( e ) {
						this.toast_message = tr( "data.form.save" ) + ":" + e.message;
						this.shadowRoot.querySelector( "#toast" ).show();
						return;
					}
				}
			},
			addAction: function() {
				this.mode = 'add';
				console.log( "addAction:", this );
				this.$.formid.setData( {} );
				this.pageSelected = 1;
			},
			alert: function( message ) {
				this.shadowRoot.querySelector( "#error p" ).innerHTML = message;
				this.shadowRoot.querySelector( "#error" ).open();
			}
		} );

	</script>
</polymer-element>
