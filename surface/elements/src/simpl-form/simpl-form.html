<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<style>
	html /deep/ [novanish] {
		min-height: 8px;
	}
	html /deep/ simpl-group {
		margin-bottom: 40px;
		background: white !important;
	}
	html /deep/ simpl-row {
		padding: 0 0px;
	}
	html /deep/ simpl-row >:not(:last-child) {
		margin-right: 0px;
	}
	html /deep/ simpl-header {
		font-size: 1.3em;
		padding: 16px 24px;
	}
	html /deep/ simpl-header-2 {
		font-size: 0.75em;
		padding: 1.1em 24px;
	}
	html /deep/ simpl-form {
		padding-top: 8px;
	}
</style>

<polymer-element name="simpl-header" noscript></polymer-element>
<polymer-element name="simpl-header-2" noscript></polymer-element>
<polymer-element name="simpl-group" vertical layout noscript></polymer-element>
<polymer-element name="simpl-row" horizontal layout center wrap novanish noscript></polymer-element>

<polymer-element name="simpl-form" attributes="namespace formname" constructor="SimplForm" vertical layout>
	<template>
		<link rel="stylesheet" type="text/css" href="grids.css">
		<link rel="stylesheet" type="text/css" href="grids-responsive.css">
		<style>
			:host {
				display: block;
				padding: 2px;
			}
			paper-tab.core-selected {
				background:#FFFF8D;
				border-radius: 4px;
			}
			paper-tab {
			}
			.tabcontainer {
				width: 100%;
			}
			fieldset {
				border-radius: 8px;
				border: 1px solid #f0f0f0;
			}
			simpl-group {
				background: white;
			}
			paper-item {
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
				font-size: 12px;
			}
		</style>

		<fieldset id="formdiv" verticax xayout>
			<template repeat="{{shapes}}" id="root">

				<template if="{{id=='Input' || id=='ActionButton' || id=='Textarea' || id=='break'}}" ref="element" bind></template>

				<template if="{{ id=='Tabview' }}" ref="tabs" bind></template>

				<template if="{{ id=='Group' }}" ref="group" bind></template>

				<template if="{{ id=='Row' }}" ref="row" bind></template>

			</template>

		</fieldset>

		<template id="group">
			<simpl-group>
				<template ref="root" repeat="{{childShapes}}"></template>
			</simpl-group>
		</template>

		<template id="row">
			<simpl-row>
				<template ref="root" repeat="{{childShapes}}"></template>
			</simpl-row>
		</template>

		<template id="tabs">
			<div class="tabcontainer" layout vertical felx>
				<paper-tabs selected="{{selected}}">
					<template repeat="{{childShapes}}">
						<template if="{{ id=='Page' }}">
							<paper-tab id="{{xf_id}}">{{xf_id}}</paper-tab>
						</template>
					</template>
				</paper-tabs>

				<core-animated-pages selected="{{selected}}" vertical layout>
					<template repeat="{{childShapes}}">
						<template if="{{ id=='Page' }}">
							<section style="position:relative;padding:0px;">
								<template ref="element" repeat="{{childShapes}}"></template>
							</section>
						</template>
					</template>
				</core-animated-pages>
			</div>
		</template>

		<template id="element">
			<template if="{{ id=='Input' }}">
				<input-field flex type={{xf_type}} name="{{xf_id}}" label="{{label}}" xalue="{{data.value}}"></input-field>
			</template>
			<template if="{{ id=='ActionButton' }}">
				<paper-button on-tap="{{validateAll}}" class="button" raised>{{xf_label}}</paper-button>
			</template>
			<template if="{{ id=='Textarea' }}">
				<multiline-field flex name="{{xf_id}}" label="{{label}}" xvalue="{{data.street}}"></multiline-field>
			</template>

			<template if="{{ id=='Group' }}" ref="group" bind></template>
			<template if="{{ id=='Row' }}" ref="row" bind></template>
		</template>


		<simpl-row>
			<button on-tap="{{submit}}">Submit</button>
		</simpl-row>


		<segment>
			Your form data:
			<pre><code id="data"></code></pre>
		</segment>
	</template>
	<script>
		Polymer( 'simpl-form', {
			data: {},
			namespace: null,
			formname: null,
			eventDelegates: {
				'add-form-field': 'addField',
				'remove-form-field': 'removeField'
			},
			created: function() {
				this.fields = [];
			},
			ready: function() {
				console.log( "Ready:", this.$.xxxx );
				var form = simpl4FormManager.getForm( this.formname );
				this.shapes = this.prepareShape( form ).childShapes;
				console.log( "Shape:" + JSON.stringify( this.shapes, null, 2 ) );
			},
			domReady: function() {
				return;
				regula.bind( {
					element: this.$.OrderName,
					constraints: [ {
						constraintType: regula.Constraint.Min,
						params: {
							value: "18",
							message: "You must be at least 18 years old to vote",
							groups: [ 'MyGroup' ]
						}
					} ]
				} );
				regula.bind( {
					element: this.$.FlanFlavor,
					constraints: [ {
						constraintType: regula.Constraint.Future,
						params: {
							format: regula.DateFormat.YMD,
							date: "2015/2/1",
							groups: [ 'MyGroup' ]
						}
					} ]
				} );
				return;
				this.allFields = this.$.form.querySelectorAll( 'input-field' );
				this.allFieldsMap = {};
				for ( var i = 0; i < this.allFields.length; i++ ) {
					this.allFieldsMap[ this.allFields[ i ].id ] = this.allFields[ i ];
				}
			},
			/*----------------------------------*/
			prepareShape: function( shape ) {
				shape = this.cleanShape( shape );
				shape.childShapes = _.sortBy( shape.childShapes, function( element ) {
					return element.bounds.upperLeft.y * 10000 + element.bounds.upperLeft.x;
				} );
				var childShapes = shape.childShapes;
				shape.childShapes = [];
				var row = null;
				for ( var i = 0; i < childShapes.length; i++ ) {
					if ( shape.id == 'Tabview' ) {
						shape.childShapes.push( this.prepareShape( childShapes[ i ] ) );
					} else {
						if ( i == 0 || ( i > 0 && this.isLineBreak( childShapes[ i - 1 ], childShapes[ i ] ) ) ) {
							row = {
								id: 'Row',
								childShapes: []
							};
							shape.childShapes.push( row );
						}
						row.childShapes.push( this.prepareShape( childShapes[ i ] ) );
					}
				}
				return shape;
			},
			cleanShape: function( shape ) {
				if ( shape.stencil.id.toLowerCase() == "input" || shape.stencil.id.toLowerCase() == 'textarea' ) {
					shape.properties.label = shape.childShapes[ 0 ].properties.xf_text;
					if ( ( shape.properties.xf_id == null || shape.properties.xf_id == "" ) && shape.properties.label ) {
						shape.properties.xf_id = shape.properties.label.toLowerCase().replace( /\s/g, '' );
					}
					shape.childShapes = [];
				} else {
					shape.properties.label = "";
				}
				return _.extend( shape.properties, shape.stencil, {
					childShapes: shape.childShapes
				} );
			},
			isLineBreak: function( child, next ) {
				var UL = child.bounds.upperLeft;
				var lineBreak = false;
				var nextUL = next.bounds.upperLeft;
				if ( UL.y != nextUL.y ) {
					lineBreak = true;
				}
				return lineBreak;
			},
			validateAll: function() {
				console.debug( "validateAll" );
				var $d = this.$.formdiv.querySelectorAll( '.input' );
				console.log( "D:", $d );
				Array.prototype.forEach.call( $d, function( d ) {
					console.debug( "Input:" + d.value );
					d.isInvalid = !d.valid;
				} );
			},
			/*----------------------------------*/
			addField: function( e ) {
				this.fields.push( e.detail );
			},
			removeField: function( e ) {
				var i = this.fields.indexOf( e.detail );
				if ( i >= 0 ) {
					this.fields.splice( i, 1 );
				}
			},
			submit: function( e ) {
				//var cvList = regula.validate( {} );
				//console.log( "cvList:", cvList );

				var data = this.getData();
				var jsonData = JSON.stringify( data, null, 2 );
				console.log( "JSON:" + jsonData );
				this.$.data.textContent = jsonData;
				this.setData( data );
			},
			setData: function( data ) {
				this.fields.forEach( function( field ) {
					field.editValue = data[ field.name ];
				}, this );
			},
			getData: function() {
				var data = {};
				this.fields.forEach( function( field ) {
					data[ field.name ] = field.value;
				}, this );
				return data;
			},
			dump: function() {
				var data = {};
				this.fields.forEach( function( field ) {
					data[ field.name ] = field.value;
				}, this );
				return data;
			}
		} );
	</script>
</polymer-element>
