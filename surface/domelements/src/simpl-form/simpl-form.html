<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<style>
	html /deep/ xaction-button iron-icon {
		pointer-events: none;
	}
	html /deep/ xaction-button paper-material {
		pointer-events: none;
	}
	html /deep/ xaction-button paper-ripple {
		pointer-events: none;
	}

</style>


<dom-module id="xaction-button">
	<style>
		:host {
			display: inline-block;
			position: relative;
			box-sizing: border-box;
			min-width: 5.14em;
			margin: 0 0.29em;
			background: transparent;
			text-align: center;
			font: inherit;
			text-transform: uppercase;
			outline: none;
			border-radius: 3px;
			-moz-user-select: none;
			-ms-user-select: none;
			-webkit-user-select: none;
			user-select: none;
			cursor: pointer;
			z-index: 0;
			@apply(--paper-button);
		}
		.keyboard-focus {
			font-weight: bold;
		}
		:host([disabled]) {
			background: #eaeaea;
			color: #a8a8a8;
			cursor: auto;
			pointer-events: none;
			@apply(--paper-button-disabled);
		}
		:host([noink]) paper-ripple {
			display: none;
		}
		paper-material {
			border-radius: inherit;
		}
		.content >::content * {
			text-transform: inherit;
		}
		.content {
			padding: 0.7em 0.57em
		}

	</style>

	<template>
		<paper-ripple></paper-ripple>
		<paper-material class="content" elevation="[[_elevation]]" animated>
			<content></content>
		</paper-material>
	</template>
	<script>
		Polymer( {
			is: 'xaction-button',
			behaviors: [
				Polymer.PaperButtonBehavior
			],
			properties: {
				xaction: {
					type: String
				},
				xid: {
					type: String
				}
			}
		} );

	</script>
</dom-module>


<dom-module id="simpl-group">
	<style>
		:host {
			margin-bottom: 20px;
			border: 1px solid #E0E0E0;
			border-radius: 4px;
			padding: 7px;
			margin-top: 5px;
			background: white !important;
		}

	</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-group'
		} );

	</script>
</dom-module>

<dom-module id="simpl-row">
	<style>
		html /deep/ simpl-row {
			padding: 0 0px;
		}
		html /deep/ simpl-row >:not(:last-child) {
			margin-right: 0px;
		}
		:host {
			width: 100%;
		}

	</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-row'
		} );

	</script>
</dom-module>

<script>
	FormElementSelectorBehavior = {
		isTabView: function( id ) {
			console.log( "isTabView:", ( id == 'Tabview' ) );
			return id == 'Tabview';
		},
		isEnumSelect: function( id ) {
			return id == 'Enumselect';
		},
		isModuleSelector: function( id ) {
			return id == 'Moduleselector';
		},
		isAlert: function( id ) {
			return id == 'Alert';
		},
		isActionButton: function( id ) {
			return id == 'ActionButton';
		},
		isTableSelect: function( id ) {
			return id == 'Tableselect';
		},
		isTextArea: function( id ) {
			return id == 'Textarea';
		},
		isRelatedTo: function( id ) {
			return id == 'RelatedTo';
		},
		isGroup: function( id ) {
			console.log( "isGroup:", ( id == 'Group' ) );
			return id == 'Group';
		},
		isRow: function( id ) {
			var r = id == 'Row';
			if ( r ) console.log( "isRow(" + id + ":", r );
			return r;
		},
		isPage: function( id ) {
			return id == 'Page';
		},
		isForm: function( id ) {
			var r = id == 'Form';
			if ( r ) console.log( "isForm(" + id + ":", r );
			return r;
		},
		isActionButtopn: function( id ) {
			var r = id == id == 'ActionButton';
			if ( r ) console.log( "isField(" + id + "):" + r );
			return r;
		},
		isField: function( id ) {
			var r = id == 'Input' || id == 'Tableselect' || id == 'Enumselect' || id == 'Textarea' || id == 'RelatedTo' || id == 'Moduleselector' || id == 'Alert' || id == 'break';
			if ( r ) console.log( "isField(" + id + "):" + r );
			return r;
		},
		isInputAndBoolean: function( id, xf_type ) {
			var r = id == 'Input' && xf_type == 'boolean';
			if ( r ) console.log( "isInputAndBoolean(" + id + ":", r );
			return r;
		},
		isInputAndNotBoolean: function( id, xf_type ) {
			var r = id == 'Input' && xf_type != 'boolean';
			if ( r ) console.log( "isInputAndNotBoolean(" + id + ":", r );
			return r;
		},
		tabTitle: function( t ) {
			console.log( "tabTitle:" + t );
			return t;
		}
	};

</script>

<dom-module id="form-element-renderer">
	<style>
		:host {
			padding-left: 3px;
			padding-right: 3px;
			min-width: 250px;
		}

	</style>
	<template>
		<template is="dom-if" if="{{isInputAndBoolean(item.id,item.xf_type)}}">
			<checkbox-field field class="flex" type={{item.xf_type}} enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr$="{{item.xf_exclude}}" data-constraints$="{{item.regulaConstraints}}" name$="{{item.xf_id}}" label="{{item.label}}" defaultValue="{{item.defaultValue}}"></checkbox-field>
		</template>
		<template is="dom-if" if="{{isInputAndNotBoolean(item.id,item.xf_type)}}">
			<input-field field class="flex" type={{item.xf_type}} enabled-expr$="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr$="{{item.xf_exclude}}" data-constraints$="{{item.regulaConstraints}}" name$="{{item.xf_id}}" label="{{item.label}}" defaultValue="{{item.defaultValue}}"></input-field>
		</template>
		<template is="dom-if" if="{{isActionButton(item.id)}}">
			<xaction-button on-tap="internalXAction" class="button" xid="{{item.xf_id}}" style$="[[getActionButtonColor(item.xf_action)]]" xaction="{{item.xf_action}}" raised>
				<iron-icon icon="{{item.xf_iconname}}"></iron-icon>{{item.xf_label}}</xaction-button>
		</template>
		<template is="dom-if" if="{{isEnumSelect(item.id)}}">
			<dropdown-field field class="flex" name$="{{item.xf_id}}" items="{{item.items}}" data-constraints$="{{item.regulaConstraints}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr$="{{item.xf_exclude}}" defaultValue="{{item.defaultValue}}" label="{{item.label}}" raised>
			</dropdown-field>
		</template>
		<template is="dom-if" if="{{isTableSelect(item.id)}}">
			<tableselect-field field class="flex" name$="{{item.xf_id}}" multiSelect?="{{item.xf_multiselection}}" required="{{item.xf_required}}" height="{{height}}" items="{{items}}" meta="{{meta}}" data-constraints$="{{item.regulaConstraints}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr$="{{item.xf_exclude}}" defaultValue="{{item.defaultValue}}" label="{{item.label}}" raised>
			</tableselect-field>
		</template>
		<template is="dom-if" if="{{isTextArea(item.id)}}">
			<multiline-field field class="flex" name$="{{item.xf_id}}" rows="{{item.xf_rows}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr$="{{item.xf_exclude}}" label="{{item.label}}" defaultValue="{{item.defaultValue}}"></multiline-field>
		</template>
		<template is="dom-if" if="{{isRelatedTo(item.id)}}">
			<related-field field class="flex" name$="{{item.xf_id}}" namespace="{{item.xf_namespace}}" entity="{{item.xf_type}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr$="{{item.xf_exclude}}" label="{{item.label}}"></related-field>
		</template>
		<template is="dom-if" if="{{isModuleSelector(item.id)}}">
			<db-selector-field field class="flex" name$="{{item.xf_id}}" namespace="{{item.xf_namespace}}" fieldlist="{{item.xf_fieldlist}}" entity="{{item.xf_module}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr$="{{item.xf_exclude}}" label="{{item.label}}"></db-selector-field>
		</template>
		<template is="dom-if" if="{{isAlert(item.id)}}">
			<html-echo field name$="{{item.xf_id}}" html="{{item.xf_message}}" invisible-expr="{{item.xf_invisible}}" exclude-expr$="{{item.xf_exclude}}"></html-echo>
		</template>
		<template is="dom-if" if="{{isGroup(item.id)}}">
			<simpl-group class="group">
				<core-label for=".group">{{item.label}}</core-label>
				<form-element-selector class="flex layout horizontal center wrap" items="{{item.childShapes}}" />
			</simpl-group>
		</template>
		<template is="dom-if" if="{{isRow(item.id)}}">
			<simpl-row class="horizontal layout center wrap">
				<form-element-selector class="flex layout horizontal center wrap" items="{{item.childShapes}}" />
			</simpl-row>
		</template>
	</template>
	<script>
		Polymer( {
			is: 'form-element-renderer',
			properties: {
				item: {
					type: Object
				}
			},
			behaviors: [
				FormElementSelectorBehavior
			],
			getActionButtonColor: function( action ) {
				return "color:" + ( action == 'execute' ? '#4285f4;' : 'black;' );
			},
			internalXAction: function( e ) {
				var target = e.target || e.srcElement;
				console.log( "internalXAction", e );
				this.fire( 'internal-xaction', null, {
					node: target
				} );

			},
			attached: function() {
				console.log( "form-element-renderer:", this.item );
			}
		} );

	</script>
</dom-module>

<dom-module id="form-tab-renderer">
	<style>
		:host {
			padding-left: 3px;
			padding-right: 3px;
			min-width: 250px;
		}

	</style>
	<template>
		<div class="tabcontainer layout vertical">
			<paper-tabs class="transparent-teal" selected="{{tabSelected}}" attr-for-selected="name">
				<template is="dom-repeat" as="i" items="[[item.childShapes]]">
					<template is="dom-if" if="[[i.title]]">
						<paper-tab name$="[[i.xf_id]]">[[tabTitle(i.ititle)]]</paper-tab>
					</template>
					<template is="dom-if" if="[[!i.title]]">
						<paper-tab name$="[[i.xf_id]]">[[tabTitle(i.xf_id)]]</paper-tab>
					</template>
				</template>
			</paper-tabs>

			<iron-pages selected="{{tabSelected}}" attr-for-selected="name" class="vertical layout">
				<template is="dom-repeat" as="i" items="[[item.childShapes]]">
					<section name$="[[i.xf_id]]" style="margin-top:20px;position:relative;padding:0px;">
						<template is="dom-repeat" as="j" items="[[i.childShapes]]">
							<form-element-renderer style="display:block;padding-top:0px;padding-bottom:0px;" class="flex" item="[[j]]" />
						</template>
					</section>
				</template>
			</iron-pages>
		</div>
	</template>
	<script>
		Polymer( {
			is: 'form-tab-renderer',
			properties: {
				item: {
					type: Object
				}
			},
			behaviors: [
				FormElementSelectorBehavior
			],
			attached: function() {
				console.log( "form-tab-renderer:", this.item );
				this.async( function() {
					var tab = this.item.selected;
					if ( !tab && this.item.childShapes.length > 0 ) {
						tab = this.item.childShapes[ 0 ].xf_id;
					}
					console.log( "SelectingiTab:", tab );
					this.tabSelected = tab;
				}, 1 );
			}
		} );

	</script>
</dom-module>




<dom-module id="form-element-selector">
	<template>
		<template is="dom-repeat" items="{{items}}">

			<template is="dom-if" if="{{isField(item.id)}}">
				<form-element-renderer class="flex" item="[[item]]" />
			</template>
			<template is="dom-if" if="{{isActionButton(item.id)}}">
				<form-element-renderer class="" style="min-width:100px;margin-top:20px;" item="[[item]]" />
			</template>

			<template is="dom-if" if="[[isTabView(item.id)]]">
				<form-tab-renderer class="flex" item="[[item]]" />
			</template>

			<template is="dom-if" if="{{isGroup(item.id)}}">
				<simpl-group class="flex layout horizontal group">
					<label for=".group">{{item.label}}</label>
					<form-element-selector class="flex layout horizontal center wrap" items="{{item.childShapes}}" />
				</simpl-group>
			</template>

			<template is="dom-if" if="{{isRow(item.id)}}">
				<simpl-row class="horizontal layout center wrap">
					<form-element-selector class="flex layout horizontal center wrap" items="{{item.childShapes}}" />
				</simpl-row>
			</template>

			<template is="dom-if" if="{{isForm(item.id)}}">
				<form-element-selector items="[[item.childShapes]]" />
			</template>

		</template>
	</template>
	<script>
		Polymer( {
			is: 'form-element-selector',
			properties: {
				items: {
					type: Object
				}
			},
			behaviors: [
				FormElementSelectorBehavior
			],
			attached: function() {
				console.log( "form-element-selector:", this.items );
			}
		} );

	</script>
</dom-module>

<link rel="import" href="form-behavior.html">
<dom-module id="simpl-form" attributes="data mode" vertical layout>
	<style>
		:host {
			display: block;
			padding: 2px;
		}
		paper-tab.core-selected {
			border-radius: 6px;
		}
		paper-tab {} .tabcontainer {
			width: 100%;
		}
		fieldset#formdiv {
			padding: 0;
			margin: 0;
			border-radius: 6px;
			border: 0px solid beige;
		}
		input-field,
		related-field,
		db-selector-field,
		tableselect-field,
		dropdown-field {
			margin: 5px;
		}
		core-label {
			margin-bottom: 10px;
		}
		html-echo {
			color: red;
			margin: 15px;
		}
		xaction-button {
			margin-top: 20px;
		}
		xaction-button[xaction=execute] {
			color: #4285f4;
		}
		paper-item {
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
			font-size: 12px;
		}
		:host /deep/ paper-input-decorator[focused] /deep/ .floated-label .label-text {
			color: #000 !important;
		}
		:host /deep/ .focused-underline {
			background-color: #000;
		}
		paper-tab {
			//box-shadow: 0px 3px 2px rgba(0, 0, 0, 0.2);
		}
		paper-tabs.transparent-teal {
			background-color: transparent;
			color: #000;
			//box-shadow: 0px 3px 2px rgba(0, 0, 0, 0.2);
		}
		paper-tabs.transparent-teal::shadow #selectionBar {
			background-color: black;
		}
		paper-tabs.transparent-teal paper-tab::shadow #ink {
			color: beige;
		}
		[invisible] {
			visibility: hidden;
		}
		[exclude] {
			display: none !important;
		}

	</style>
	<template>

		<fieldset style="width:1px;min-width:100%;" id="formdiv" verticax xayout>
			<form-element-selector items="{{shapes}}" />
		</fieldset>

		<template is="dom-if" if="{{item.defaultButtons}}">
			<simpl-row>
				<xaction-button on-tap="internalXAction" class="button" xid="{{item.xf_id}}" xaction="execute" raised>
					<iron-icon icon="check"></iron-icon>{{'form.execute'|tr}}</xaction-button>
				<xaction-button on-tap="internalXAction" class="button" xid="{{item.xf_id}}" xaction="cancel" raised>
					<iron-icon icon="clear"></iron-icon>{{'tasks.form.cancel'|tr}}</xaction-button>
			</simpl-row>
		</template>

		<!--div>
			<button on-tap="{{submit}}">Submit</button>
		</div-->
	</template>
	<script>
		Polymer( {
			is: 'simpl-form',
			behaviors: [
				FormBehavior
			],
			properties: {
				namespace: {
					type: String
				},
				formName: {
					type: String
				},
				mode: {
					type: String
				},
				data: {
					type: Object
				},
				spec: {
					type: Object
				},
				variables: {
					type: Object
				}
			},
			observers: [
				'dataChanged(data.*)',
				'specChanged(spec.*)',
				'formNameChanged(formName)'
			],
			listeners: {
				'value-changed': 'valueChanged',
				'internal-xaction': 'internalXAction'
			},
			internalXAction: function( e ) {
				var target = e.target || e.srcElement;
				console.log( "Form.internAction", e );
				console.log( "Form.internAction.xaction", target.xaction + "/" + e.xid );
				var data = this.getData();
				var valid = this.validate();
				console.log( "Form.data", JSON5.stringify(data,null,2) );
				this.fire( 'xaction', {xaction:target.xaction, data:data, valid:valid} );
			},
			attached: function() {
				console.log( "Form.attached" );
			}
		} );

	</script>
</dom-module>
