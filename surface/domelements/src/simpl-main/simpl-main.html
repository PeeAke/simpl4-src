<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<link rel="import" href="css-import-behavior.html">
<dom-module id="simpl-main">
	<style>
		*,
		*:before,
		*:after {
			-moz-box-sizing: border-box;
			-webkit-box-sizing: border-box;
			box-sizing: border-box;
		}
		@media all and (max-width: 480px) {} neon-animatable {
			padding: 6px;
		}
		@media all and (max-width: 480px) {
			html /deep/ #loginDialog {
				top: 10vh;
				left: 0vw;
			}
		}
		[drawer] {
			box-shadow: 1px 0 1px rgba(0, 0, 0, 0.1);
		}
		#drawerPanel:not([narrow]) #menuButton {
			display: none;
		}
		:host /deep/ paper-button {
			min-width: 3em !important;
		}
		:host /deep/ div.button-content {
			overflow: hidden;
			font-size: 10px;
		}
		:host /deep/ select {
			padding: 3px;
			margin: 2px;
			-webkit-border-radius: 4px;
			-moz-border-radius: 4px;
			border-radius: 3px;
			-webkit-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			-moz-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			background: #ffffff;
			color: #888;
			border: none;
			outline: none;
			display: inline-block;
			cursor: pointer;
		}
		#headlineId {
			font-size: 18px;
		}
		@media screen and (max-width: 767px) {
			:host /deep/ #helpDialog /deep/ #scroller {
				padding: 10px 10px 10px 10px;
				margin-left: 0px;
				margin-right: 0px;
				margin-bottom: 10px;
			}
			:host /deep/ #helpDialog {
				margin-left: 0px;
				margin-right: 0px;
				margin-top: 85px;
			}
			#headlineId {
				font-size: 14px;
				margin-left: 0px;
				margin-right: 0px;
			}
		}
		simpl-mmenu {
			position: relative;
		}
		paper-toolbar.small /deep/ #topBar.toolbar-tools {
			align-items: baseline;
		}
		paper-toolbar.small {
			height: 90px;
		}
		paper-toolbar#mainToolbar {
			color: #D50303;
			background: #f6f6f6;
		}

	</style>
	<template>
		<simpl-globals></simpl-globals>

		<flatiron-director route="{{route}}" auto-hash></flatiron-director>

		<!-- Keyboard nav controller. -->
		<!--core-a11y-keys id="keys" target="{{parentElement}}" keys="up down left right space space+shift" on-keys-pressed="{{keyHandler}}"></core-a11y-keys-->

		<simpl-dispatcher on-mmenu-selected="menuItemSelected" selected="{{route}}" pages="{{getPages()}}">
			<paper-drawer-panel id="drawerPanel" drawer-width="230px" responsive-width="700px" disable-swipe="false">
				<div class="vertical layout" drawer>
					<nav id="nav" class="layout vertical fit">
						<div>
							<a href="[[logoLinkLang]]" target="_blank">
								<img id="logo" src='{{logo}}' style="max-height:120px;max-width:220px;padding-left:8px;padding-top:8px;padding-bottom:3px;border-width: 0px; border-style: solid;" />
							</a>
						</div>
						<simpl-mmenu name="menu" background="{{mmenuBackground}}" classes="{{mmenuClasses}}" sliding-submenus="true" searchfield="true" pages="{{getPages()}}" class="flex" />
					</nav>
				</div>

				<paper-scroll-header-panel header-height="64" main>
					<template is="dom-if" if="[[!toolbarProvided]]">
						<paper-toolbar id="mainToolbar">
							<paper-icon-button id="menuButton" icon="menu" on-tap="togglePanel"></paper-icon-button>
							<h2 id="headlineId" class="flex">[[selectedPage.name]]</h2>
							<template is="dom-if" if="[[selectedPage.help]]">
								<div>
									<paper-tooltip>[[helpMessage]]</paper-tooltip>
									<paper-icon-button on-click="showHelp" icon="help"></paper-icon-button>
								</div>
							</template>
							<paper-icon-button on-click="reload" class="langIcon" src="[[getLangIcon()]]"></paper-icon-button>
							<template is="dom-if" if="[[signInOutIcon]]">
								<div>
									<paper-tooltip position="left">[[loginMessage]]</paper-tooltip>
									<paper-icon-button on-click="login" icon="[[signInOutIcon]]"></paper-icon-button>
								</div>
							</template>
							<div class="toolbar bottom horizontal layout"> </div> <!--insertpoint toolbar-bottom-->
						</paper-toolbar>
					</template>

					<template is="dom-if" if="[[toolbarProvided]]">
						<content select="*"></content>
					</template>

					<neon-animated-pages id="pages" selected="{{route}}" attr-for-selected="hash" animateInitialSelection entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">
						<template is="dom-repeat" items="{{getPages()}}">
							<neon-animatable hash$={{item.hash}}>
								<div>{{item.name}}</div>
							</neon-animatable>
						</template>
					</neon-animated-pages>
				</paper-scroll-header-panel>

			</paper-drawer-panel>
		</simpl-dispatcher>

		<paper-dialog with-backdrop id="helpDialog">
			<paper-dialog-scrollable>
				<simpl-import style="[[getHelpDialogStyle()]]" class="flex layout horizontal" id="helpImport" url="{{substituteLang(selectedPage.help,1)}}"></simpl-import>
			</paper-dialog-scrollable>
		</paper-dialog>
		<!--paper-dialog id="loginDialog">
			<simpl-login on-login-ok="{{loginOk}}" id="login"></simpl-login>
		</paper-dialog-->
	</template>
	<script>
		Polymer( {
			is: 'simpl-main',
			behaviors: [
				CSSImportBehavior,
				StyleScopeBehavior
			],
			properties: {
				logoLinkLang: {
					computed: "substituteLang(logoLink)"
				},
				logoLink: {
					type: String
				},
				toolbarBackground: {
					observer: "toolbarBackgroundChanged",
					type: String
				},
				loginMessage: {
					value: 'Login',
					type: String
				},
				selectedPage: {
					notify: true,
					type: Object
				},
				mmenuBackground: {
					value: null,
					type: String
				},
				mmenuClasses: {
					value: null,
					type: String
				},
				toolbarProvided: {
					value: false,
					type: Boolean
				},
				logoBackground: {
					value: null,
					type: String
				},
				logo: {
					value: 'logo.svg',
					type: String
				}
			},
			observers: [
				'routeChanged(route)'
			],
			toolbarBottomCache: function() {
				return {};
			},
			pageCache: function() {
				return {};
			},
			getPages: function() {
				return simpl4PageRegistry.getPages();
			},
			attached: function() {
				this.async( function() {
					this._attached();
				} );
			},
			_attached: function() {
				this.entryAnimation = 'slide-from-right-animation';
				this.exitAnimation = 'slide-right-animation';
				this.helpMessage = tr( "button.help" );
				this.drawerPanel = this.$.drawerPanel;
				this.neonPages = this.$.pages;
				//this.signInOutIcon="system-update-alt";
				this.keys = this.$.keys;
				$( this.$.logo ).css( "background", this.logoBackground );
				$( this.$.nav ).css( "background", this.logoBackground );
				// Allow selecting pages by num keypad. 
				var keysToAdd = Array.apply( null, simpl4PageRegistry.getPages() ).map( function( x, i ) {
					return i + 1;
				} ).reduce( function( x, y ) {
					return x + ' ' + y;
				} );
				if ( this.keys ) {
					this.keys += ' ' + keysToAdd;
				}

				console.log( "location:" + window.location );
				console.log( "init.route:" + this.route );
			},
			getGlobals: function() {
				if ( this.globals == null ) {
					this.globals = simpl4Globals.getAll();
				}
				return this.globals;
			},
			toolbarBackgroundChanged: function() {
				this.async( function() {
					var mainToolbar = this.querySelector( "#mainToolbar" );
					$( mainToolbar ).css( "background", this.toolbarBackground );
				}, 20 );
			},
			routeChanged: function() {
				console.log( "routeChanged:" + this.route );
				channel.publish( "route.changed", {
					route: this.route
				} );
				try {
					if ( window._paq ) {
						var action = this.route == "0" ? "main" : this.route;
						if ( this.lastAction != action ) {
							console.log( "trackEvent,webdemo:" + action )
							_paq.push( [ 'trackEvent', "webdemo", action + "/" + Simpl4.Cache.getItem( "lang" ) ] )
						}
						this.lastAction = action;
					}
				} catch ( e ) {
					console.error( "trackEvent:", e.stack );
				}
			},
			togglePanel: function() {
				this.drawerPanel.togglePanel();
			},
			keyHandler: function( e, detail, sender ) {
				var num = parseInt( detail.key );
				if ( !isNaN( num ) && num <= simpl4PageRegistry.getPages().length ) {
					this.neonPages.selectIndex( num - 1 );
					return;
				}

				switch ( detail.key ) {
					case 'left':
					case 'up':
						this.neonPages.selectPrevious();
						break;
					case 'right':
					case 'down':
						this.neonPages.selectNext();
						break;
					case 'space':
						detail.shift ? this.neonPages.selectPrevious() : this.neonPages.selectNext();
						break;
				}
			},
			menuItemSelected: function( e ) {
				var page = e.detail.page;
				if ( e.detail.isSelected && page.url ) {
					console.debug( "menuItemSelected:", e );
					this.selectedPage = page;
					this.route = page.hash;
					if ( this.pageCache[ page.url ] !== true ) {
						this.importHref( page.url, this.onResponse.bind( this ) );
					} else {
						var toolbarBottom = this.querySelector( ".toolbar.bottom" );
						var tb = this.toolbarBottomCache[ page.url ];
						this.setToolbarClass( tb );
						if( tb == null){
							tb = this.getEmptyToolbarBottom();
						}
						toolbarBottom.parentNode.replaceChild( tb, toolbarBottom );
					}
				}
				this.$.drawerPanel.closeDrawer();
			},
			onResponse: function( e ) {
				var _import = e.target.import;
				var body = _import.body;
				var head = _import.head;

				var newToolbarBottom = body.querySelector( ".toolbar.bottom" );
				this.setToolbarClass( newToolbarBottom );
				this.toolbarBottomCache[ this.selectedPage.url ] = newToolbarBottom;
				if ( newToolbarBottom == null ) {
					newToolbarBottom = this.getEmptyToolbarBottom();
				}
				var toolbarBottom = this.querySelector( "div.toolbar.bottom" );
				toolbarBottom.parentNode.replaceChild( newToolbarBottom, toolbarBottom );

				this.pageCache[ this.selectedPage.url ] = true;
				var insertPoint = this.neonPages.selectedItem.firstElementChild;
				while ( insertPoint.firstChild ) {
					Polymer.dom( insertPoint ).removeChild( insertPoint.firstChild );
				}
				$( insertPoint ).hide();
				if ( head.firstElementChild && head.firstElementChild.set ) {
					head.firstElementChild.set( "globals", this.getGlobals() );
					head.firstElementChild.set( "tr", function( text ) {
						return tr( text );
					} );
					//console.log("HEAD;", head.innerHTML);
					Polymer.dom( insertPoint ).appendChild( head.firstElementChild );
				}
				if ( body.firstElementChild ) {
					//console.log("BODY;", body.innerHTML);
					Polymer.dom( insertPoint ).appendChild( body.firstElementChild );
				}

				this.async( function() {
					this.convertSheetsToStyles( insertPoint );
					var scope = this.selectedPage.scope;
					if ( this.isAsciidoc( this.selectedPage.url ) && scope == null ) {
						scope = "asciidoctor-default";
					}
					this.setStyleScope( insertPoint, scope );
					this.async( function() {
						$( insertPoint ).fadeIn();
					}, 0 );
				}, 2 );
			},
			getLogoLink: function() {
				console.log( "logoLink2:", this.logoLink );
				return this.substituteLang( this.logoLink );
			},
			substituteLang: function( url, notemp ) {
				console.log( "substituteLang:", this.getGlobals() );
				if ( url == null || url == '' ) return;
				if ( url.indexOf( "%l" ) != -1 ) {
					url = url.replace( "%l", this.getGlobals().lang );
				}
				if ( !url.match( /^http/ ) ) {
					if ( url.match( /^[a-zA-Z].*/ ) ) {
						url = "./" + url;
					}
					if ( notemp == null ) {
						url += "?t=1";
					}
				}
				console.log( "url:" + url );
				return url;
			},
			getHelpDialogStyle: function() {
				var h = $( window ).height() * 0.9;
				console.log( "height:", h );
				return "height:" + h + "px;";
			},
			showHelp: function( e ) {
				if ( window._paq && !this.$.helpDialog.opened ) {
					var action = this.route == "0" ? "main" : this.route;
					_paq.push( [ 'trackEvent', "webclient", action + "_help" ] )
				}
				this.$.helpDialog.toggle();
			},
			setToolbarClass: function( newToolbarBottom ) {
				var mainToolbar = this.querySelector( "#mainToolbar" );
				if ( newToolbarBottom == null ) {
					mainToolbar.classList.remove( "medium-tall" );
					mainToolbar.classList.remove( "small" );
				} else {
					mainToolbar.classList.add( "medium-tall" );
					mainToolbar.classList.add( "small" );
				}
			},
			getEmptyToolbarBottom: function() {
				if ( this.emptyToolbarBottom == null ) {
					var div = document.createElement( 'div' );
					div.classList.add( "toolbar" );
					div.classList.add( "bottom" );
					this.emptyToolbarBottom = div;
				}
				return this.emptyToolbarBottom;
			},
			isAsciidoc: function( url ) {
				return url.indexOf( ".adoc" ) > 0;
			},
			loginOk: function( e ) {
				this.loginMessage = "User:" + e.detail.identifier;
				this.$.loginDialog.toggle();
			},
			login: function( e ) {
				this.$.loginDialog.toggle();
			},
			getLangIcon: function() {
				var lang = Simpl4.Cache.getItem( "lang" );
				return ( lang == "de" || lang == null ) ? "en.svg" : "de.svg";
			},
			reload: function( e ) {
				var lang = Simpl4.Cache.getItem( "lang" );
				Simpl4.Cache.setItem( "lang", ( lang == "de" || lang == null ) ? "en" : "de" );
				location.search = "";
				history.go( 0 )
			}
		} );

	</script>
</dom-module>
