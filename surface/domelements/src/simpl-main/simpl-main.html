<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<dom-module id="simpl-main">
	<style>
		core-animated-pages > * {
			font-size: inherit;
			overflow-y: auto;
			border-radius: 5px;
			background-color: white;
		}
		core-animated-pages {
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		@media all and (max-width: 480px) {
			core-animated-pages {
				width: 100%;
				height: 100%;
			}
		}
		section.main {
		//	padding: 6px;
			width: 100%;
			height: 100%;
		}
		section> div {
			width: 100%;
			height: 100%;
		}
		simpl-mmenu {
			position:relative;
		}
		@media all and (max-width: 480px) {
			html /deep/ #loginDialog {
				top: 10vh;
				left: 0vw;
			}
		}
		[drawer] {
			box-shadow: 1px 0 1px rgba(0, 0, 0, 0.1);
		}
		[main] {
			height: 100%;
		}
		#drawerPanel:not([narrow]) #menuButton {
			display: none;
		}
		:host /deep/ paper-button {
			min-width: 3em !important;
		}
		:host /deep/ div.button-content {
			overflow: hidden;
			font-size: 10px;
		}
		:host /deep/ select {
			padding: 3px;
			margin: 2px;
			-webkit-border-radius: 4px;
			-moz-border-radius: 4px;
			border-radius: 3px;
			-webkit-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			-moz-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
			background: #ffffff;
			color: #888;
			border: none;
			outline: none;
			display: inline-block;
			//-webkit-appearance: none;
			//-moz-appearance: none;
			//appearance: none;
			cursor: pointer;
		}
		#headlineId {
			font-size: 18px;
		}
		@media screen and (max-width: 767px) {
			:host /deep/ #helpDialog /deep/ #scroller {
				padding: 10px 10px 10px 10px;
				margin-left: 0px;
				margin-right: 0px;
				margin-bottom: 10px;
			}
			:host /deep/ #helpDialog {
				margin-left: 0px;
				margin-right: 0px;
				margin-top: 85px;
			}
			#headlineId {
				font-size: 14px;
				margin-left: 0px;
				margin-right: 0px;
			}
		}

	</style>
	<template>
		<core-style ref="main"></core-style>

		<simpl-globals globals="{{globals}}" id="globals"></simpl-globals>
		<simpl-dispatcher on-mmenu-selected="menuItemSelected" selected="{{route}}" selected-model="{{selectedModel}}" pages="{{pages}}"></simpl-dispatcher>

		<!-- Route controller. -->
		<flatiron-director route="{{route}}" auto-hash></flatiron-director>

		<!-- Keyboard nav controller. -->
		<!--core-a11y-keys id="keys" target="{{parentElement}}" keys="up down left right space space+shift" on-keys-pressed="{{keyHandler}}"></core-a11y-keys-->

		<!-- Dynamic content controller -->
		<iron-ajax id="ajax" url="{{selectedModel.node.url}}" handle-as="document" on-response="onResponse"></iron-ajax>

		<paper-drawer-panel id="drawerPanel" drawer-width="230px" responsive-width="700px" disable-swipe="false">
			<div class="vertical layout" drawer>
				<nav id="nav" class="layout vertical fit">
					<div>
						<a href="[[logoLinkLang]]" target="_blank">
							<img id="logo" src='{{logo}}' style="max-height:120px;max-width:220px;padding-left:8px;padding-top:8px;padding-bottom:3px;border-width: 0px; border-style: solid;" />
						</a>
					</div>
					<simpl-mmenu name="menu" globals="{{globals}}" background="{{mmenuBackground}}" classes="{{mmenuClasses}}" sliding-submenus="false" searchfield="true" pages="{{ pages }}" class="flex"/>
				</nav>
			</div>

			<paper-scroll-header-panel main xondenses class="flex">
				<paper-toolbar style="background:{{toolbarBackground}};" class="{{toolboxClass}}">
					<paper-icon-button id="menuButton" icon="menu" on-tap="{{togglePanel}}"></paper-icon-button>
					<h2 id="headlineId" class="flex">{{selectedModel.node.name}}</h2>
					<template if="{{selectedModel.node.help!=null}}">
						<core-tooltip label="{{helpMessage}}" position="left">
							<paper-icon-button on-click="{{showHelp}}" icon="help"></paper-icon-button>
						</core-tooltip>
					</template>
					<paper-icon-button on-click="{{reload}}" class="langIcon" src="{{globals.lang|langIcon}}"></paper-icon-button>
					<core-tooltip label="{{loginMessage}}" position="left">
						<paper-icon-button on-click="{{login}}" icon="system-update-tv"></paper-icon-button>
					</core-tooltip>
				</paper-toolbar>

				<div class="content" style="height:100%">
					<iron-pages style="position:relative;" id="pages" selected="{{route}}" attr-for-selected="hash" transitions="slide-from-right">
						<template is="dom-repeat" items="{{pages}}">
							<section class="main" style="position:relative;" wrap$="{{item.hash}}" hash$={{item.hash}}>
								<div slide-from-right style="height:100%">
									<div style="max-width:100%;">{{item.name}}</div>
								</div>
							</section>
						</template>
					</iron-pages>
				</div>
			</paper-scroll-header-panel>

		</paper-drawer-panel>

		<!--paper-dialog layered="false" id="helpDialog">
			<template is="imported-template" content="{{selectedModel.node.help|substituteLang}}"></template>
		</paper-dialog>
		<paper-dialog id="loginDialog">
			<simpl-login on-login-ok="{{loginOk}}" id="login"></simpl-login>
		</paper-dialog-->
	</template>
	<script>
		Polymer( {
			is: 'simpl-main',
			DEFAULT_ROUTE: '0',
			toolbarBackground: null,
			properties: {
				globals: Object,
				selectedModel: Object,
				logoLinkLang: {
					computed: "substituteLang(logoLink,globals)"
				},
				logoLink: {
					type: String
				},
				toolbarBackground: {
					value:null,
					type: String
				},
				loginMessage: {
					value:'Login',
					type: String
				},
				mmenuBackground: {
					value:null,
					type: String
				},
				mmenuClasses: {
					value:null,
					type: String
				},
				logoBackground: {
					value:null,
					type: String
				},
				logo: {
					value:'logo.svg',
					type: String
				},
				pages: {
					type: Array
				}
			},
			observers: [
				'pagesChanged(pages)',
				'routeChanged(route)',
				'selectedModelChanged(selectedModel)'
			],
			pagesChanged: function() {
				console.log( "Pages:", this.pages );
			},
			selectedModelChanged: function() {
				console.log( "->selectedModelChanged:", this.selectedModel );
			},
			attached: function() {
				this.async( function() {
					this._attached();
				} );
			},
			_attached: function() {
				this.helpMessage = tr( "button.help" );
				this.drawerPanel = this.$.drawerPanel;
				this.ajax = this.$.ajax;
				console.log( "AJAX:" + this.ajax );
				this.corePages = this.$.pages;
				this.keys = this.$.keys;
				this.cache = {};
				$( this.$.logo ).css( "background", this.logoBackground );
				$( this.$.nav ).css( "background", this.logoBackground );
				// Allow selecting pages by num keypad. 
				var keysToAdd = Array.apply( null, this.pages ).map( function( x, i ) {
					return i + 1;
				} ).reduce( function( x, y ) {
					return x + ' ' + y;
				} );
				if ( this.keys ) {
					this.keys += ' ' + keysToAdd;
				}

				console.log( "location:" + window.location );
				this.route = this.route || this.DEFAULT_ROUTE; // Select initial route.
				this.toolboxClass = "";
			},
			routeChanged: function() {
				console.log( "routeChanged:" + this.route );
				var route = this.route;
				if ( route.match( /^!/ ) ) {
					route = route.substring( 1 );
				}
				if ( route == '' ) route = "0";
				if ( this.route != route ) {
					this.route = route;
				}
				console.log( "routeChanged2:" + this.route );
				$( this.$.pages.querySelectorAll( "section" ) ).css( "display", "" );
				$( this.$.pages.querySelector( "section.core-selected" ) ).css( "display", "none" );
				channel.publish( "route.changed", {
					route: this.route
				} );
				try {
					if ( window._paq ) {
						var action = this.route == "0" ? "main" : this.route;
						if ( this.lastAction != action ) {
							console.log( "trackEvent,webclient:" + action )
								//@@@MS							_paq.push( [ 'trackEvent', "webclient", action+ "/"+globals.lang ] )
						}
						this.lastAction = action;
					}
				} catch ( e ) {
					console.error( "trackEvent:", e.stack );
				}
			},
			togglePanel: function() {
				this.drawerPanel.togglePanel();
			},
			keyHandler: function( e, detail, sender ) {
				var num = parseInt( detail.key );
				if ( !isNaN( num ) && num <= this.pages.length ) {
					this.corePages.selectIndex( num - 1 );
					return;
				}

				switch ( detail.key ) {
					case 'left':
					case 'up':
						this.corePages.selectPrevious();
						break;
					case 'right':
					case 'down':
						this.corePages.selectNext();
						break;
					case 'space':
						detail.shift ? this.corePages.selectPrevious() : this.corePages.selectNext();
						break;
				}
			},
			menuItemSelected: function( e, detail, sender ) {
				console.log( "menuItemSelected:", e );
				if ( detail.isSelected && detail.model.node && detail.model.node.url ) {
					this.async( function() {
						if ( !this.cache[ this.ajax.url ] ) {
							console.log( "menuItemSelected.generateRequest.url:", this.ajax.url );
							this.ajax.generateRequest();
						}
						this.drawerPanel.closeDrawer();
					} );
				}
			},
			onResponse: function( e, detail, sender ) {
				console.log( "onResponse" );
				var body = detail.response.body;
				var head = detail.response.head;
				var sheets = head.querySelectorAll( 'link[rel=stylesheet]' );
				console.log( "detail;",detail );
				console.log( "detail.response;",detail.response );
				var sheetsHTML = "\n";
				for ( var i = 0, l = sheets.length, sheet;
					( i < l ) && ( sheet = sheets[ i ] ); i++ ) {
					sheetsHTML += sheet.outerHTML + "\n";
				}
				console.log( "Body;", body );
				console.log( "sheetsHTML;", sheetsHTML );
				//console.error( "Route:" + this.route + "/", this.corePages.selectedItem );
				// Fix up image paths to not be local.
				[].forEach.call( body.querySelectorAll( 'img' ), function( img ) {
					img.setAttribute( 'src', img.src );
				} );

				var html = sheetsHTML + body.innerHTML;
				this.cache[ this.ajax.url ] = html;

				var insertPoint = this.corePages.selectedItem.firstElementChild;
				console.log( "selectedItem:", this.corePages.selectedItem );
				console.log( "insertPoint:", insertPoint );
				console.log( "wrap:",  (this.corePages.selectedItem.getAttribute( "wrap" )==null) );
				if ( this.corePages.selectedItem.getAttribute( "wrap" ) !== true ) {
					insertPoint.innerHTML = html;
					this.convertSheetsToStyles( insertPoint );
					this.evalScripts( insertPoint );
				} else {
					var encapsulateElementName = 'encapsulate-element' + this.route;
					this._createDomModule( encapsulateElementName );

					Polymer( {
						is: encapsulateElementName,
						ready: function() {
							console.log( "encapsulateElement ready1:" );
							var rootElement = document.createElement( 'div' );
							var style = document.createElement( 'style' );
							//Polymer.dom(style).innerHTML = ".sect2\n{ background:green;\n}\n";
							var css = ".style-scope .encapsulate-element0 .sect2\n{ background:green;\n}\n";
							Polymer.dom(style).textContent = css;
//							Polymer.dom(rootElement).appendChild( style )
							var link = document.createElement( 'link' );
							link.rel="stylesheet";
							link.type="text/css";
							link.href="colony.css";
							Polymer.dom(rootElement).appendChild( link )


							var cssText = Polymer.StyleExtends.transform(style);
							console.log("cssText:",cssText);

							Polymer.dom( this.root ).appendChild( rootElement )
							var content = document.createElement( 'span' );
							Polymer.dom(rootElement).appendChild( content )
							content.innerHTML = html;
							Polymer.Base.scopeSubtree(content);
						}
					} );
					var enElement = document.createElement( encapsulateElementName );
					insertPoint.appendChild( enElement );
				}
			},
			_createDomModule: function( name ) {
				var domBind = document.createElement( 'template', 'dom-bind' );
				var doc = domBind.content.ownerDocument;

				var domModule = doc.createElement( 'dom-module' );
				domModule.setAttribute( "id", name );
				domBind.content.appendChild( domModule )

				//var style = doc.createElement( 'style' );
				//Polymer.dom(style).innerHTML=".sect2\n{ background:green;\n}\n";
				//domModule.appendChild( style )

				var template = document.createElement( 'template' );
				domModule.appendChild( template )
				document.body.appendChild( domBind );
			},

			evalScripts: function( root ) {
				var SCRIPT_SELECTOR = 'script';
				var scripts = root.querySelectorAll( SCRIPT_SELECTOR );
				for ( var i = 0; i < scripts.length; i++ ) {
					eval( scripts[ i ].text );
				}
			},
			convertSheetsToStyles: function( root ) {
				var SHEET_SELECTOR = 'link[rel=stylesheet]';
				var s$ = root.querySelectorAll( SHEET_SELECTOR );
				for ( var i = 0, l = s$.length, s, c;
					( i < l ) && ( s = s$[ i ] ); i++ ) {
					c = this.createStyleElement( this.importRuleForSheet( s, this.ownerDocument.baseURI ),
						this.ownerDocument );
					this.copySheetAttributes( c, s );
					s.parentNode.replaceChild( c, s );
				}
			},
			copySheetAttributes: function( style, link ) {
				for ( var i = 0, a$ = link.attributes, l = a$.length, a;
					( a = a$[ i ] ) && i < l; i++ ) {
					if ( a.name !== 'rel' && a.name !== 'href' ) {
						style.setAttribute( a.name, a.value );
					}
				}
			},
			importRuleForSheet: function( sheet, baseUrl ) {
				var href = new URL( sheet.getAttribute( 'href' ), baseUrl ).href;
				return '@import \'' + href + '\';';
			},
			createStyleElement: function( cssText, scope ) {
				scope = scope || document;
				scope = scope.createElement ? scope : scope.ownerDocument;
				var style = scope.createElement( 'style' );
				style.textContent = cssText;
				return style;
			},
			getLogoLink:function(){
				console.log("logoLink2:",this.logoLink);
				return this.substituteLang(this.logoLink);
			},
			substituteLang: function( url ) {
				console.log("substituteLang:",this.globals);
				if ( url == null || url == '' ) return;
				if ( url.indexOf( "%l" ) != -1 ) {
					url = url.replace( "%l", this.globals.lang );
				}
				if ( !url.match( /^http/ ) ) {
					if ( url.match( /^[a-zA-Z].*/ ) ) {
						url = "./" + url;
					}
					url += "?t=1";
				}
				console.log( "url:" + url );
				return url;
			},
			showHelp: function( e ) {
				if ( window._paq && !this.$.helpDialog.opened ) {
					var action = this.route == "0" ? "main" : this.route;
					_paq.push( [ 'trackEvent', "webclient", action + "_help" ] )
				}
				this.$.helpDialog.toggle();
			},
			loginOk: function( e ) {
				this.loginMessage = "User:" + e.detail.identifier;
				this.$.loginDialog.toggle();
			},
			login: function( e ) {
				this.$.loginDialog.toggle();
			},

			langIcon: function( lang ) {
				return ( lang == "de" || lang == null ) ? "en.svg" : "de.svg";
			},
			reload: function( e ) {
				var lang = Simpl4.Cache.getItem( "lang" );
				Simpl4.Cache.setItem( "lang", ( lang == "de" || lang == null ) ? "en" : "de" );
				location.search = "";
				history.go( 0 )
			}
		} );

	</script>
</dom-module>
