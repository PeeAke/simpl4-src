<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<link rel="import" href="import-js.html">
<polymer-element name="simpl-datatables" attributes="multiSelect selection meta data options" flex relative>
	<template>
		<link rel="stylesheet" type="text/css" href="jquery.dataTables.css" />
		<link rel="stylesheet" type="text/css" href="dataTables.responsive.css" />
		<core-style ref="datatables"></core-style>
		<style shim_shadowdom>
			:host /deep/ #dataTablesId {
				width: 100%;
				max-width: 100%;
				font-size: 12px;
				cursor: default;
				border: 0 none;
			}
			:host /deep/ #dataTablesId tr {
				height: 24px;
			}
			@media screen and (max-width: 767px) {
				:host /deep/ #dataTablesId tr {
					height: 28px;
				}
			}
			:host /deep/ #dataTablesId_length {
				max-width: 170px;
				font-size: 12px;
				margin-bottom: 2px;
				float: left;
			}
			:host /deep/ #dataTablesId_length select {
				font-size: 11px;
				width: 50px;
			}
			:host /deep/ #dataTablesId_length label {
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				display: block;
			}
			:host /deep/ #dataTablesId_filter label {
				font-size: 12px;
				margin-top: 2px;
			}
			:host /deep/ #dataTablesId_filter input {
				width: 90px;
				margin-top: 2px;
			}
			:host /deep/ #dataTablesId td:first-child:before {
				top: 2px !important;
				height: 16px !important;
				width: 16px !important;
				font-size: 14px !important;
				font-family: verdana !important;
				line-height: 14px !important;
				left: 4px !important;
				font-weight: 800 !important;
				//border: 1px solid gray !important;
				border-radius: 3px !important;
				box-shadow: 0 0 0px !important;
				background-color: white;
				color: gray;
			}
			@media screen and (max-width: 767px) {
				:host /deep/ #dataTablesId td:first-child:before {
					top: 2px !important;
					height: 20px !important;
					width: 20px !important;
					font-size: 20px !important;
					font-family: verdana !important;
					line-height: 21px !important;
					left: 2px !important;
				}
			}
			:host /deep/ #dataTablesId thead tr th,
			:host /deep/ #dataTablesId tfoot tr th {
				background: white;
			}
			:host /deep/ #dataTablesId.no-footer {
				border-bottom: 1px solid gray;
			}
			:host /deep/ #dataTablesId thead th,
			:host /deep/ #dataTablesId thead td {
				border-bottom: 1px solid #ede3c9;
				border-top: 1px solid #ede3c9;
			}
			:host /deep/ #dataTablesId.border thead tr th:first-child {
				border-left: 1px solid gray;
				border-top-left-radius: 3px;
			}
			:host /deep/ #dataTablesId.border thead tr th:last-child {
				border-right: 1px solid gray;
				border-top-right-radius: 3px;
			}
			:host /deep/ #dataTablesId.border tbody tr td:first-child {
				border-left: 1px solid gray;
			}
			:host /deep/ #dataTablesId.border tbody tr td:last-child {
				border-right: 1px solid gray;
			}
			polyfill-rule {
				content: '#dataTablesId td:first-child:before';
				top: 3px !important;
			}
			:host /deep/ #dataTablesId tbody tr td:not(:first-child) {
				padding: 5px 8px 5px;
				line-height: 1.0;
			}
			:host /deep/ #dataTablesId tbody tr td:first-child {
				padding: 5px 28px 5px;
			}
			:host /deep/ #dataTablesId thead tr th,
			table.dataTable tfoot tr th {
				padding: 0em 0.625em 0em;
				text-align: left;
				line-height: 1.6;
			}
			:host /deep/ #dataTablesId tbody tr.odd.selected,
			table.dataTable.display tbody tr.odd.selected,
			:host /deep/ #dataTablesId tbody tr.even.selected,
			table.dataTable.display tbody tr.even.selected {
				background-color: #d3d3d3;
			}
			:host /deep/ #dataTablesId thead tr th,
			:host /deep/ #dataTablesId tfoot tr th {
				background: #fee377;
			}
			:host /deep/ #dataTablesId thead tr th:first-child {
				padding: 0px 30px 0px;
			}
			:host /deep/ #dataTablesId .dtr-title {
				font-size: 13px;
			}
			:host /deep/ #dataTablesId .dtr-data {
				white-space: normal;
				font-size: 12px;
			}
			:host /deep/ #dataTablesId td {
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			:host /deep/ .paginate_enabled_previous,
			:host /deep/ .paginate_enabled_next {
				font-size: 2.2em !important;
				font-weight: bold !important;
				cursor: pointer;
			}
			:host /deep/ .paginate_disabled_previous,
			:host /deep/ .paginate_disabled_next {
				font-size: 2.2em !important;
				cursor: normal;
				visibility: hidden;
			}
			:host /deep/ .paginate_disabled_previous,
			:host /deep/ .paginate_enabled_previous {
				margin-right: 25px;
			}
			:host /deep/ .dataTables_info {
				float: left !important;
				text-align: left !important;
			}
			:host /deep/ .dataTables_paginate {
				text-align: right !important;
				padding: 0px !important;
			}
			:host /deep/ .dataTables_paginate {
				margin-top: 0.05em !important;
			}
			.dataTables_scrollBody {
				overflow-x: hidden !important;
			}

		</style>
		<div id="dtId" style="overflow:hidden;">
			<table id="dataTablesId" class="dataTables" cellpadding="0" cellspacing="0" border="0" width="100%" class="display responsive"></table>
		</div>
		<content>
		</content>
	</template>
	<script>
		Polymer( {
			multiSelect:false,
			dtTable: null,
			ready: function() {},
			domReady: function() {
				console.log( "dataTables.domReady:", this.options );
			},
			createTable: function( dtMeta, dataSet, options ) {
				this.dataSet = dataSet;
				if ( options ) {} else if ( this.options ) {
					if ( typeof this.options == 'string' ) {
						options = JSON.parse( this.options );
					} else {
						options = this.options;
					}
				} else {
					options = {};
				}
				if ( this.dtTable ) {
					this.dtTable.destroy( false );
				}
				var self = this;
				var dtMainElem = $( this.$.dataTablesId );
				if ( this.dtTable == null ) {
					dtMainElem.on( 'init.dt.dtr', function( e, settings, json ) {
						new jQuery.fn.dataTable.Responsive( settings );
					} );
				}
				this.dtTable = dtMainElem.DataTable( jQuery.extend( {
					language: this.getLang(),
					paging: true,
					pagingType: "two_button",
					bSort: false,
					bFilter: true,
					bDestroy: true,
					bLengthChange: true,
					stateSave: false,
					_columnDefs: [ {
						className: 'control',
						orderable: false,
						targets: 0
					} ],
					responsive: {
						details: {
							type: 'inline'
						}
					},
					data: dataSet,
					columns: dtMeta
				}, options ) );
				$( this.$.dtId.querySelectorAll( "table.dataTables" ) ).attr( "id", "dataTablesId" );
				this.createRowListener();
			},
			createRowListener: function() {
				var self = this;
				var rows = this.dtTable.rows().nodes();
				$( rows ).on( 'tap', ( function( e ) {
					self.currentRowIndex = e.currentTarget._DT_RowIndex;
					if( self.multiSelect){
						self.tapActionMulti( e, this, false );
					}else{
						self.tapActionSingle( e, this, false );
					}
				} ) );
			},
			tapActionSingle: function( e, t, double ) {
				if ( $( t ).hasClass( 'selected' ) ) {
					return;
				}
				this.unselectAll();
				$( t ).addClass( 'selected' );
				var sel = this.copySelection(this.dtTable.rows('.selected').data());
				this.fire( "rows-selected", {
					rows: sel
				} );
				this.selection = sel;
			},
			tapActionMulti: function( e, t, double ) {
				$(t).toggleClass('selected');
				var sel = this.copySelection(this.dtTable.rows('.selected').data());
				this.fire( "rows-selected", {
					rows: sel
				} );
				this.selection = sel;
			},
			q: function( sel ) {
				return $( this.$.dataTablesId.querySelectorAll( sel ) );
			},
			getSelection: function() {
				return this.selection;
			},
			unselectAll: function() {
				this.q( 'tr.selected' ).removeClass( 'selected' );
			},
			copySelection:function(sel){
				var raw = [];
				for(var i=0; i < sel.length;i++){
					raw.push(sel[i]);
				}
				return raw;
			},
			metaChanged: function() {
				this.preparedMeta = this.prepareMeta( this.meta );
			},
			dataChanged: function() {
				this.createTable( this.preparedMeta, this.data );
			},
			prepareMeta: function( meta ) {
				var fields = meta.fields;
				if ( fields == null ) return meta;
				var aliases = meta.aliases;
				var ret = [];
				fields.forEach( function( field, i ) {
					var alias = aliases[ i ];
					var title = field;
					if ( alias && alias.match( /^[@%]/ ) ) {
						title = tr( alias.substring( 1 ) );
					}
					var col = {
						title: title,
						data: field
					}
					ret.push( col );
				}, this );
				return ret;
			},
			getLang: function() {
				return {
					"sEmptyTable": tr( "datatables.sEmptyTable" ),
					"sInfo": tr( "datatables.sInfo" ),
					"sInfoEmpty": tr( "datatables.sInfoEmpty" ),
					"sInfoFiltered": tr( "datatables.sInfoFiltered" ),
					"sInfoPostFix": tr( "datatables.sInfoPostFix" ),
					"sInfoThousands": tr( "datatables.sInfoThousands" ),
					"sLengthMenu": tr( "datatables.sLengthMenu" ),
					"sLoadingRecords": tr( "datatables.sLoadingRecords" ),
					"sProcessing": tr( "datatables.sProcessing" ),
					"sSearch": tr( "datatables.sSearch" ),
					"sZeroRecords": tr( "datatables.sZeroRecords" ),
					"oPaginate": {
						"sFirst": tr( "datatables.sFirst" ),
						"sPrevious": tr( "datatables.sPrevious" ),
						"sNext": tr( "datatables.sNext" ),
						"sLast": tr( "datatables.sLast" )
					},
					"oAria": {
						"sSortAscending": tr( "datatables.sSortAscending" ),
						"sSortDescending": tr( "datatables.sSortDescending" )
					}
				}
			}
		} );

	</script>
</polymer-element>
