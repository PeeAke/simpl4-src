<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<style>
	html /deep/ xaction-button core-icon {
		pointer-events: none;
	}

</style>
<dom-module id="xaction-button" extends="paper-button" attributes="xaction xid" noscript>
	<style>
		:host /deep/ .button-content {
			padding-left: 5px;
			padding-right: 5px;
			padding-top: 12px;
			padding-bottom: 12px;
		}

	</style>
	<template>
		<shadow></shadow>
	</template>
	<script>
		Polymer( {
			is: 'xaction-button'
		} );

	</script>
</dom-module>

<dom-module id="simpl-header" noscript>
	<style>
		:host {
			font-size: 1.3em;
			padding: 16px 24px;
		}

	</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-header'
		} );

	</script>
</dom-module>

<dom-module id="simpl-header2" noscript>
	<style>
		:host {
			font-size: 0.75em;
			padding: 1.1em 24px;
		}

	</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-header2'
		} );

	</script>
</dom-module>



<dom-module id="simpl-group" vertical flex layout noscript>
	<style>
		:host {
			margin-bottom: 20px;
			border: 1px solid #E0E0E0;
			border-radius: 4px;
			padding: 7px;
			margin-top: 5px;
			background: white !important;
		}

	</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-group'
		} );

	</script>
</dom-module>

<dom-module id="simpl-row" horizontal layout center wrap novanish noscript>
	<style>
		html /deep/ [novanish] {
			min-height: 8px;
		}
		html /deep/ simpl-row {
			padding: 0 0px;
		}
		html /deep/ simpl-row >:not(:last-child) {
			margin-right: 0px;
		}

	</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-row'
		} );

	</script>
</dom-module>

<script>
	FormElementExprBehavior = {
		isTabView: function( id ) {
			return id == 'TabView';
		},
		isEnumSelect: function( id ) {
			return id == 'Enumselect';
		},
		isModuleSelector: function( id ) {
			return id == 'Moduleselector';
		},
		isAlert: function( id ) {
			return id == 'Alert';
		},
		isActionButton: function( id ) {
			return id == 'ActionButton';
		},
		isTableSelect: function( id ) {
			return id == 'Tableselect';
		},
		isTextArea: function( id ) {
			return id == 'Textarea';
		},
		isRelatedTo: function( id ) {
			return id == 'RelatedTo';
		},
		isGroup: function( id ) {
			return id == 'Group';
		},
		isRow: function( id ) {
			var r = id == 'Row';
			console.log( "isRow(" + id + ":", r );
			return r;
		},
		isPage: function( id ) {
			return id == 'Page';
		},
		isForm: function( id ) {
			var r = id == 'Form';
			console.log( "isForm(" + id + ":", r );
			return r;
		},
		isField: function( id ) {
			var r = id == 'Input' || id == 'ActionButton' || id == 'Tableselect' || id == 'Enumselect' || id == 'Textarea' || id == 'RelatedTo' || id == 'Moduleselector' || id == 'Alert' || id == 'break';
			console.log( "isField(" + id + "):" + r );
			return r;
		},
		isInputAndBoolean: function( id, xf_type ) {
			var r = id == 'Input' && xf_type == 'boolean';
			console.log( "isInputAndBoolean(" + id + ":", r );
			return r;
		},
		isInputAndNotBoolean: function( id, xf_type ) {
			var r = id == 'Input' && xf_type != 'boolean';
			console.log( "isInputAndNotBoolean(" + id + ":", r );
			return r;
		}
	};

</script>

<dom-module id="render-form-element" horizontal layout center wrap novanish noscript>
	<template>
		<template is="dom-if" if="{{isInputAndBoolean(item.id,item.xf_type)}}">
			<checkbox-field flex type={{item.xf_type}} enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr="{{item.xf_exclude}}" data-constraints="{{item.regulaConstraints}}" name="{{item.xf_id}}" label="{{item.label}}" defaultValue="{{item.defaultValue}}"></checkbox-field>
		</template>
		<template is="dom-if" if="{{isInputAndNotBoolean(id,xf_type)}}">
			<input-field flex type={{item.xf_type}} enabled-expr$="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr="{{item.xf_exclude}}" data-constraints="{{item.regulaConstraints}}" name="{{item.xf_id}}" label="{{item.label}}" defaultValue="{{item.defaultValue}}"></input-field>
		</template>
		<template is="dom-if" if="{{isActionButton(item.id)}}">
			<xaction-button on-tap="actionCallback" class="button" xid="{{item.xf_id}}" style="color:{{item.xf_action=='execute' ? '#4285f4' : 'black'}};" xaction="{{item.xf_action}}" raised>
				<core-icon icon="{{item.xf_iconname}}"></core-icon>{{item.xf_label}}
			</xaction-button>
		</template>
		<template is="dom-if" if="{{isEnumSelect(item.id)}}">
			<dropdown-field flex name="{{item.xf_id}}" data-constraints="{{item.regulaConstraints}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr="{{item.xf_exclude}}" defaultValue="{{item.defaultValue}}" label="{{item.label}}" raised>
				<template is="dom-repeat" items="{{items}}">
					<paper-item name="{{item.value}}">{{item.label}}</paper-item>
				</template>
			</dropdown-field>
		</template>
		<template is="dom-if" if="{{isTableSelect(item.id)}}">
			<tableselect-field flex name="{{item.xf_id}}" multiSelect?="{{item.xf_multiselection}}" required="{{item.xf_required}}" height="{{height}}" items="{{items}}" meta="{{meta}}" data-constraints="{{item.regulaConstraints}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr="{{item.xf_exclude}}" defaultValue="{{item.defaultValue}}" label="{{item.label}}" raised>
			</tableselect-field>
		</template>
		<template is="dom-if" if="{{isTextArea(item.id)}}">
			<multiline-field flex name="{{item.xf_id}}" rows="{{item.xf_rows}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr="{{item.xf_exclude}}" label="{{item.label}}" defaultValue="{{item.defaultValue}}"></multiline-field>
		</template>
		<template is="dom-if" if="{{isRelatedTo(item.id)}}">
			<related-field flex name="{{item.xf_id}}" namespace="{{item.xf_namespace}}" entity="{{item.xf_type}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr="{{item.xf_exclude}}" label="{{item.label}}"></related-field>
		</template>
		<template is="dom-if" if="{{isModuleSelector(item.id)}}">
			<db-selector-field flex name="{{item.xf_id}}" namespace="{{item.xf_namespace}}" fieldlist="{{item.xf_fieldlist}}" entity="{{item.xf_module}}" enabled-expr="{{item.xf_enabled}}" readonly-expr="{{item.xf_readonly}}" invisible-expr="{{item.xf_invisible}}" exclude-expr="{{item.xf_exclude}}" label="{{item.label}}"></db-selector-field>
		</template>
		<template is="dom-if" if="{{isAlert(item.id)}}">
			<html-echo name="{{item.xf_id}}" html="{{item.xf_message}}" invisible-expr="{{item.xf_invisible}}" exclude-expr="{{item.xf_exclude}}"></html-echo>
		</template>
		<template is="dom-if" if="{{isGroup(item.id)}}">
			<grapp-template-ref ref="group" bind="[[item]]"></grapp-template-ref>
		</template>
		<template is="dom-if" if="{{isRow(item.id)}}">
			<grapp-template-ref ref="row" bind="[[item]]"></grapp-template-ref>
		</template>
	</template>
	<script>
		Polymer( {
			is: 'render-form-element',
			properties: {
				item: {
					type: Object
				}
			},
			behaviors: [
				FormElementExprBehavior
			],
			attached: function() {
				console.log( "render-form-element:", this.item );
			}
		} );

	</script>
</dom-module>

<dom-module id="render-form-root" horizontal layout center wrap novanish noscript>
	<template>
		<template is="dom-repeat" items="{{items}}">

			<template is="dom-if" if="{{isField(item.id)}}">
				<render-form-element item="[[item]]" />
			</template>

			<template is="dom-if" if="{{isTabView(item.id)}}">
				<render-form-tabs shape="[[item]]" />
			</template>

			<template is="dom-if" if="{{isGroup(item.id)}}">
				<render-form-group shape="[[item]]" />
			</template>

			<template is="dom-if" if="{{isRow(item.id)}}">
				<render-form-row items="[[item.childShapes]]" />
			</template>

			<template is="dom-if" if="{{isForm(item.id)}}">
				<render-form-root items="[[item.childShapes]]" />
			</template>

		</template>
	</template>
	<script>
		Polymer( {
			is: 'render-form-root',
			properties: {
				items: {
					type: Object
				}
			},
			behaviors: [
				FormElementExprBehavior
			],
			attached: function() {
				console.log( "render-form-root:", this.items );
			}
		} );

	</script>
</dom-module>

<dom-module id="render-form-row" horizontal layout center wrap novanish noscript>
	<template>
		<simpl-row>
			<render-form-root items="{{items}}" />
		</simpl-row>
	</template>
	<script>
		Polymer( {
			is: 'render-form-row',
			properties: {
				items: {
					type: Object
				}
			},
			behaviors: [
				FormElementExprBehavior
			],
			attached: function() {
				console.log( "render-form-row:", this.items );
			}
		} );

	</script>
</dom-module>

<link rel="import" href="form-behavior.html">
<dom-module id="simpl-form" attributes="actionCallback data mode" vertical layout>
	<style>
		:host {
			display: block;
			padding: 2px;
		}
		paper-tab.core-selected {
			border-radius: 6px;
		}
		paper-tab {} .tabcontainer {
			width: 100%;
		}
		fieldset#formdiv {
			padding: 0;
			margin: 0;
			border-radius: 6px;
			border: 0px solid beige;
		}
		input-field,
		related-field,
		db-selector-field,
		tableselect-field,
		dropdown-field {
			margin: 5px;
		}
		core-label {
			margin-bottom: 10px;
		}
		html-echo {
			color: red;
			margin: 15px;
		}
		xaction-button {
			margin-top: 20px;
		}
		xaction-button[xaction=execute] {
			color: #4285f4;
		}
		paper-item {
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
			font-size: 12px;
		}
		:host /deep/ paper-input-decorator[focused] /deep/ .floated-label .label-text {
			color: #000 !important;
		}
		:host /deep/ .focused-underline {
			background-color: #000;
		}
		paper-tab {
			//box-shadow: 0px 3px 2px rgba(0, 0, 0, 0.2);
		}
		paper-tabs.transparent-teal {
			background-color: transparent;
			color: #000;
			//box-shadow: 0px 3px 2px rgba(0, 0, 0, 0.2);
		}
		paper-tabs.transparent-teal::shadow #selectionBar {
			background-color: black;
		}
		paper-tabs.transparent-teal paper-tab::shadow #ink {
			color: beige;
		}
		[invisible] {
			visibility: hidden;
		}
		[exclude] {
			display: none !important;
		}

	</style>
	<template>

		<fieldset style="width:1px;min-width:100%;" id="formdiv" verticax xayout>
			<render-form-root items="{{shapes}}" />
		</fieldset>

		<template is="dom-template" id="form">
			<template is="dom-repeat" items="{{item.childShapes}}">
				<grapp-template-ref ref="root" bind="[[item]]"></grapp-template-ref>
			</template>
		</template>

		<template is="dom-template" id="group">
			<simpl-group class="group">
				<core-label for=".group">{{item.label}}</core-label>
				<template is="dom-repeat" items="{{item.childShapes}}">
					<grapp-template-ref ref="root" bind="[[item]]"></grapp-template-ref>
				</template>
			</simpl-group>
		</template>

		<template is="dom-template" id="row">
			<simpl-row>
				<template is="dom-repeat" items="{{item.childShapes}}">
					<grapp-template-ref ref="root" bind="[[item]]"></grapp-template-ref>
				</template>
			</simpl-row>
		</template>

		<template is="dom-template" id="tabs">
			<div class="tabcontainer" layout vertical felx>
				<paper-tabs class="transparent-teal" selected="{{item.selected}}">
					<template is="dom-repeat" items="{{item.childShapes}}">
						<template is="dom-if" if="{{isPage(item.id)}}">
							<paper-tab id="{{item.xf_id}}">{{|xf_id}}</paper-tab>
						</template>
					</template>
				</paper-tabs>

				<iron-pages selected="{{item.selected}}" vertical layout>
					<template is="dom-repeat" items="{{item.childShapes}}">
						<template if="{{isPage(item.id)}}">
							<section style="margin-top:20px;position:relative;padding:0px;">
								<template is="dom-repeat" items="{{item.childShapes}}"></template>
								<render-form-element shape="[[item]]" />
							</section>
						</template>
					</template>
				</iron-pages>
			</div>
		</template>

		<template is="dom-template" id="element">
		</template>
		<template is="dom-if" if="{{item.defaultButtons}}">
			<simpl-row>
				<xaction-button on-tap="actionCallback" class="button" xid="{{item.xf_id}}" xaction="execute" raised>
					<core-icon icon="check"></core-icon>{{'form.execute'|tr}}</xaction-button>
				<xaction-button on-tap="actionCallback" class="button" xid="{{item.xf_id}}" xaction="cancel" raised>
					<core-icon icon="clear"></core-icon>{{'tasks.form.cancel'|tr}}</xaction-button>
			</simpl-row>
		</template>

		<!--div>
			<button on-tap="{{submit}}">Submit</button>
		</div-->
	</template>
	<script>
		Polymer( {
			is: 'simpl-form',
			behaviors: [
				FormBehavior
			],
			properties: {
				namespace: {
					type: String
				},
				formName: {
					type: String
				},
				mode: {
					type: String
				},
				data: {
					type: Object
				},
				spec: {
					type: Object
				},
				variables: {
					type: Object
				}
			},
			observers: [
				'dataChanged(data.*)',
				'specChanged(spec.*)',
				'formNameChanged(formName)'
			],
			listeners: {
				'value-changed': 'valueChanged',
				'add-form-field': 'addField',
				'remove-form-field': 'removeField'
			}
		} );

	</script>
</dom-module>
