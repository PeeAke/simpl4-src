<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->

<link rel="import" href="utils-import.html">
<polymer-element name="simpl-globals" attributes="globals" hidden>
	<template>
		<simpl-rpc id="sForm" service="git" method="searchContent" handleas="json"></simpl-rpc>
	</template>
	<script>
		(function() {
			/**
			 */
			var config = {
				//cache expiration time for lookup storage in seconds
				cacheExpiration: 7200
			};
			var x = location.toString().split("/");
			var namespace = x[x.length - 2];

			window.is_chromium = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;

			simpl4.util.BaseManager.setNamespace(namespace);
			var lang = Simpl4.Cache.getItem("lang");
			simpl4.util.BaseManager.setLanguage(lang ? lang : "de");
			simpl4.util.BaseManager.setUser("admin");
			simpl4.util.BaseManager.setPassword("admin");

			window.simpl4FormManager = simpl4.util.FormManager;
			window.simpl4MessageManager = simpl4.util.MessageManager;
			window.simpl4EntityManager = simpl4.util.EntityManager;


			simpl4MessageManager.installMessages();
			window.tr = simpl4MessageManager.tr;
			PolymerExpressions.prototype.tr = function(input) {
				return simpl4MessageManager.tr(input);
			};

			//var e = simpl4EntityManager.getEntities();
			//var e = simpl4EntityManager.getEntityViewFields("contact","search", true);

//			var ret = simpl4.util.SearchFilter.createSearchFilter("contact");
//			console.debug("Filter:"+JSON.stringify(ret,null,2));


			Polymer('simpl-globals', {
				ready: function() {
					this.globals={};
					this.globals.lang=simpl4MessageManager.getLanguage();
					this.config = config;
					console.debug("Globals.Ready:"+  tr('data.customer.cid'));
				},
				get actions() {//Only for info
					return this.getFromCache(this.$.axActions, 'baasicActions', 'accessAction');
				},
				getFromCache: function(ajax, cacheKey, collectionKey) {
					var _this = this;
					return new Promise(function(resolve, reject) {
						if (!Simpl4.Cache.getItem(cacheKey)) {
							ajax.request().then(function(response) {
								Simpl4.Cache.setItem(cacheKey, response.response, {
									expirationAbsolute: new Date(new Date().getTime() + (_this.config.cacheExpiration * 1000)),
									expirationSliding: null,
									priority: Cache.Priority.HIGH,
									callback: null
								});
								resolve({
									data: response.response
								});
							}, function(error) {
								console.error("Error1:", error.response);
								reject({
									error: error.response
								});
							}.bind(_this));
						} else {
							console.debug("FromCache");
							resolve({
								data: Simpl4.Cache.getItem(cacheKey)
							});
						}
					});
				}
			});
		})();
	</script>
</polymer-element>
