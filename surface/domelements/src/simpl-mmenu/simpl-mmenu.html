<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<link rel="import" href="import-js.html">
<dom-module id="simpl-mmenu" attributes="globals classes background name searchfield slidingSubmenus pages" flex relative>
	<link rel="import" type="css" href="simpl-mmenu.css" />
	<!--core-style ref="mmenu"></core-style-->
	<style>
		:host .mm-search input {
			border-radius: 6px;
		}
		:host .mm-search {
			padding-top: 15px;
			padding-left: 1px;
			padding-right: 1px;
		}

	</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer( {
			is: 'simpl-mmenu',
			properties: {
				name: String,
				globals: Object,
				classes: String,
				slidingSubmenus: String,
				background: String,
				searchfield: String,
				pages: {
					type: Array,
					notify: true
				}
			},
			observers: [
				'globalsChanged(globals.*)'
			],
			level: -1,
			classes: "mm-white mm-zoom-panels",
			backgroundColor: "invalid",
			attached: function() {
				console.log( "mmenu.attached" );
			},
			globalsChanged: function() {
				console.log( "mmenu.globalsChanged:", this.globals );
				this._getMenuYaml();
				this._createTree();
				this._createMenu()
				this._setStyleScope( this._mainmenu );
			},
			_createMenu: function() {
				console.log( "mmenu.createMenu.globals:", this.classes );
				var menu = $( this._mainmenu ).mmenu( {
					slidingSubmenus: this.slidingSubmenus == "true",
					searchfield: this.searchfield != "false",
					body: $( this._mainmenu ),
					classes: this.classes,
					offCanvas: false

				} );

				var b = this.background;
				console.log( "b:" + b );
				if ( b && b.length >= 0 ) {
					this.backgroundColor = b;
					$( this._mainmenu ).css( "backgroundColor", b );
					menu.addClass( "mm-background" );
					$( this ).addClass( "mm-background" );
				}
				setTimeout( ( function() {
					//Polymer.StyleTransformer.dom(this._mainmenu, "simpl-mmenu", true);
				} ).bind( this ), 5000 );
				this.async( function() {} );
			},
			_createTree: function() {
				var nav = document.createElement( 'nav' );
				this._mainmenu = nav;
				var ul = document.createElement( 'ul' );
				Polymer.dom( this.root ).appendChild( nav )
				Polymer.dom( nav ).appendChild( ul )
				Polymer.dom( nav ).setAttribute( "id", "mainmenu" );
				Polymer.dom( nav ).classList.add( 'nav' )

				this._createNodeList( ul, this.nodes, true );
			},
			_createNodeList: function( ul, nodes, firstLevel ) {
				for ( var i = 0; i < nodes.length; i++ ) {
					var node = nodes[ i ];
					if ( this._isNodeDisabled( node ) ) {
						continue;
					}
					if ( !this._hasNodeChildren( node ) ) {
						this._createLeaf( ul, node, firstLevel );
					} else {
						var ul2 = this._createNode( ul, node, firstLevel );
						this._createNodeList( ul2, node.children, false );
					}
				}
			},
			_createNode: function( parent, node, firstLevel ) {
				var fontAwesome = document.createElement( 'font-awesome' );
				var li = document.createElement( 'li' );
				var ul = document.createElement( 'ul' );
				var span = document.createElement( 'span' );
				var t = document.createTextNode( node.name );
				Polymer.dom( parent ).appendChild( li )
				Polymer.dom( li ).appendChild( span )
				Polymer.dom( li ).appendChild( ul )
				Polymer.dom( li ).setAttribute( "style", 'list-style:none' );
				Polymer.dom( li ).setAttribute( "id", "x" + node.hash );
				Polymer.dom( span ).appendChild( fontAwesome );
				Polymer.dom( fontAwesome ).setAttribute( "icon", node.icon );
				Polymer.dom( span ).appendChild( t );
				if ( firstLevel ) {
					Polymer.dom( li ).classList.add( 'firstLevel' )
				}
				return ul;
			},
			_createLeaf: function( parent, node, firstLevel ) {
				var fontAwesome = document.createElement( 'font-awesome' );
				var li = document.createElement( 'li' );
				var a = document.createElement( 'a' );
				var t = document.createTextNode( node.name );
				Polymer.dom( parent ).appendChild( li )
				Polymer.dom( li ).appendChild( a )
				Polymer.dom( a ).appendChild( fontAwesome );
				Polymer.dom( a ).setAttribute( "style", 'cursor:pointer' );
				Polymer.dom( fontAwesome ).setAttribute( "icon", node.icon );
				Polymer.dom( a ).appendChild( t );
				Polymer.dom( li ).setAttribute( "style", 'list-style:none' );
				Polymer.dom( li ).setAttribute( "id", "x" + node.hash );
				if ( firstLevel ) {
					Polymer.dom( li ).classList.add( 'firstLevel' )
				}
				a.node = node;
			},
			_isNodeDisabled: function( node ) {
				return node.disabled === true;
			},
			_hasNodeChildren: function( node ) {
				return node.children && node.children.length > 0;
			},
			_setStyleScope: function( main_el ) {
				this._domVisitor( main_el, function( el ) {
					if ( !$( el ).hasClass( "style-scope" ) && el.nodeType == 1 ) {
						el.classList.add( 'style-scope' )
						el.classList.add( 'simpl-mmenu' )
					}
				} );
			},
			_domVisitor: function( el, f ) {
				if ( el ) {
					f( el );
					for ( var i = 0; i < el.childNodes.length; i++ ) {
						this._domVisitor( el.childNodes[ i ], f );
					}
				}
			},
			_getMenuYaml: function() {
				console.log( "Menu._getMenuYaml:", this.globals );
				this.nodes = jQuery.ajax( {
					url: this.name + ".yaml",
					async: false,
					dataType: "json"
				} ).responseText;
				try {
					this.nodes = JSON.parse( this.nodes );
				} catch ( e ) {
					alert( "Error.Read Menu:" + e );
					console.error( "Error.Read Menu:", e );
					return;
				}
				this.pages = [];
				this._traverse( this.nodes );
				//console.log("Pages:"+JSON.stringify(this.nodes,null,2));
			},
			_traverse: function( nodes ) {
				for ( var i = 0; i < nodes.length; i++ ) {
					var node = nodes[ i ];
					if ( node.name ) {
						node.name = tr( node.name );
					}

					if ( node.hash == null ) {
						if ( node.name ) {
							var lc = node.name.toLowerCase();
							node.hash = lc.replace( /[^a-z0-9_.]/g, "" );
						} else {
							alert( "Warning.menu:name and hash are empty" );
						}
					}
					if ( node.url && node.url.indexOf( "%l" ) != -1 ) {
						node.url = node.url.replace( "%l", this.globals.lang );
					}
					if ( node.disabled !== true ) {
						if ( node.children && node.children.length > 0 ) {
							this.pages.push( node );
							this._traverse( node.children );
						} else {
							this.pages.push( node );
						}
					}
				}
			}
		} );

	</script>
</dom-module>
