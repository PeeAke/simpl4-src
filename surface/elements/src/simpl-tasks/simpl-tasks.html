<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-tasks" extends="simpl-datatables" attributes="">
	<template>
		<style>
			#list li {
				height: 30px;
				cursor: pointer;
			}
			#list li.core-selected:after {
				content: "\2713";
				padding-left: 10px;
			}
			paper-button.blue-ripple {
				color: #4285f4;
				float: left;
				position: relative;
			}
			core-label {
				font-family: 'Helvetica Neue', Helvetica, Arial;
				font-size: 20px;
				margin: 5px;
			}
		</style>

		<core-animated-pages selected="{{pageSelected}}" xransitions="hero-transition cross-fade">
			<section style="padding:3px;position:relative;">
				<core-selector target="{{$.list}}" selected="{{taskListSelected}}">
					<ul id="list">
						<li>{{"tasks.table.not_assigned"|tr}}</li>
						<li>{{"tasks.table.assigned"|tr}}</li>
					</ul>
				</core-selector>
				<template if="{{currentTask!=null}}">
					<div style="margin-bottom:30px;text-align:left;" layout vertical>
						<paper-button raised class="blue-ripple" on-tap="{{submit}}">{{action+' ('+currentTask+')'}}</paper-button>
					</div>
				</template>
				<shadow></shadow>
			</section>
			<section style="position:relative;" unresolved>
				<simpl-processcontroller id="processController"></simpl-processcontroller>
			</section>
		</core-animated-pages>
	</template>

	<script>
		Polymer( 'simpl-tasks', {
			dtMeta: null,
			pageSelected: 0,
			taskListSelected: 1,
			action: tr( "tasks.table.complete" ),
			currentTask: null,
			currentIndex: null,
			domReady: function() {
				console.log( "ready" );
				if ( this.dtMeta == null ) {
					this.dtMeta = this.getMeta();
				}
				var dataSet = this.getTasks();
				console.log( "dataSet:" + JSON.stringify( dataSet, null, 2 ) );
				console.log( "meta:" + JSON.stringify( this.dtMeta, null, 2 ) );
				this.createTable( this.dtMeta, dataSet );
				this.createRowListener();
			},
			createRowListener: function() {
				var self = this;
				this.q( 'tbody tr' ).on( 'tap', ( function( e ) {
					console.log( "Click:", e.currentTarget._DT_RowIndex );
					var index = e.currentTarget._DT_RowIndex;
					self.currentIndex = index;
					if ( $( this ).hasClass( 'selected' ) ) {
						//	$( this ).removeClass( 'selected' );
					} else {
						self.q( 'tr.selected' ).removeClass( 'selected' );
						$( this ).addClass( 'selected' );
						self.currentTask = self.dataSet[ index ].processName + " / " + self.dataSet[ index ].name;
					}
				} ) );
			},
			q: function( sel ) {
				return $( this.$.datatables_main.querySelectorAll( sel ) );
			},
			getMeta: function() {
				var colHds = [];
				var col = {};
				col.data = "name";
				col.title = tr( "tasks.table.name" );
				colHds.push( col );

				var col = {};
				col.data = "processName";
				col.title = tr( "tasks.table.processName" );
				colHds.push( col );

				var col = {};
				col.data = "processCategory";
				col.title = tr( "tasks.table.processCategory" );
				colHds.push( col );

				var col = {};
				col.data = "id";
				col.title = tr( "tasks.table.taskid" );
				colHds.push( col );

				var col = {};
				col.data = "processInstanceId";
				col.title = tr( "tasks.table.processInstanceId" );
				colHds.push( col );


				var col = {};
				col.data = "description";
				col.title = tr( "tasks.table.description" );
				colHds.push( col );

				var col = {};
				col.data = "createTime";
				col.title = tr( "tasks.table.time" );
				colHds.push( col );
				return colHds;
			},
			taskListSelectedChanged: function( e ) {
				console.log( "listChanged:", e );
				console.log( "equela:" + ( e == 0 ) );
				this.action = e == 0 ? tr( "tasks.task.complete" ) : tr( "tasks.task.claim" );
				var dataSet = this.getTasks( e == 0 ? "assigned" : "notassigned" );
				this.createTable( this.dtMeta, dataSet );
				this.createRowListener();
				this.currentTask = null;
				this.currentIndex = null;
			},
			submit: function( e ) {
				this.pageSelected = 1;
				console.log( "submit:", e );
				console.log( "currentIndex:" + JSON.stringify( this.dataSet[ this.currentIndex ], null, 2 ) );
				var task =  this.dataSet[ this.currentIndex ];
				task.fromTaskList=true;
				var self = this;
				this.$.processController.showForm( task, function(){
					self.pageSelected = 0;
				} );
			},
			getTasks: function( what ) {
				this.userid = simpl4.util.BaseManager.getUser();
				var self = this;
				var completed = function( map ) {
					var rows = [];
					var data = map[ "data" ];
					for ( var row = 0; row < data.length; row++ ) {
						var rmap = data[ row ];
						if ( rmap.assignee == null ) {
							rmap[ "assigned" ] = tr( "tasks.table.not_assigned" );
							rmap[ "action" ] = tr( "tasks.table.claim" );
						} else {
							rmap[ "assigned" ] = rmap.assignee;
							rmap[ "action" ] = tr( "tasks.table.complete" );
						}
						rows.push( rmap );
					}
					self.dataSet = rows;
					return rows;
				};
				try {
					var queryParams = {
						assignee: this.userid
					};
					if ( what == "notassigned" ) {
						queryParams = {
							candidate: this.userid
						};
					}

					var result = simpl4.util.Rpc.rpcSync( "activiti:getTasks", {
						queryParams: queryParams,
						listParams: {
							size: 1000
						}
					} );
					return completed.call( this, result );
				} catch ( e ) {
					alert( "Tasks.getTasks:" + e );
					return;
				}
			}
		} );
	</script>

</polymer-element>
